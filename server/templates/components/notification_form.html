<div class="card">
    <h2>{% match notification %}{% when Some with (_) %}Edit{% when None %}Add{% endmatch %} Notification Backend</h2>
    
    {% match error %}
    {% when Some with (e) %}
    <div class="alert alert-error">{{ e }}</div>
    {% when None %}
    {% endmatch %}
    
    {% match notification %}
    {% when Some with (n) %}
    <form hx-put="/settings/notifications/{{ n.id }}"
          hx-target="#notification-list"
          hx-swap="innerHTML">
        
        <div class="form-group">
            <label for="name">Backend Name *</label>
            <input type="text" 
                   id="name" 
                   name="name" 
                   value="{{ n.name }}" 
                   required>
        </div>
        
        <div class="form-group">
            <label for="channel_type">Type *</label>
            <select id="channel_type" name="channel_type" disabled>
                <option value="gotify" {% if n.channel_type == "gotify" %}selected{% endif %}>Gotify</option>
                <option value="ntfy" {% if n.channel_type == "ntfy" %}selected{% endif %}>ntfy.sh</option>
            </select>
            <input type="hidden" name="channel_type" value="{{ n.channel_type }}">
        </div>

        {% if n.channel_type == "gotify" %}
            <div class="form-group">
                <label for="url">Gotify Server URL *</label>
                <input type="url" 
                       id="url" 
                       name="url" 
                       value="{{ config_url }}"
                       placeholder="https://gotify.example.com"
                       required>
            </div>
            
            <div class="form-group">
                <label for="token">Application Token *</label>
                <input type="text" 
                       id="token" 
                       name="token" 
                       value="{{ config_token }}"
                       placeholder="Your Gotify app token"
                       required>
            </div>
        {% else %}
            <div class="form-group">
                <label for="url">ntfy.sh Server URL *</label>
                <input type="url" 
                       id="url" 
                       name="url" 
                       value="{{ config_url }}"
                       placeholder="https://ntfy.sh"
                       required>
            </div>
            
            <div class="form-group">
                <label for="topic">Topic *</label>
                <input type="text" 
                       id="topic" 
                       name="topic" 
                       value="{{ config_topic }}"
                       placeholder="my-topic"
                       required>
            </div>
            
            <div class="form-group">
                <label>Authentication (optional)</label>
                <small class="text-secondary">Choose one method if your topic is protected</small>
            </div>
            
            <div class="form-group">
                <label for="token">Access Token</label>
                <input type="text" 
                       id="token" 
                       name="token" 
                       value="{{ config_token }}"
                       placeholder="Bearer token for protected topics">
                <small class="text-secondary">OR use username/password below</small>
            </div>
            
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" 
                       id="username" 
                       name="username" 
                       value="{{ config_username }}"
                       placeholder="For Basic Auth">
            </div>
            
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" 
                       id="password" 
                       name="password" 
                       value="{{ config_password }}"
                       placeholder="For Basic Auth">
            </div>
        {% endif %}

        <!-- Priority field commented out - not in NotificationChannelDisplay
        <div class="form-group">
            <label for="default_priority">Priority (1-10)</label>
            <input type="number"
                   id="default_priority"
                   name="default_priority"
                   value="5"
                   min="1"
                   max="10">
        </div>
        -->

        <div class="form-group">
            <label>
                <input type="checkbox" name="enabled" {% if n.enabled %}checked{% endif %}>
                Enabled
            </label>
        </div>
        
        <div class="flex gap-2">
            <button type="submit" class="btn btn-primary">Save</button>
            <button type="button" 
                    onclick="document.getElementById('notification-form-container').innerHTML = ''"
                    class="btn btn-secondary">
                Cancel
            </button>
        </div>
    </form>
    {% when None %}
    <form hx-post="/settings/notifications"
          hx-target="#notification-list"
          hx-swap="innerHTML"
          hx-indicator="#submit-spinner"
          hx-on::after-request="if(event.detail.successful) { this.reset(); document.getElementById('notification-form-container').innerHTML = ''; }">
        
        <div class="form-group">
            <label for="name">Backend Name *</label>
            <input type="text" 
                   id="name" 
                   name="name" 
                   placeholder="My Notification Backend"
                   required>
        </div>
        
        <div class="form-group">
            <label for="backend_type">Type *</label>
            <select id="backend_type" name="backend_type" required onchange="toggleBackendFields(this.value)">
                <option value="">Select type...</option>
                <option value="gotify">Gotify</option>
                <option value="ntfy">ntfy.sh</option>
            </select>
        </div>
        
        <div id="gotify-fields" style="display: none;">
            <div class="form-group">
                <label for="gotify_url">Gotify Server URL *</label>
                <input type="url" 
                       id="gotify_url" 
                       name="url" 
                       placeholder="https://gotify.example.com"
                       disabled>
            </div>
            
            <div class="form-group">
                <label for="gotify_token">Application Token *</label>
                <input type="text" 
                       id="gotify_token" 
                       name="token" 
                       placeholder="Your Gotify app token"
                       disabled>
            </div>
        </div>
        
        <div id="ntfy-fields" style="display: none;">
            <div class="form-group">
                <label for="ntfy_url">ntfy.sh Server URL *</label>
                <input type="url" 
                       id="ntfy_url" 
                       name="url" 
                       placeholder="https://ntfy.sh"
                       disabled>
            </div>
            
            <div class="form-group">
                <label for="ntfy_topic">Topic *</label>
                <input type="text" 
                       id="ntfy_topic" 
                       name="topic" 
                       placeholder="my-topic"
                       disabled>
            </div>
            
            <div class="form-group">
                <label>Authentication (optional)</label>
                <small class="text-secondary">Choose one method if your topic is protected</small>
            </div>
            
            <div class="form-group">
                <label for="ntfy_token">Access Token</label>
                <input type="text" 
                       id="ntfy_token" 
                       name="token" 
                       placeholder="Bearer token for protected topics"
                       disabled>
                <small class="text-secondary">OR use username/password below</small>
            </div>
            
            <div class="form-group">
                <label for="ntfy_username">Username</label>
                <input type="text" 
                       id="ntfy_username" 
                       name="username" 
                       placeholder="For Basic Auth"
                       disabled>
            </div>
            
            <div class="form-group">
                <label for="ntfy_password">Password</label>
                <input type="password" 
                       id="ntfy_password" 
                       name="password" 
                       placeholder="For Basic Auth"
                       disabled>
            </div>
        </div>

        <div class="form-group">
            <label for="default_priority">Priority (1-10)</label>
            <input type="number"
                   id="default_priority"
                   name="default_priority"
                   value="5"
                   min="1"
                   max="10">
        </div>

        <div class="form-group">
            <label>
                <input type="checkbox" name="enabled" checked>
                Enabled
            </label>
        </div>
        
        <div class="flex gap-2">
            <button type="submit" class="btn btn-primary">
                Add Backend
                <span id="submit-spinner" class="htmx-indicator">...</span>
            </button>
            <button type="button" 
                    onclick="document.getElementById('notification-form-container').innerHTML = ''"
                    class="btn btn-secondary">
                Cancel
            </button>
        </div>
    </form>
    
    <script>
    function toggleBackendFields(type) {
        const gotifyFields = document.getElementById('gotify-fields');
        const ntfyFields = document.getElementById('ntfy-fields');
        
        // Show/hide fields
        gotifyFields.style.display = type === 'gotify' ? 'block' : 'none';
        ntfyFields.style.display = type === 'ntfy' ? 'block' : 'none';
        
        // Get all input fields
        const gotifyUrl = document.getElementById('gotify_url');
        const gotifyToken = document.getElementById('gotify_token');
        const ntfyUrl = document.getElementById('ntfy_url');
        const ntfyTopic = document.getElementById('ntfy_topic');
        const ntfyToken = document.getElementById('ntfy_token');
        const ntfyUsername = document.getElementById('ntfy_username');
        const ntfyPassword = document.getElementById('ntfy_password');
        
        if (type === 'gotify') {
            // Enable Gotify fields
            gotifyUrl.disabled = false;
            gotifyUrl.required = true;
            gotifyToken.disabled = false;
            gotifyToken.required = true;
            // Disable ntfy fields so they don't get submitted
            ntfyUrl.disabled = true;
            ntfyUrl.required = false;
            ntfyTopic.disabled = true;
            ntfyTopic.required = false;
            ntfyToken.disabled = true;
            ntfyUsername.disabled = true;
            ntfyPassword.disabled = true;
        } else if (type === 'ntfy') {
            // Enable ntfy fields
            ntfyUrl.disabled = false;
            ntfyUrl.required = true;
            ntfyTopic.disabled = false;
            ntfyTopic.required = true;
            ntfyToken.disabled = false;
            ntfyUsername.disabled = false;
            ntfyPassword.disabled = false;
            // Disable Gotify fields so they don't get submitted
            gotifyUrl.disabled = true;
            gotifyUrl.required = false;
            gotifyToken.disabled = true;
            gotifyToken.required = false;
        } else {
            // No type selected - disable all
            gotifyUrl.disabled = true;
            gotifyUrl.required = false;
            gotifyToken.disabled = true;
            gotifyToken.required = false;
            ntfyUrl.disabled = true;
            ntfyUrl.required = false;
            ntfyTopic.disabled = true;
            ntfyTopic.required = false;
            ntfyToken.disabled = true;
            ntfyUsername.disabled = true;
            ntfyPassword.disabled = true;
        }
    }
    </script>
    {% endmatch %}
</div>

