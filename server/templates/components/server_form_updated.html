<div class="card">
    <h2>{% match server %}{% when Some with (_) %}Edit{% when None %}Add{% endmatch %} Server</h2>

    {% match error %}
    {% when Some with (e) %}
    <div class="alert alert-error">{{ e }}</div>
    {% when None %}
    {% endmatch %}

    {% match server %}
    {% when Some with (s) %}
    <form hx-put="/servers/{{ s.id }}"
          hx-target="#server-list"
          hx-swap="innerHTML">

        <div class="form-group">
            <label for="name">Server Name *</label>
            <input type="text"
                   id="name"
                   name="name"
                   value="{{ s.name }}"
                   required>
        </div>

        <div class="form-group">
            <label for="host">Host *</label>
            <input type="text"
                   id="host"
                   name="host"
                   value="{{ s.host }}"
                   placeholder="192.168.1.100 or example.com"
                   required>
        </div>

        <div class="grid grid-2">
            <div class="form-group">
                <label for="port">SSH Port</label>
                <input type="number"
                       id="port"
                       name="port"
                       value="{% match s.port %}{% when Some with (p) %}{{ p }}{% when None %}22{% endmatch %}"
                       placeholder="22"
                       min="1"
                       max="65535">
            </div>

            <div class="form-group">
                <label for="credential_id">SSH Credential</label>
                <select id="credential_id" name="credential_id">
                    <option value="">Manual (username below)</option>
                    {% for cred in credentials %}
                    <option value="{{ cred.id }}" {% match s.credential_id %}{% when Some with (cid) %}{% if cred.id == cid %}selected{% endif %}{% when None %}{% endmatch %}>
                        {{ cred.name }} ({{ cred.username }})
                    </option>
                    {% endfor %}
                </select>
                <small class="text-secondary">Or <a href="/credentials" class="text-primary">create a new credential</a></small>
            </div>
        </div>

        <div class="form-group">
            <label for="username">Manual Username (if no credential selected)</label>
            <input type="text"
                   id="username"
                   name="username"
                   value="{% match s.username %}{% when Some with (u) %}{{ u }}{% when None %}{% endmatch %}"
                   placeholder="ubuntu">
            <small class="text-secondary">Only used if no credential is selected above</small>
        </div>

        <div class="form-group">
            <label for="tags">Tags</label>
            <div style="max-height: 150px; overflow-y: auto; border: 1px solid var(--border); border-radius: 4px; padding: 0.5rem;">
                {% for tag in available_tags %}
                <label class="flex gap-2 align-center mb-1" style="cursor: pointer;">
                    <input type="checkbox"
                           name="tag_ids"
                           value="{{ tag.id }}"
                           {% for st in s.tags %}{% if st.id == tag.id %}checked{% endif %}{% endfor %}>
                    <span class="badge" style="background-color: {{ tag.color }}; color: #fff;">
                        {{ tag.name }}
                    </span>
                </label>
                {% endfor %}
            </div>
            <small class="text-secondary">Or <a href="/tags" class="text-primary">create a new tag</a></small>
        </div>

        <div class="form-group">
            <label for="description">Description (optional)</label>
            <textarea id="description"
                      name="description"
                      rows="3"
                      placeholder="Brief description of this server">{% match s.description %}{% when Some with (d) %}{{ d }}{% when None %}{% endmatch %}</textarea>
        </div>

        <div class="form-group">
            <label class="flex gap-2 align-center" style="cursor: pointer;">
                <input type="checkbox"
                       id="enabled"
                       name="enabled"
                       {% if s.enabled %}checked{% endif %}>
                <span>Server Enabled</span>
            </label>
        </div>

        <!-- Test connection result -->
        <div id="test-connection-result"></div>

        <div class="flex gap-2">
            <button type="submit" class="btn btn-primary">Save</button>
            <button type="button"
                    class="btn btn-secondary"
                    hx-post="/servers/test"
                    hx-include="[name='host'], [name='port'], [name='username'], [name='credential_id']"
                    hx-target="#test-connection-result"
                    hx-swap="innerHTML">
                Test Connection
            </button>
            <button type="button"
                    onclick="document.getElementById('server-form-container').innerHTML = ''"
                    class="btn btn-secondary">
                Cancel
            </button>
        </div>
    </form>
    {% when None %}
    <form hx-post="/servers"
          hx-target="#server-list"
          hx-swap="innerHTML">

        <div class="form-group">
            <label for="name">Server Name *</label>
            <input type="text"
                   id="name"
                   name="name"
                   required>
        </div>

        <div class="form-group">
            <label for="host">Host *</label>
            <input type="text"
                   id="host"
                   name="host"
                   placeholder="192.168.1.100 or example.com"
                   required>
        </div>

        <div class="grid grid-2">
            <div class="form-group">
                <label for="port">SSH Port</label>
                <input type="number"
                       id="port"
                       name="port"
                       value="22"
                       placeholder="22"
                       min="1"
                       max="65535">
            </div>

            <div class="form-group">
                <label for="credential_id">SSH Credential</label>
                <select id="credential_id" name="credential_id">
                    <option value="">Manual (username below)</option>
                    {% for cred in credentials %}
                    <option value="{{ cred.id }}">
                        {{ cred.name }} ({{ cred.username }})
                    </option>
                    {% endfor %}
                </select>
                <small class="text-secondary">Or <a href="/credentials" class="text-primary">create a new credential</a></small>
            </div>
        </div>

        <div class="form-group">
            <label for="username">Manual Username (if no credential selected)</label>
            <input type="text"
                   id="username"
                   name="username"
                   placeholder="ubuntu">
            <small class="text-secondary">Only used if no credential is selected above</small>
        </div>

        <div class="form-group">
            <label for="tags">Tags</label>
            <div style="max-height: 150px; overflow-y: auto; border: 1px solid var(--border); border-radius: 4px; padding: 0.5rem;">
                {% for tag in available_tags %}
                <label class="flex gap-2 align-center mb-1" style="cursor: pointer;">
                    <input type="checkbox"
                           name="tag_ids"
                           value="{{ tag.id }}">
                    <span class="badge" style="background-color: {{ tag.color }}; color: #fff;">
                        {{ tag.name }}
                    </span>
                </label>
                {% endfor %}
            </div>
            <small class="text-secondary">Or <a href="/tags" class="text-primary">create a new tag</a></small>
        </div>

        <div class="form-group">
            <label for="description">Description (optional)</label>
            <textarea id="description"
                      name="description"
                      rows="3"
                      placeholder="Brief description of this server"></textarea>
        </div>

        <div class="form-group">
            <label class="flex gap-2 align-center" style="cursor: pointer;">
                <input type="checkbox"
                       id="enabled"
                       name="enabled"
                       checked>
                <span>Server Enabled</span>
            </label>
        </div>

        <!-- Test connection result -->
        <div id="test-connection-result"></div>

        <div class="flex gap-2">
            <button type="submit" class="btn btn-primary">Save</button>
            <button type="button"
                    class="btn btn-secondary"
                    hx-post="/servers/test"
                    hx-include="[name='host'], [name='port'], [name='username'], [name='credential_id']"
                    hx-target="#test-connection-result"
                    hx-swap="innerHTML">
                Test Connection
            </button>
            <button type="button"
                    onclick="document.getElementById('server-form-container').innerHTML = ''"
                    class="btn btn-secondary">
                Cancel
            </button>
        </div>
    </form>
    {% endmatch %}
</div>
