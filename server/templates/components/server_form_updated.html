<div class="card">
    <h2>{% match server %}{% when Some with (_) %}Edit{% when None %}Add{% endmatch %} Server</h2>

    {% match error %}
    {% when Some with (e) %}
    <div class="alert alert-error">{{ e }}</div>
    {% when None %}
    {% endmatch %}

    {% match server %}
    {% when Some with (s) %}
    <form hx-put="/servers/{{ s.id }}"
          hx-target="#server-list"
          hx-swap="innerHTML">

        <div class="form-group">
            <label for="name">Server Name *</label>
            <input type="text"
                   id="name"
                   name="name"
                   value="{{ s.name }}"
                   required>
        </div>

        <div class="form-group">
            <label for="hostname">Host *</label>
            <input type="text"
                   id="hostname"
                   name="hostname"
                   value="{{ s.host }}"
                   placeholder="192.168.1.100 or example.com"
                   required>
        </div>

        <div class="grid grid-2">
            <div class="form-group">
                <label for="port">SSH Port</label>
                <input type="number"
                       id="port"
                       name="port"
                       value="{{ s.port }}"
                       placeholder="22"
                       min="1"
                       max="65535">
            </div>

            <div class="form-group">
                <label for="credential_id">SSH Credential</label>
                <select id="credential_id" name="credential_id" data-selected-id="{% match s.credential_id %}{% when Some with (id) %}{{ id }}{% when None %}{% endmatch %}">
                    <option value="">Manual (username below)</option>
                    {% for cred in credentials %}
                    <option value="{{ cred.id }}">
                        {{ cred.name }} ({{ cred.username }})
                    </option>
                    {% endfor %}
                </select>
                <script>
                (function() {
                    const select = document.getElementById('credential_id');
                    const selectedId = select.getAttribute('data-selected-id');
                    if (selectedId) {
                        select.value = selectedId;
                    }
                })();
                </script>
                <small class="text-secondary">Or <a href="/credentials" class="text-primary">create a new credential</a></small>
            </div>
        </div>

        <div class="form-group">
            <label for="username">Manual Username (if no credential selected)</label>
            <input type="text"
                   id="username"
                   name="username"
                   value="{{ s.username }}"
                   placeholder="ubuntu">
            <small class="text-secondary">Only used if no credential is selected above</small>
        </div>

        <div class="form-group">
            <label for="tags">Tags</label>
            <div style="max-height: 150px; overflow-y: auto; border: 1px solid var(--border); border-radius: 4px; padding: 0.5rem;">
                {% if tags.is_empty() %}
                <p class="text-secondary">No tags available. <a href="/tags" class="text-primary">Create a tag first</a></p>
                {% else %}
                {% for tag in tags %}
                <label class="flex gap-2 align-center mb-1" style="cursor: pointer;">
                    <input type="checkbox"
                           name="tag_ids"
                           value="{{ tag.id }}"
                           data-tag-id="{{ tag.id }}"
                           {% if !selected_tags.is_empty() %}
                           class="tag-checkbox"
                           {% endif %}>
                    <span class="badge" style="background-color: {{ tag.color }}; color: #fff;">
                        {{ tag.name }}
                    </span>
                </label>
                {% endfor %}
                {% endif %}
            </div>
            <small class="text-secondary">Or <a href="/tags" class="text-primary">create a new tag</a></small>
        </div>

        {% if !selected_tags.is_empty() %}
        <script>
        // Pre-select tags for edit form
        (function() {
            const selectedIds = [{% for id in selected_tags %}{{ id }},{% endfor %}];
            document.querySelectorAll('.tag-checkbox').forEach(cb => {
                const tagId = parseInt(cb.getAttribute('data-tag-id'));
                if (selectedIds.includes(tagId)) {
                    cb.checked = true;
                }
            });
        })();
        </script>
        {% endif %}

        <div class="form-group">
            <label for="description">Description (optional)</label>
            <textarea id="description"
                      name="description"
                      rows="3"
                      placeholder="Brief description of this server">{{ s.description }}</textarea>
        </div>

        <div class="form-group">
            <label class="flex gap-2 align-center" style="cursor: pointer;">
                <input type="checkbox"
                       id="enabled"
                       name="enabled"
                       value="on"
                       {% if s.enabled %}checked{% endif %}>
                <span>Server Enabled</span>
            </label>
        </div>

        <!-- Test connection result -->
        <div id="test-connection-result"></div>

        <div class="flex gap-2">
            <button type="submit" class="btn btn-primary">Save</button>
            <button type="button"
                    class="btn btn-secondary"
                    hx-post="/servers/test"
                    hx-include="[name='hostname'], [name='port'], [name='username'], [name='credential_id']"
                    hx-target="#test-connection-result"
                    hx-swap="innerHTML">
                Test Connection
            </button>
            <button type="button"
                    onclick="document.getElementById('server-form-container').innerHTML = ''"
                    class="btn btn-secondary">
                Cancel
            </button>
        </div>
    </form>
    {% when None %}
    <form hx-post="/servers"
          hx-target="#server-list"
          hx-swap="innerHTML">

        <div class="form-group">
            <label for="name">Server Name *</label>
            <input type="text"
                   id="name"
                   name="name"
                   required>
        </div>

        <div class="form-group">
            <label for="hostname">Host *</label>
            <input type="text"
                   id="hostname"
                   name="hostname"
                   placeholder="192.168.1.100 or example.com"
                   required>
        </div>

        <div class="grid grid-2">
            <div class="form-group">
                <label for="port">SSH Port</label>
                <input type="number"
                       id="port"
                       name="port"
                       value="22"
                       placeholder="22"
                       min="1"
                       max="65535">
            </div>

            <div class="form-group">
                <label for="credential_id">SSH Credential</label>
                <select id="credential_id" name="credential_id">
                    <option value="">Manual (username below)</option>
                    {% for cred in credentials %}
                    <option value="{{ cred.id }}">
                        {{ cred.name }} ({{ cred.username }})
                    </option>
                    {% endfor %}
                </select>
                <small class="text-secondary">Or <a href="/credentials" class="text-primary">create a new credential</a></small>
            </div>
        </div>

        <div class="form-group">
            <label for="username">Manual Username (if no credential selected)</label>
            <input type="text"
                   id="username"
                   name="username"
                   placeholder="ubuntu">
            <small class="text-secondary">Only used if no credential is selected above</small>
        </div>

        <div class="form-group">
            <label for="tags">Tags</label>
            <div style="max-height: 150px; overflow-y: auto; border: 1px solid var(--border); border-radius: 4px; padding: 0.5rem;">
                {% if tags.is_empty() %}
                <p class="text-secondary">No tags available. <a href="/tags" class="text-primary">Create a tag first</a></p>
                {% else %}
                {% for tag in tags %}
                <label class="flex gap-2 align-center mb-1" style="cursor: pointer;">
                    <input type="checkbox"
                           name="tag_ids"
                           value="{{ tag.id }}">
                    <span class="badge" style="background-color: {{ tag.color }}; color: #fff;">
                        {{ tag.name }}
                    </span>
                </label>
                {% endfor %}
                {% endif %}
            </div>
            <small class="text-secondary">Or <a href="/tags" class="text-primary">create a new tag</a></small>
        </div>

        <div class="form-group">
            <label for="description">Description (optional)</label>
            <textarea id="description"
                      name="description"
                      rows="3"
                      placeholder="Brief description of this server"></textarea>
        </div>

        <div class="form-group">
            <label class="flex gap-2 align-center" style="cursor: pointer;">
                <input type="checkbox"
                       id="enabled"
                       name="enabled"
                       value="on"
                       checked>
                <span>Server Enabled</span>
            </label>
        </div>

        <!-- Test connection result -->
        <div id="test-connection-result"></div>

        <div class="flex gap-2">
            <button type="submit" class="btn btn-primary">Save</button>
            <button type="button"
                    class="btn btn-secondary"
                    hx-post="/servers/test"
                    hx-include="[name='hostname'], [name='port'], [name='username'], [name='credential_id']"
                    hx-target="#test-connection-result"
                    hx-swap="innerHTML">
                Test Connection
            </button>
            <button type="button"
                    onclick="document.getElementById('server-form-container').innerHTML = ''"
                    class="btn btn-secondary">
                Cancel
            </button>
        </div>
    </form>
    {% endmatch %}
</div>
