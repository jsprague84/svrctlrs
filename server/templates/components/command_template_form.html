<div class="card" x-data="commandTemplateForm()">
    <div class="flex-between mb-3">
        <h3>{% match command_template %}{% when Some with (_) %}Edit{% when None %}Add{% endmatch %} Command Template</h3>
        <a href="https://github.com/jsprague84/svrctlrs/blob/develop/docs/COMMAND_TEMPLATES.md"
           target="_blank"
           class="btn btn-sm btn-secondary"
           title="View Command Template Documentation">
            <i data-lucide="help-circle" style="width: 14px; height: 14px;"></i> Help & Examples
        </a>
    </div>

    {% match error %}
    {% when Some with (e) %}
    <div class="alert alert-error">{{ e }}</div>
    {% when None %}
    {% endmatch %}

    {% match command_template %}
    {% when Some with (ct) %}
    <form hx-put="/job-types/{{ job_type_id }}/command-templates/{{ ct.id }}"
          hx-target="#command-template-list"
          hx-swap="innerHTML"
          @submit="serializeAllFields()">

        <!-- Internal Name (read-only for editing) -->
        <div class="form-group">
            <label for="name">Internal Name</label>
            <input type="text"
                   id="name"
                   value="{{ ct.name }}"
                   readonly
                   disabled
                   class="bg-base-300">
            <small class="text-secondary">Internal identifier (cannot be changed)</small>
        </div>

        <!-- Display Name -->
        <div class="form-group">
            <label for="display_name">Display Name *</label>
            <input type="text"
                   id="display_name"
                   name="display_name"
                   value="{{ ct.display_name }}"
                   placeholder="Update Packages"
                   required>
        </div>

        <!-- Description -->
        <div class="form-group">
            <label for="description">Description</label>
            <textarea id="description"
                      name="description"
                      rows="2"
                      placeholder="What this command does">{% match ct.description %}{% when Some with (d) %}{{ d }}{% when None %}{% endmatch %}</textarea>
        </div>

        <!-- Command with Variables -->
        <div class="form-group">
            <label for="command">Command Template *</label>
            <textarea id="command"
                      name="command"
                      rows="4"
                      class="font-mono"
                      placeholder="docker ps --filter 'status=&#123;&#123;status&#125;&#125;'"
                      required>{{ ct.command }}</textarea>
            <small class="text-secondary">Use &#123;&#123;variable&#125;&#125; syntax for substitution</small>

            <!-- Example Templates Dropdown -->
            <details style="margin-top: 0.5rem;">
                <summary style="cursor: pointer; color: var(--primary); font-size: 0.875rem;">
                    <i data-lucide="lightbulb" style="width: 14px; height: 14px;"></i> View Example Command Templates
                </summary>
                <div style="margin-top: 0.5rem; padding: 0.5rem; background: var(--bg); border-radius: 4px;">
                    <p style="font-size: 0.875rem; margin-bottom: 0.5rem;"><strong>Docker:</strong></p>
                    <code style="display: block; padding: 0.5rem; background: var(--bg-tertiary); border-radius: 4px; font-size: 0.75rem; margin-bottom: 0.5rem;">
                        docker ps --filter "name=&#123;&#123;container_name&#125;&#125;" --format json
                    </code>

                    <p style="font-size: 0.875rem; margin: 0.5rem 0;"><strong>System Updates (apt):</strong></p>
                    <code style="display: block; padding: 0.5rem; background: var(--bg-tertiary); border-radius: 4px; font-size: 0.75rem; margin-bottom: 0.5rem;">
                        sudo apt-get update && sudo apt-get upgrade -y
                    </code>

                    <p style="font-size: 0.875rem; margin: 0.5rem 0;"><strong>Service Management:</strong></p>
                    <code style="display: block; padding: 0.5rem; background: var(--bg-tertiary); border-radius: 4px; font-size: 0.75rem; margin-bottom: 0.5rem;">
                        systemctl &#123;&#123;action&#125;&#125; &#123;&#123;service_name&#125;&#125;
                    </code>

                    <p style="font-size: 0.875rem; margin: 0.5rem 0;"><strong>File Operations:</strong></p>
                    <code style="display: block; padding: 0.5rem; background: var(--bg-tertiary); border-radius: 4px; font-size: 0.75rem;">
                        cat &#123;&#123;file_path&#125;&#125; | grep "&#123;&#123;pattern&#125;&#125;"
                    </code>
                </div>
            </details>
        </div>

        <!-- Parameter Schema -->
        <div class="card bg-base-200">
            <h4>Parameter Schema</h4>
            <p class="text-secondary" style="font-size: 0.875rem; margin-bottom: 1rem;">
                Define parameters that can be used in the command template with &#123;&#123;parameter_name&#125;&#125; syntax.
                These will create form fields when users create jobs from this template.
            </p>

            <input type="hidden" name="parameter_schema" x-model="parameterSchemaJson">

            <!-- Parameter List -->
            <div x-show="parameters.length > 0" class="mb-3">
                <template x-for="(param, index) in parameters" :key="index">
                    <div class="card bg-base-100 mb-2" style="padding: 0.75rem;">
                        <div class="flex-between mb-2">
                            <div>
                                <strong x-text="param.name"></strong>
                                <span class="badge badge-sm ml-2" x-text="param.type"></span>
                                <span x-show="param.required" class="badge badge-sm badge-error ml-1">Required</span>
                            </div>
                            <button type="button" @click="removeParameter(index)" class="btn btn-sm btn-danger">
                                <i data-lucide="trash-2" style="width: 14px; height: 14px;"></i>
                            </button>
                        </div>
                        <p class="text-secondary text-sm" x-text="param.description || 'No description'"></p>
                        <div class="text-sm mt-1">
                            <span class="text-secondary">Default:</span> <code x-text="param.default !== undefined && param.default !== null && param.default !== '' ? param.default : 'none'"></code>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Add Parameter Form -->
            <div class="card bg-base-100" style="padding: 0.75rem;">
                <div class="grid grid-cols-2 gap-3 mb-2">
                    <div>
                        <label class="text-sm">Parameter Name *</label>
                        <input type="text"
                               x-model="newParam.name"
                               placeholder="container_name"
                               class="w-full">
                    </div>
                    <div>
                        <label class="text-sm">Type *</label>
                        <select x-model="newParam.type" class="w-full">
                            <option value="string">String</option>
                            <option value="number">Number</option>
                            <option value="boolean">Boolean</option>
                            <option value="select">Select (Options)</option>
                        </select>
                    </div>
                </div>
                <div class="mb-2">
                    <label class="text-sm">Description</label>
                    <input type="text"
                           x-model="newParam.description"
                           placeholder="What this parameter is for"
                           class="w-full">
                </div>
                <div class="grid grid-cols-2 gap-3 mb-2">
                    <div>
                        <label class="text-sm">Default Value</label>
                        <input type="text"
                               x-model="newParam.default"
                               placeholder="Optional default"
                               class="w-full">
                    </div>
                    <div>
                        <label class="flex gap-2 align-center" style="cursor: pointer;">
                            <input type="checkbox" x-model="newParam.required">
                            <span class="text-sm">Required</span>
                        </label>
                    </div>
                </div>
                <button type="button" @click="addParameter()" class="btn btn-sm btn-secondary">
                    <i data-lucide="plus" style="width: 14px; height: 14px;"></i> Add Parameter
                </button>
            </div>
        </div>

        <!-- Required Capabilities -->
        <div class="form-group">
            <label>Required Capabilities</label>
            <input type="hidden" name="required_capabilities" x-model="capabilitiesJson">
            <div class="flex flex-wrap gap-2 mb-2">
                <template x-for="(cap, index) in capabilities" :key="index">
                    <span class="badge badge-primary">
                        <span x-text="cap"></span>
                        <button type="button" @click="removeCapability(index)" class="ml-1 text-error">✕</button>
                    </span>
                </template>
            </div>
            <div class="flex gap-2">
                <input type="text"
                       x-model="newCapability"
                       @keydown.enter.prevent="addCapability()"
                       placeholder="docker, systemd, etc.">
                <button type="button" @click="addCapability()" class="btn btn-sm btn-secondary">Add</button>
            </div>
        </div>

        <!-- OS Filter -->
        <div class="form-group">
            <label for="os_filter">OS Filter (JSON)</label>
            <input type="hidden" name="os_filter" x-model="osFilterJson">
            <textarea id="os_filter"
                      x-model="osFilterText"
                      rows="2"
                      class="font-mono text-sm"
                      placeholder='{"distro": ["ubuntu", "debian"]}'></textarea>
            <small class="text-secondary">Target specific operating systems</small>
        </div>

        <!-- Execution Settings -->
        <div class="card bg-base-200">
            <h4>Execution Settings</h4>

            <div class="grid grid-cols-2 gap-4">
                <div class="form-group">
                    <label for="timeout_seconds">Timeout (seconds)</label>
                    <input type="number"
                           id="timeout_seconds"
                           name="timeout_seconds"
                           value="{{ ct.timeout_seconds }}"
                           min="1"
                           placeholder="300">
                </div>

                <div class="form-group">
                    <label for="working_directory">Working Directory</label>
                    <input type="text"
                           id="working_directory"
                           name="working_directory"
                           value="{% match ct.working_directory %}{% when Some with (wd) %}{{ wd }}{% when None %}{% endmatch %}"
                           placeholder="/var/www">
                </div>
            </div>

            <!-- Environment Variables -->
            <div class="form-group">
                <label>Environment Variables</label>
                <input type="hidden" name="environment" x-model="environmentJson">
                <textarea x-model="environmentText"
                          rows="3"
                          class="font-mono text-sm"
                          placeholder='{"PATH": "/usr/local/bin:/usr/bin"}'></textarea>
                <small class="text-secondary">JSON object of environment variables</small>
            </div>
        </div>

        <!-- Output Handling -->
        <div class="card bg-base-200">
            <h4>Output Handling</h4>

            <div class="form-group">
                <label for="output_format">Output Format</label>
                <select id="output_format" name="output_format">
                    <option value="">Auto-detect</option>
                    <option value="json" {% match ct.output_format %}{% when Some with (f) %}{% if f == "json" %}selected{% endif %}{% when None %}{% endmatch %}>JSON</option>
                    <option value="text" {% match ct.output_format %}{% when Some with (f) %}{% if f == "text" %}selected{% endif %}{% when None %}{% endmatch %}>Text</option>
                    <option value="table" {% match ct.output_format %}{% when Some with (f) %}{% if f == "table" %}selected{% endif %}{% when None %}{% endmatch %}>Table</option>
                </select>
            </div>

            <div class="form-group">
                <label class="flex gap-2 align-center" style="cursor: pointer;">
                    <input type="checkbox"
                           name="parse_output"
                           {% if ct.parse_output %}checked{% endif %}>
                    <span>Parse Output</span>
                </label>
            </div>

            <div class="form-group">
                <label>Output Parser (JSON)</label>
                <input type="hidden" name="output_parser" x-model="parserJson">
                <textarea x-model="parserText"
                          rows="3"
                          class="font-mono text-sm"
                          placeholder='{"type": "regex", "pattern": "\\d+"}'></textarea>
                <small class="text-secondary">Parser configuration if parse_output is enabled</small>
            </div>
        </div>

        <!-- Notification Settings -->
        <div class="card bg-base-200">
            <h4>Notification Settings</h4>

            <div class="form-group">
                <label class="flex gap-2 align-center mb-2" style="cursor: pointer;">
                    <input type="checkbox"
                           name="notify_on_success"
                           {% if ct.notify_on_success %}checked{% endif %}>
                    <span>Notify on Success</span>
                </label>
                <label class="flex gap-2 align-center" style="cursor: pointer;">
                    <input type="checkbox"
                           name="notify_on_failure"
                           {% if ct.notify_on_failure %}checked{% endif %}>
                    <span>Notify on Failure</span>
                </label>
            </div>
        </div>

        <!-- Metadata -->
        <div class="form-group">
            <label>Metadata (JSON)</label>
            <input type="hidden" name="metadata" x-model="metadataJson">
            <textarea x-model="metadataText"
                      rows="3"
                      class="font-mono text-sm"
                      placeholder='{"priority": "high", "category": "maintenance"}'></textarea>
            <small class="text-secondary">Additional configuration as JSON</small>
        </div>

        <div class="flex gap-2">
            <button type="submit" class="btn btn-primary">
                <i data-lucide="save" style="width: 16px; height: 16px;"></i> Save
            </button>
            <button type="button"
                    class="btn btn-secondary"
                    @click="$dispatch('open-terminal', { command: document.getElementById('command').value })"
                    title="Test this command in a terminal">
                <i data-lucide="terminal" style="width: 16px; height: 16px;"></i> Test
            </button>
            <button type="button"
                    onclick="document.getElementById('command-template-form-container').innerHTML = ''"
                    class="btn btn-secondary">
                Cancel
            </button>
        </div>
    </form>
    {% when None %}
    <form hx-post="/job-types/{{ job_type_id }}/command-templates"
          hx-target="#command-template-list"
          hx-swap="innerHTML"
          @submit="serializeAllFields()">

        <!-- Internal Name -->
        <div class="form-group">
            <label for="name">Internal Name *</label>
            <input type="text"
                   id="name"
                   name="name"
                   placeholder="list_containers"
                   pattern="[a-z0-9_]+"
                   required>
            <small class="text-secondary">Lowercase, numbers, underscores only</small>
        </div>

        <!-- Display Name -->
        <div class="form-group">
            <label for="display_name">Display Name *</label>
            <input type="text"
                   id="display_name"
                   name="display_name"
                   placeholder="List Containers"
                   required>
        </div>

        <!-- Description -->
        <div class="form-group">
            <label for="description">Description</label>
            <textarea id="description"
                      name="description"
                      rows="2"
                      placeholder="Lists all Docker containers"></textarea>
        </div>

        <!-- Command with Variables -->
        <div class="form-group">
            <label for="command">Command Template *</label>
            <textarea id="command"
                      name="command"
                      rows="4"
                      class="font-mono"
                      placeholder="docker ps --filter 'status=&#123;&#123;status&#125;&#125;'"
                      required></textarea>
            <small class="text-secondary">Use &#123;&#123;variable&#125;&#125; syntax for substitution</small>

            <!-- Example Templates Dropdown -->
            <details style="margin-top: 0.5rem;">
                <summary style="cursor: pointer; color: var(--primary); font-size: 0.875rem;">
                    <i data-lucide="lightbulb" style="width: 14px; height: 14px;"></i> View Example Command Templates
                </summary>
                <div style="margin-top: 0.5rem; padding: 0.5rem; background: var(--bg); border-radius: 4px;">
                    <p style="font-size: 0.875rem; margin-bottom: 0.5rem;"><strong>Docker:</strong></p>
                    <code style="display: block; padding: 0.5rem; background: var(--bg-tertiary); border-radius: 4px; font-size: 0.75rem; margin-bottom: 0.5rem;">
                        docker ps --filter "name=&#123;&#123;container_name&#125;&#125;" --format json
                    </code>

                    <p style="font-size: 0.875rem; margin: 0.5rem 0;"><strong>System Updates (apt):</strong></p>
                    <code style="display: block; padding: 0.5rem; background: var(--bg-tertiary); border-radius: 4px; font-size: 0.75rem; margin-bottom: 0.5rem;">
                        sudo apt-get update && sudo apt-get upgrade -y
                    </code>

                    <p style="font-size: 0.875rem; margin: 0.5rem 0;"><strong>Service Management:</strong></p>
                    <code style="display: block; padding: 0.5rem; background: var(--bg-tertiary); border-radius: 4px; font-size: 0.75rem; margin-bottom: 0.5rem;">
                        systemctl &#123;&#123;action&#125;&#125; &#123;&#123;service_name&#125;&#125;
                    </code>

                    <p style="font-size: 0.875rem; margin: 0.5rem 0;"><strong>File Operations:</strong></p>
                    <code style="display: block; padding: 0.5rem; background: var(--bg-tertiary); border-radius: 4px; font-size: 0.75rem;">
                        cat &#123;&#123;file_path&#125;&#125; | grep "&#123;&#123;pattern&#125;&#125;"
                    </code>
                </div>
            </details>
        </div>

        <!-- Parameter Schema -->
        <div class="card bg-base-200">
            <h4>Parameter Schema</h4>
            <p class="text-secondary" style="font-size: 0.875rem; margin-bottom: 1rem;">
                Define parameters that can be used in the command template with &#123;&#123;parameter_name&#125;&#125; syntax.
                These will create form fields when users create jobs from this template.
            </p>

            <input type="hidden" name="parameter_schema" x-model="parameterSchemaJson">

            <!-- Parameter List -->
            <div x-show="parameters.length > 0" class="mb-3">
                <template x-for="(param, index) in parameters" :key="index">
                    <div class="card bg-base-100 mb-2" style="padding: 0.75rem;">
                        <div class="flex-between mb-2">
                            <div>
                                <strong x-text="param.name"></strong>
                                <span class="badge badge-sm ml-2" x-text="param.type"></span>
                                <span x-show="param.required" class="badge badge-sm badge-error ml-1">Required</span>
                            </div>
                            <button type="button" @click="removeParameter(index)" class="btn btn-sm btn-danger">
                                <i data-lucide="trash-2" style="width: 14px; height: 14px;"></i>
                            </button>
                        </div>
                        <p class="text-secondary text-sm" x-text="param.description || 'No description'"></p>
                        <div class="text-sm mt-1">
                            <span class="text-secondary">Default:</span> <code x-text="param.default !== undefined && param.default !== null && param.default !== '' ? param.default : 'none'"></code>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Add Parameter Form -->
            <div class="card bg-base-100" style="padding: 0.75rem;">
                <div class="grid grid-cols-2 gap-3 mb-2">
                    <div>
                        <label class="text-sm">Parameter Name *</label>
                        <input type="text"
                               x-model="newParam.name"
                               placeholder="container_name"
                               class="w-full">
                    </div>
                    <div>
                        <label class="text-sm">Type *</label>
                        <select x-model="newParam.type" class="w-full">
                            <option value="string">String</option>
                            <option value="number">Number</option>
                            <option value="boolean">Boolean</option>
                            <option value="select">Select (Options)</option>
                        </select>
                    </div>
                </div>
                <div class="mb-2">
                    <label class="text-sm">Description</label>
                    <input type="text"
                           x-model="newParam.description"
                           placeholder="What this parameter is for"
                           class="w-full">
                </div>
                <div class="grid grid-cols-2 gap-3 mb-2">
                    <div>
                        <label class="text-sm">Default Value</label>
                        <input type="text"
                               x-model="newParam.default"
                               placeholder="Optional default"
                               class="w-full">
                    </div>
                    <div>
                        <label class="flex gap-2 align-center" style="cursor: pointer;">
                            <input type="checkbox" x-model="newParam.required">
                            <span class="text-sm">Required</span>
                        </label>
                    </div>
                </div>
                <button type="button" @click="addParameter()" class="btn btn-sm btn-secondary">
                    <i data-lucide="plus" style="width: 14px; height: 14px;"></i> Add Parameter
                </button>
            </div>
        </div>

        <!-- Required Capabilities -->
        <div class="form-group">
            <label>Required Capabilities</label>
            <input type="hidden" name="required_capabilities" x-model="capabilitiesJson">
            <div class="flex flex-wrap gap-2 mb-2">
                <template x-for="(cap, index) in capabilities" :key="index">
                    <span class="badge badge-primary">
                        <span x-text="cap"></span>
                        <button type="button" @click="removeCapability(index)" class="ml-1 text-error">✕</button>
                    </span>
                </template>
            </div>
            <div class="flex gap-2">
                <input type="text"
                       x-model="newCapability"
                       @keydown.enter.prevent="addCapability()"
                       placeholder="docker, systemd, etc.">
                <button type="button" @click="addCapability()" class="btn btn-sm btn-secondary">Add</button>
            </div>
        </div>

        <!-- OS Filter -->
        <div class="form-group">
            <label for="os_filter">OS Filter (JSON)</label>
            <input type="hidden" name="os_filter" x-model="osFilterJson">
            <textarea id="os_filter"
                      x-model="osFilterText"
                      rows="2"
                      class="font-mono text-sm"
                      placeholder='{"distro": ["ubuntu", "debian"]}'></textarea>
            <small class="text-secondary">Target specific operating systems</small>
        </div>

        <!-- Execution Settings -->
        <div class="card bg-base-200">
            <h4>Execution Settings</h4>

            <div class="grid grid-cols-2 gap-4">
                <div class="form-group">
                    <label for="timeout_seconds">Timeout (seconds)</label>
                    <input type="number"
                           id="timeout_seconds"
                           name="timeout_seconds"
                           value="300"
                           min="1"
                           placeholder="300">
                </div>

                <div class="form-group">
                    <label for="working_directory">Working Directory</label>
                    <input type="text"
                           id="working_directory"
                           name="working_directory"
                           placeholder="/var/www">
                </div>
            </div>

            <!-- Environment Variables -->
            <div class="form-group">
                <label>Environment Variables</label>
                <input type="hidden" name="environment" x-model="environmentJson">
                <textarea x-model="environmentText"
                          rows="3"
                          class="font-mono text-sm"
                          placeholder='{"PATH": "/usr/local/bin:/usr/bin"}'></textarea>
                <small class="text-secondary">JSON object of environment variables</small>
            </div>
        </div>

        <!-- Output Handling -->
        <div class="card bg-base-200">
            <h4>Output Handling</h4>

            <div class="form-group">
                <label for="output_format">Output Format</label>
                <select id="output_format" name="output_format">
                    <option value="">Auto-detect</option>
                    <option value="json">JSON</option>
                    <option value="text">Text</option>
                    <option value="table">Table</option>
                </select>
            </div>

            <div class="form-group">
                <label class="flex gap-2 align-center" style="cursor: pointer;">
                    <input type="checkbox" name="parse_output">
                    <span>Parse Output</span>
                </label>
            </div>

            <div class="form-group">
                <label>Output Parser (JSON)</label>
                <input type="hidden" name="output_parser" x-model="parserJson">
                <textarea x-model="parserText"
                          rows="3"
                          class="font-mono text-sm"
                          placeholder='{"type": "regex", "pattern": "\\d+"}'></textarea>
                <small class="text-secondary">Parser configuration if parse_output is enabled</small>
            </div>
        </div>

        <!-- Notification Settings -->
        <div class="card bg-base-200">
            <h4>Notification Settings</h4>

            <div class="form-group">
                <label class="flex gap-2 align-center mb-2" style="cursor: pointer;">
                    <input type="checkbox" name="notify_on_success">
                    <span>Notify on Success</span>
                </label>
                <label class="flex gap-2 align-center" style="cursor: pointer;">
                    <input type="checkbox" name="notify_on_failure" checked>
                    <span>Notify on Failure</span>
                </label>
            </div>
        </div>

        <!-- Metadata -->
        <div class="form-group">
            <label>Metadata (JSON)</label>
            <input type="hidden" name="metadata" x-model="metadataJson">
            <textarea x-model="metadataText"
                      rows="3"
                      class="font-mono text-sm"
                      placeholder='{"priority": "high", "category": "maintenance"}'></textarea>
            <small class="text-secondary">Additional configuration as JSON</small>
        </div>

        <div class="flex gap-2">
            <button type="submit" class="btn btn-primary">
                <i data-lucide="save" style="width: 16px; height: 16px;"></i> Create
            </button>
            <button type="button"
                    class="btn btn-secondary"
                    @click="$dispatch('open-terminal', { command: document.getElementById('command').value })"
                    title="Test this command in a terminal">
                <i data-lucide="terminal" style="width: 16px; height: 16px;"></i> Test
            </button>
            <button type="button"
                    onclick="document.getElementById('command-template-form-container').innerHTML = ''"
                    class="btn btn-secondary">
                Cancel
            </button>
        </div>
    </form>
    {% endmatch %}
</div>

<script>
function commandTemplateForm() {
    return {
        capabilities: {% match command_template %}{% when Some with (ct) %}{{ ct.get_required_capabilities()|json|safe }}{% when None %}[]{% endmatch %},
        newCapability: '',
        capabilitiesJson: '',
        parameters: {% match command_template %}{% when Some with (ct) %}{{ ct.get_parameter_schema()|json|safe }}{% when None %}[]{% endmatch %},
        newParam: {
            name: '',
            type: 'string',
            description: '',
            default: '',
            required: false
        },
        parameterSchemaJson: '',
        osFilterText: {% match command_template %}{% when Some with (ct) %}'{{ ct.get_os_filter()|json|safe }}'{% when None %}'{}'{% endmatch %},
        osFilterJson: '',
        environmentText: {% match command_template %}{% when Some with (ct) %}'{{ ct.get_environment()|json|safe }}'{% when None %}'{}'{% endmatch %},
        environmentJson: '',
        parserText: {% match command_template %}{% when Some with (ct) %}'{{ ct.get_output_parser()|json|safe }}'{% when None %}'{}'{% endmatch %},
        parserJson: '',
        metadataText: {% match command_template %}{% when Some with (ct) %}'{{ ct.get_metadata()|json|safe }}'{% when None %}'{}'{% endmatch %},
        metadataJson: '',

        init() {
            this.serializeAllFields();
        },

        addCapability() {
            if (this.newCapability && !this.capabilities.includes(this.newCapability.trim())) {
                this.capabilities.push(this.newCapability.trim());
                this.newCapability = '';
                this.updateCapabilitiesJson();
            }
        },

        removeCapability(index) {
            this.capabilities.splice(index, 1);
            this.updateCapabilitiesJson();
        },

        updateCapabilitiesJson() {
            this.capabilitiesJson = this.capabilities.length > 0 ? JSON.stringify(this.capabilities) : '';
        },

        addParameter() {
            if (this.newParam.name.trim()) {
                const param = {
                    name: this.newParam.name.trim(),
                    type: this.newParam.type,
                    required: this.newParam.required,
                    description: this.newParam.description.trim() || undefined,
                    default: this.newParam.default.trim() || undefined
                };
                this.parameters.push(param);
                this.newParam = {
                    name: '',
                    type: 'string',
                    description: '',
                    default: '',
                    required: false
                };
                this.updateParameterSchemaJson();
            }
        },

        removeParameter(index) {
            this.parameters.splice(index, 1);
            this.updateParameterSchemaJson();
        },

        updateParameterSchemaJson() {
            this.parameterSchemaJson = this.parameters.length > 0 ? JSON.stringify(this.parameters) : '';
        },

        serializeJsonField(text, outputVar) {
            try {
                if (text.trim()) {
                    JSON.parse(text);
                    this[outputVar] = text.trim();
                } else {
                    this[outputVar] = '';
                }
            } catch (e) {
                console.warn(`Invalid ${outputVar} JSON:`, e);
            }
        },

        serializeAllFields() {
            this.updateCapabilitiesJson();
            this.updateParameterSchemaJson();
            this.serializeJsonField(this.osFilterText, 'osFilterJson');
            this.serializeJsonField(this.environmentText, 'environmentJson');
            this.serializeJsonField(this.parserText, 'parserJson');
            this.serializeJsonField(this.metadataText, 'metadataJson');
        }
    };
}
</script>
