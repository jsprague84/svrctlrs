<div class="card" x-data="{ targetType: '{% match job_template %}{% when Some with (jt) %}{% match jt.target_type %}{% when svrctlrs_database::models::TargetType::AllServers %}all_servers{% when svrctlrs_database::models::TargetType::Tagged %}tagged{% when svrctlrs_database::models::TargetType::Specific %}specific{% endmatch %}{% when None %}all_servers{% endmatch %}' }">
    <h2>{% match job_template %}{% when Some with (_) %}Edit{% when None %}Add{% endmatch %} Job Template</h2>

    {% match error %}
    {% when Some with (e) %}
    <div class="alert alert-error">{{ e }}</div>
    {% when None %}
    {% endmatch %}

    {% match job_template %}
    {% when Some with (jt) %}
    <form hx-put="/job-templates/{{ jt.id }}"
          hx-target="#job-template-list"
          hx-swap="innerHTML">

        <div class="form-group">
            <label for="name">Template Name *</label>
            <input type="text"
                   id="name"
                   name="name"
                   value="{{ jt.name }}"
                   placeholder="Weekly System Updates"
                   required>
        </div>

        <div class="form-group">
            <label for="job_type_id">Job Type *</label>
            <select id="job_type_id"
                    name="job_type_id"
                    required>
                {% for job_type in job_types %}
                <option value="{{ job_type.id }}" {% if job_type.id == jt.job_type_id %}selected{% endif %}>
                    {{ job_type.name }}
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="target_type">Target Servers *</label>
            <select id="target_type"
                    name="target_type"
                    x-model="targetType"
                    required>
                <option value="all_servers">All Servers</option>
                <option value="tagged">Servers with Tags</option>
                <option value="specific">Specific Servers</option>
            </select>
        </div>

        <div class="form-group" x-show="targetType === 'tagged'">
            <label>Select Tags</label>
            <div style="max-height: 150px; overflow-y: auto; border: 1px solid var(--border); border-radius: 4px; padding: 0.5rem;">
                {% for tag in available_tags %}
                <label class="flex gap-2 align-center mb-1" style="cursor: pointer;">
                    <input type="checkbox"
                           name="tag_ids"
                           value="{{ tag.id }}"
                           {% for t in jt.target_tags %}{% if t.id == tag.id %}checked{% endif %}{% endfor %}>
                    <span class="badge" style="background-color: {{ tag.color }}; color: #fff;">
                        {{ tag.name }}
                    </span>
                </label>
                {% endfor %}
            </div>
        </div>

        <div class="form-group" x-show="targetType === 'specific'">
            <label>Select Servers</label>
            <div style="max-height: 150px; overflow-y: auto; border: 1px solid var(--border); border-radius: 4px; padding: 0.5rem;">
                {% for server in available_servers %}
                <label class="flex gap-2 align-center mb-1" style="cursor: pointer;">
                    <input type="checkbox"
                           name="server_ids"
                           value="{{ server.id }}"
                           {% for s in jt.target_servers %}{% if s.id == server.id %}checked{% endif %}{% endfor %}>
                    <span>{{ server.name }}</span>
                </label>
                {% endfor %}
            </div>
        </div>

        <div class="form-group">
            <label for="description">Description (optional)</label>
            <textarea id="description"
                      name="description"
                      rows="2"
                      placeholder="What this job template does">{% match jt.description %}{% when Some with (d) %}{{ d }}{% when None %}{% endmatch %}</textarea>
        </div>

        <div class="form-group">
            <label for="timeout_seconds">Timeout (seconds)</label>
            <input type="number"
                   id="timeout_seconds"
                   name="timeout_seconds"
                   value="{% match jt.timeout_seconds %}{% when Some with (t) %}{{ t }}{% when None %}300{% endmatch %}"
                   min="1"
                   placeholder="300">
            <small class="text-secondary">Maximum time for job execution (default: 300s)</small>
        </div>

        <div class="flex gap-2">
            <button type="submit" class="btn btn-primary">
                <i data-lucide="save" style="width: 16px; height: 16px;"></i> Save
            </button>
            <button type="button"
                    onclick="document.getElementById('job-template-form-container').innerHTML = ''"
                    class="btn btn-secondary">
                Cancel
            </button>
        </div>
    </form>
    {% when None %}
    <form hx-post="/job-templates"
          hx-target="#job-template-list"
          hx-swap="innerHTML">

        <div class="form-group">
            <label for="name">Template Name *</label>
            <input type="text"
                   id="name"
                   name="name"
                   placeholder="Weekly System Updates"
                   required>
        </div>

        <div class="form-group">
            <label for="job_type_id">Job Type *</label>
            <select id="job_type_id"
                    name="job_type_id"
                    required>
                <option value="">Select a job type...</option>
                {% for job_type in job_types %}
                <option value="{{ job_type.id }}">
                    {{ job_type.name }}
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="target_type">Target Servers *</label>
            <select id="target_type"
                    name="target_type"
                    x-model="targetType"
                    required>
                <option value="all_servers">All Servers</option>
                <option value="tagged">Servers with Tags</option>
                <option value="specific">Specific Servers</option>
            </select>
        </div>

        <div class="form-group" x-show="targetType === 'tagged'">
            <label>Select Tags</label>
            <div style="max-height: 150px; overflow-y: auto; border: 1px solid var(--border); border-radius: 4px; padding: 0.5rem;">
                {% for tag in available_tags %}
                <label class="flex gap-2 align-center mb-1" style="cursor: pointer;">
                    <input type="checkbox"
                           name="tag_ids"
                           value="{{ tag.id }}">
                    <span class="badge" style="background-color: {{ tag.color }}; color: #fff;">
                        {{ tag.name }}
                    </span>
                </label>
                {% endfor %}
            </div>
        </div>

        <div class="form-group" x-show="targetType === 'specific'">
            <label>Select Servers</label>
            <div style="max-height: 150px; overflow-y: auto; border: 1px solid var(--border); border-radius: 4px; padding: 0.5rem;">
                {% for server in available_servers %}
                <label class="flex gap-2 align-center mb-1" style="cursor: pointer;">
                    <input type="checkbox"
                           name="server_ids"
                           value="{{ server.id }}">
                    <span>{{ server.name }}</span>
                </label>
                {% endfor %}
            </div>
        </div>

        <div class="form-group">
            <label for="description">Description (optional)</label>
            <textarea id="description"
                      name="description"
                      rows="2"
                      placeholder="What this job template does"></textarea>
        </div>

        <div class="form-group">
            <label for="timeout_seconds">Timeout (seconds)</label>
            <input type="number"
                   id="timeout_seconds"
                   name="timeout_seconds"
                   value="300"
                   min="1"
                   placeholder="300">
            <small class="text-secondary">Maximum time for job execution (default: 300s)</small>
        </div>

        <div class="flex gap-2">
            <button type="submit" class="btn btn-primary">
                <i data-lucide="save" style="width: 16px; height: 16px;"></i> Save
            </button>
            <button type="button"
                    onclick="document.getElementById('job-template-form-container').innerHTML = ''"
                    class="btn btn-secondary">
                Cancel
            </button>
        </div>
    </form>
    {% endmatch %}
</div>
