<div class="card">
    <h2>{% match job_template %}{% when Some with (_) %}Edit{% when None %}Add{% endmatch %} Job Template</h2>

    {% match error %}
    {% when Some with (e) %}
    <div class="alert alert-error">{{ e }}</div>
    {% when None %}
    {% endmatch %}

    {% match job_template %}
    {% when Some with (jt) %}
    <form hx-put="/job-templates/{{ jt.id }}"
          hx-target="#job-template-list"
          hx-swap="innerHTML">

        <div class="form-group">
            <label for="name">Template Name *</label>
            <input type="text"
                   id="name"
                   name="name"
                   value="{{ jt.name }}"
                   placeholder="weekly_system_updates"
                   required>
            <small class="text-secondary">Unique identifier (lowercase, underscores)</small>
        </div>

        <div class="form-group">
            <label for="display_name">Display Name *</label>
            <input type="text"
                   id="display_name"
                   name="display_name"
                   value="{{ jt.display_name }}"
                   placeholder="Weekly System Updates"
                   required>
        </div>

        <div class="form-group">
            <label for="job_type_id">Job Type *</label>
            <select id="job_type_id"
                    name="job_type_id"
                    required
                    x-init="$el.value = '{{ jt.job_type_id }}'">
                {% for job_type in job_types %}
                <option value="{{ job_type.id }}">
                    {{ job_type.display_name }}
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="description">Description (optional)</label>
            <textarea id="description"
                      name="description"
                      rows="2"
                      placeholder="What this job template does">{% match jt.description %}{% when Some with (d) %}{{ d }}{% when None %}{% endmatch %}</textarea>
        </div>

        <div class="form-group">
            <label>
                <input type="checkbox"
                       name="is_composite"
                       value="1"
                       {% if jt.is_composite %}checked{% endif %}>
                Composite Job (multi-step workflow)
            </label>
            <small class="text-secondary">If checked, you'll define multiple steps. Otherwise, select a single command template.</small>
        </div>

        {% if !jt.is_composite %}
        <div class="form-group">
            <label for="command_template_id">Command Template *</label>
            <select id="command_template_id"
                    name="command_template_id"
                    {% if jt.is_composite %}disabled{% endif %}
                    {% match jt.command_template_id %}{% when Some with (id) %}x-init="$el.value = '{{ id }}'"{% when None %}{% endmatch %}>
                <option value="">Select a command...</option>
                {% for ct in command_templates %}
                <option value="{{ ct.id }}">
                    {{ ct.display_name }}
                </option>
                {% endfor %}
            </select>
        </div>
        {% endif %}

        <div class="form-group">
            <label for="timeout_seconds">Timeout (seconds)</label>
            <input type="number"
                   id="timeout_seconds"
                   name="timeout_seconds"
                   value="{{ jt.timeout_seconds }}"
                   min="1"
                   placeholder="300">
            <small class="text-secondary">Maximum time for job execution (default: 300s)</small>
        </div>

        <div class="form-group">
            <label for="retry_count">Retry Count</label>
            <input type="number"
                   id="retry_count"
                   name="retry_count"
                   value="{{ jt.retry_count }}"
                   min="0"
                   max="10"
                   placeholder="0">
            <small class="text-secondary">Number of retries on failure (default: 0)</small>
        </div>

        <div class="form-group">
            <label>
                <input type="checkbox"
                       name="notify_on_success"
                       value="1"
                       {% if jt.notify_on_success %}checked{% endif %}>
                Notify on Success
            </label>
        </div>

        <div class="form-group">
            <label>
                <input type="checkbox"
                       name="notify_on_failure"
                       value="1"
                       {% if jt.notify_on_failure %}checked{% endif %}>
                Notify on Failure
            </label>
        </div>

        <div class="flex gap-2">
            <button type="submit" class="btn btn-primary">Update Template</button>
            <button type="button"
                    hx-get="/job-templates/list"
                    hx-target="#job-template-list"
                    hx-swap="innerHTML"
                    class="btn btn-secondary">Cancel</button>
        </div>
    </form>

    {% when None %}
    <form hx-post="/job-templates"
          hx-target="#job-template-list"
          hx-swap="innerHTML">

        <div class="form-group">
            <label for="name">Template Name *</label>
            <input type="text"
                   id="name"
                   name="name"
                   placeholder="weekly_system_updates"
                   required>
            <small class="text-secondary">Unique identifier (lowercase, underscores)</small>
        </div>

        <div class="form-group">
            <label for="display_name">Display Name *</label>
            <input type="text"
                   id="display_name"
                   name="display_name"
                   placeholder="Weekly System Updates"
                   required>
        </div>

        <div class="form-group">
            <label for="job_type_id">Job Type *</label>
            <select id="job_type_id"
                    name="job_type_id"
                    required>
                <option value="">Select a job type...</option>
                {% for job_type in job_types %}
                <option value="{{ job_type.id }}">
                    {{ job_type.display_name }}
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="description">Description (optional)</label>
            <textarea id="description"
                      name="description"
                      rows="2"
                      placeholder="What this job template does"></textarea>
        </div>

        <div class="form-group">
            <label>
                <input type="checkbox"
                       name="is_composite"
                       value="1">
                Composite Job (multi-step workflow)
            </label>
            <small class="text-secondary">If checked, you'll define multiple steps after creating the template.</small>
        </div>

        <div class="form-group" id="command-template-group">
            <label for="command_template_id">Command Template *</label>
            <select id="command_template_id"
                    name="command_template_id">
                <option value="">Select a command...</option>
                {% for ct in command_templates %}
                <option value="{{ ct.id }}">
                    {{ ct.display_name }}
                </option>
                {% endfor %}
            </select>
            <small class="text-secondary">Not required for composite jobs</small>
        </div>

        <div class="form-group">
            <label for="timeout_seconds">Timeout (seconds)</label>
            <input type="number"
                   id="timeout_seconds"
                   name="timeout_seconds"
                   value="300"
                   min="1"
                   placeholder="300">
        </div>

        <div class="form-group">
            <label for="retry_count">Retry Count</label>
            <input type="number"
                   id="retry_count"
                   name="retry_count"
                   value="0"
                   min="0"
                   max="10"
                   placeholder="0">
        </div>

        <div class="form-group">
            <label>
                <input type="checkbox"
                       name="notify_on_failure"
                       value="1"
                       checked>
                Notify on Failure
            </label>
        </div>

        <div class="flex gap-2">
            <button type="submit" class="btn btn-primary">Create Template</button>
            <button type="button"
                    hx-get="/job-templates/list"
                    hx-target="#job-template-list"
                    hx-swap="innerHTML"
                    class="btn btn-secondary">Cancel</button>
        </div>
    </form>
    {% endmatch %}
</div>
