{% if task_groups.is_empty() %}
<div class="card">
    <p class="text-secondary">No tasks configured.</p>
</div>
{% else %}
{% for group in task_groups %}
<div class="card">
    <h3>
        {% match group.server_name %}
        {% when Some with (name) %}
        üì° {{ name }}
        {% when None %}
        üíª Local Tasks
        {% endmatch %}
    </h3>
    
    {% if group.tasks.is_empty() %}
    <p class="text-secondary">No tasks for this server.</p>
    {% else %}
    <table>
        <thead>
            <tr>
                <th>Task</th>
                <th>Plugin</th>
                <th>Schedule</th>
                <th>Last Run</th>
                <th>Next Run</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for task in group.tasks %}
            <tr>
                <td>
                    <strong>{{ task.name }}</strong>
                    {% match task.description %}
                    {% when Some with (d) %}
                    <br><small class="text-secondary">{{ d }}</small>
                    {% when None %}
                    {% endmatch %}
                </td>
                <td>
                    <span class="badge">{{ task.plugin_id }}</span>
                </td>
                <td>
                    <code class="schedule-display" 
                          id="schedule-display-{{ task.id }}"
                          onclick="editSchedule({{ task.id }}, '{{ task.schedule }}')">
                        {{ task.schedule }}
                    </code>
                    <form id="schedule-form-{{ task.id }}" 
                          style="display: none;"
                          hx-put="/tasks/{{ task.id }}/schedule"
                          hx-target="#schedule-display-{{ task.id }}"
                          hx-swap="outerHTML">
                        <input type="text" 
                               name="schedule" 
                               value="{{ task.schedule }}"
                               id="schedule-input-{{ task.id }}"
                               class="schedule-input"
                               onblur="cancelScheduleEdit({{ task.id }}, '{{ task.schedule }}')"
                               onkeydown="handleScheduleKeydown(event, {{ task.id }})">
                    </form>
                </td>
                <td>
                    {% match task.last_run_at %}
                    {% when Some with (t) %}{{ t }}{% when None %}<span class="text-secondary">Never</span>{% endmatch %}
                </td>
                <td>
                    {% match task.next_run_at %}
                    {% when Some with (t) %}{{ t }}{% when None %}<span class="text-secondary">-</span>{% endmatch %}
                </td>
                <td>
                    <div class="flex gap-2">
                        <button class="btn btn-sm btn-primary"
                                hx-post="/tasks/{{ task.id }}/run"
                                hx-target="#task-run-result-{{ task.id }}"
                                hx-swap="innerHTML">
                            ‚ñ∂ Run
                        </button>
                        <button class="btn btn-sm btn-danger"
                                hx-delete="/tasks/{{ task.id }}"
                                hx-target="#task-list"
                                hx-swap="innerHTML"
                                hx-confirm="Delete task '{{ task.name }}'? This cannot be undone.">
                            üóëÔ∏è Delete
                        </button>
                    </div>
                    <div id="task-run-result-{{ task.id }}"></div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}
</div>
{% endfor %}
{% endif %}
