<div class="card" x-data="{
    channelType: '{% match channel %}{% when Some with (c) %}{{ c.channel_type }}{% when None %}gotify{% endmatch %}',
    buildConfig() {
        const config = {};
        if (this.channelType === 'gotify') {
            const url = document.querySelector('input[name=endpoint]').value;
            const token = document.querySelector('input[name=token]').value;
            if (url) config.url = url;
            if (token) config.token = token;
        } else if (this.channelType === 'ntfy') {
            const url = document.querySelector('input[name=endpoint]').value;
            const topic = document.querySelector('input[name=topic]').value;
            const token = document.querySelector('input[name=token]').value;
            const username = document.querySelector('input[name=username]').value;
            const password = document.querySelector('input[name=password]').value;
            if (url) config.url = url;
            if (topic) config.topic = topic;
            if (token) config.token = token;
            if (username) config.username = username;
            if (password) config.password = password;
        }
        return JSON.stringify(config);
    },
    handleSubmit(event) {
        // Build and inject config JSON
        const configField = event.target.querySelector('input[name=config]');
        if (configField) {
            configField.value = this.buildConfig();
        }
    }
}">
    <h2>{% match channel %}{% when Some with (_) %}Edit{% when None %}Add{% endmatch %} Notification Channel</h2>

    {% match error %}
    {% when Some with (e) %}
    <div class="alert alert-error">{{ e }}</div>
    {% when None %}
    {% endmatch %}

    {% match channel %}
    {% when Some with (c) %}
    <form hx-put="/settings/notifications/channels/{{ c.id }}"
          hx-target="#channel-list"
          hx-swap="innerHTML"
          @submit="handleSubmit">

        <input type="hidden" name="config" value="">

        <div class="form-group">
            <label for="name">Channel Name *</label>
            <input type="text"
                   id="name"
                   name="name"
                   value="{{ c.name }}"
                   placeholder="Production Gotify"
                   required>
        </div>

        <div class="form-group">
            <label for="channel_type">Channel Type *</label>
            <select id="channel_type"
                    name="channel_type"
                    x-model="channelType"
                    required>
                <option value="gotify">Gotify</option>
                <option value="ntfy">ntfy.sh</option>
            </select>
        </div>

        <div class="form-group" x-show="channelType === 'gotify'">
            <label for="endpoint">Gotify Server URL *</label>
            <input type="url"
                   id="endpoint"
                   name="endpoint"
                   value="{{ c.endpoint }}"
                   placeholder="https://gotify.example.com"
                   :required="channelType === 'gotify'">
        </div>

        <div class="form-group" x-show="channelType === 'gotify'">
            <label for="token">Gotify App Token *</label>
            <input type="password"
                   id="token"
                   name="token"
                   placeholder="Leave blank to keep current token"
                   :required="channelType === 'gotify'">
            <small class="text-secondary">Token is encrypted at rest</small>
        </div>

        <div class="form-group" x-show="channelType === 'ntfy'">
            <label for="endpoint">ntfy.sh Server URL *</label>
            <input type="url"
                   id="endpoint_ntfy"
                   name="endpoint"
                   value="{{ c.endpoint }}"
                   placeholder="https://ntfy.sh"
                   :required="channelType === 'ntfy'">
        </div>

        <div class="form-group" x-show="channelType === 'ntfy'">
            <label for="topic">ntfy.sh Topic *</label>
            <input type="text"
                   id="topic"
                   name="topic"
                   value=""
                   placeholder="my-server-alerts"
                   :required="channelType === 'ntfy'">
        </div>

        <div class="form-group" x-show="channelType === 'ntfy'">
            <label>Authentication (optional)</label>
            <small class="text-secondary">Choose one method if your topic is protected</small>
        </div>

        <div class="form-group" x-show="channelType === 'ntfy'">
            <label for="token_ntfy">Access Token</label>
            <input type="password"
                   id="token_ntfy"
                   name="token"
                   placeholder="Leave blank if topic is public or to keep current token">
            <small class="text-secondary">OR use username/password below</small>
        </div>

        <div class="form-group" x-show="channelType === 'ntfy'">
            <label for="username">Username</label>
            <input type="text"
                   id="username"
                   name="username"
                   placeholder="For Basic Auth">
        </div>

        <div class="form-group" x-show="channelType === 'ntfy'">
            <label for="password">Password</label>
            <input type="password"
                   id="password"
                   name="password"
                   placeholder="For Basic Auth">
        </div>

        <div class="form-group">
            <label for="description">Description (optional)</label>
            <textarea id="description"
                      name="description"
                      rows="2"
                      placeholder="Brief description of this channel">{{ c.description }}</textarea>
        </div>

        <div class="flex gap-2">
            <button type="submit" class="btn btn-primary">
                <i data-lucide="save" style="width: 16px; height: 16px;"></i> Save
            </button>
            <button type="button"
                    onclick="document.getElementById('channel-form-container').innerHTML = ''"
                    class="btn btn-secondary">
                Cancel
            </button>
        </div>
    </form>
    {% when None %}
    <form hx-post="/settings/notifications/channels"
          hx-target="#channel-list"
          hx-swap="innerHTML"
          @submit="handleSubmit">

        <input type="hidden" name="config" value="">

        <div class="form-group">
            <label for="name">Channel Name *</label>
            <input type="text"
                   id="name"
                   name="name"
                   placeholder="Production Gotify"
                   required>
        </div>

        <div class="form-group">
            <label for="channel_type">Channel Type *</label>
            <select id="channel_type"
                    name="channel_type"
                    x-model="channelType"
                    required>
                <option value="gotify">Gotify</option>
                <option value="ntfy">ntfy.sh</option>
            </select>
        </div>

        <div class="form-group" x-show="channelType === 'gotify'">
            <label for="endpoint">Gotify Server URL *</label>
            <input type="url"
                   id="endpoint"
                   name="endpoint"
                   placeholder="https://gotify.example.com"
                   :required="channelType === 'gotify'">
        </div>

        <div class="form-group" x-show="channelType === 'gotify'">
            <label for="token">Gotify App Token *</label>
            <input type="password"
                   id="token"
                   name="token"
                   :required="channelType === 'gotify'">
            <small class="text-secondary">Token is encrypted at rest</small>
        </div>

        <div class="form-group" x-show="channelType === 'ntfy'">
            <label for="endpoint_ntfy">ntfy.sh Server URL *</label>
            <input type="url"
                   id="endpoint_ntfy"
                   name="endpoint"
                   placeholder="https://ntfy.sh"
                   :required="channelType === 'ntfy'">
        </div>

        <div class="form-group" x-show="channelType === 'ntfy'">
            <label for="topic">ntfy.sh Topic *</label>
            <input type="text"
                   id="topic"
                   name="topic"
                   placeholder="my-server-alerts"
                   :required="channelType === 'ntfy'">
        </div>

        <div class="form-group" x-show="channelType === 'ntfy'">
            <label>Authentication (optional)</label>
            <small class="text-secondary">Choose one method if your topic is protected</small>
        </div>

        <div class="form-group" x-show="channelType === 'ntfy'">
            <label for="token_ntfy_new">Access Token</label>
            <input type="password"
                   id="token_ntfy_new"
                   name="token"
                   placeholder="Leave blank for public topics">
            <small class="text-secondary">OR use username/password below</small>
        </div>

        <div class="form-group" x-show="channelType === 'ntfy'">
            <label for="username_new">Username</label>
            <input type="text"
                   id="username_new"
                   name="username"
                   placeholder="For Basic Auth">
        </div>

        <div class="form-group" x-show="channelType === 'ntfy'">
            <label for="password_new">Password</label>
            <input type="password"
                   id="password_new"
                   name="password"
                   placeholder="For Basic Auth">
        </div>

        <div class="form-group">
            <label for="description">Description (optional)</label>
            <textarea id="description"
                      name="description"
                      rows="2"
                      placeholder="Brief description of this channel"></textarea>
        </div>

        <div class="flex gap-2">
            <button type="submit" class="btn btn-primary">
                <i data-lucide="save" style="width: 16px; height: 16px;"></i> Save
            </button>
            <button type="button"
                    onclick="document.getElementById('channel-form-container').innerHTML = ''"
                    class="btn btn-secondary">
                Cancel
            </button>
        </div>
    </form>
    {% endmatch %}
</div>
