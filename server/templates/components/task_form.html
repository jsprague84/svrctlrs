{# Task Creation/Edit Form

   This form supports both creating and editing tasks.
   Dynamic UI shows plugin selection for local tasks OR command input for remote tasks.

   Parameters:
   - task: Option<Task> - Existing task for editing (None for new task)
   - servers: Vec<Server> - Available servers for selection
   - plugins: Vec<Plugin> - Available plugins for local tasks
   - error: Option<String> - Validation error message
#}

<div class="card">
    <div class="card-header">
        <h3 class="card-title">
            {% if task.is_some() %}Edit Task{% else %}Create Task{% endif %}
        </h3>
    </div>

    {% if let Some(err) = error %}
    <div class="alert alert-error">
        {{ err }}
    </div>
    {% endif %}

    <form {% if task.is_some() %}
          hx-put="/tasks/{{ task.as_ref().unwrap().id }}"
          {% else %}
          hx-post="/tasks"
          {% endif %}
          hx-target="#task-list"
          hx-swap="innerHTML"
          x-data="taskForm({{ task.is_some() }})"
          @submit="handleSubmit">

        {# Basic Information #}
        <div class="form-group">
            <label for="task-name">Task Name *</label>
            <input type="text"
                   id="task-name"
                   name="name"
                   required
                   placeholder="e.g., Check Docker Health"
                   value="{% if let Some(t) = task %}{{ t.name }}{% endif %}"
                   class="form-control">
            <small class="text-secondary">A descriptive name for this task</small>
        </div>

        <div class="form-group">
            <label for="task-description">Description</label>
            <textarea id="task-description"
                      name="description"
                      rows="2"
                      placeholder="Optional description of what this task does"
                      class="form-control">{% if let Some(t) = task %}{% if let Some(d) = t.description %}{{ d }}{% endif %}{% endif %}</textarea>
        </div>

        {# Target Server Selection - KEY PART #}
        <div class="form-group">
            <label for="task-server">Target Server *</label>
            <select id="task-server"
                    name="server_id"
                    required
                    x-model="serverSelection"
                    @change="updateTaskType"
                    class="form-control">
                <option value="">-- Select Target --</option>
                <option value="local"
                        {% if task.is_some() %}{% if task.as_ref().unwrap().server_id.is_none() %}selected{% endif %}{% endif %}>
                    ðŸ’» Local (Plugin Task)
                </option>
                {% for server in servers %}
                <option value="{{ server.id }}">
                    ðŸ“¡ {{ server.name }}{% if !server.host.is_empty() %} ({{ server.host }}){% endif %}
                </option>
                {% endfor %}
            </select>
            <small class="text-secondary">
                Select <strong>Local</strong> to run a plugin task on this system, or select a remote server to run SSH commands
            </small>
        </div>

        {# Plugin Selection (shown for local tasks) #}
        <div class="form-group" x-show="isLocalTask" x-cloak>
            <label for="task-plugin">Plugin *</label>
            <select id="task-plugin"
                    name="plugin_id"
                    :required="isLocalTask"
                    x-model="selectedPlugin"
                    class="form-control">
                <option value="">-- Select Plugin --</option>
                {% for plugin in plugins %}
                <option value="{{ plugin.id }}">
                    {{ plugin.name }}
                </option>
                {% endfor %}
            </select>
            <small class="text-secondary">Plugin to execute on the local system</small>
        </div>

        {# Plugin Task Selection (shown when plugin selected) #}
        <div class="form-group" x-show="isLocalTask && selectedPlugin" x-cloak>
            <label for="task-command">Plugin Task *</label>
            <input type="text"
                   id="task-command"
                   name="command"
                   :required="isLocalTask"
                   placeholder="e.g., docker_health, system_metrics"
                   value="{% if let Some(t) = task %}{{ t.command }}{% endif %}"
                   class="form-control">
            <small class="text-secondary">
                The specific task ID from the plugin (e.g., docker_health, system_metrics)
            </small>
        </div>

        {# Remote Command (shown for remote tasks) #}
        <div class="form-group" x-show="!isLocalTask" x-cloak>
            <label for="task-remote-command">Command *</label>
            <input type="text"
                   id="task-remote-command"
                   name="remote_command"
                   :required="!isLocalTask"
                   placeholder="e.g., docker ps -a"
                   value="{% if let Some(t) = task %}{% if t.server_id.is_some() %}{{ t.command }}{% endif %}{% endif %}"
                   class="form-control monospace">
            <small class="text-secondary">
                Shell command to execute on the remote server via SSH
            </small>
        </div>

        {# Schedule Configuration #}
        <div class="form-group">
            <label for="task-schedule">Schedule (Cron Expression) *</label>
            <input type="text"
                   id="task-schedule"
                   name="schedule"
                   required
                   placeholder="0 */5 * * * *"
                   value="{% if let Some(t) = task %}{{ t.schedule }}{% else %}0 */5 * * * *{% endif %}"
                   class="form-control monospace"
                   x-model="scheduleExpression">
            <small class="text-secondary">
                <strong>Examples:</strong><br>
                <code>0 */5 * * * *</code> - Every 5 minutes<br>
                <code>0 0 2 * * *</code> - Daily at 2:00 AM<br>
                <code>0 0 9 * * MON</code> - Every Monday at 9:00 AM<br>
                <span x-show="scheduleExpression" x-text="'Next run: ' + getNextRun()"></span>
            </small>
        </div>

        {# Advanced Options (collapsible) #}
        <div class="form-group" x-data="{ showAdvanced: false }">
            <button type="button"
                    @click="showAdvanced = !showAdvanced"
                    class="btn btn-secondary btn-sm">
                <span x-text="showAdvanced ? 'â–¼' : 'â–¶'"></span>
                Advanced Options
            </button>

            <div x-show="showAdvanced" x-collapse class="mt-3">
                <div class="form-group">
                    <label for="task-timeout">Timeout (seconds)</label>
                    <input type="number"
                           id="task-timeout"
                           name="timeout"
                           min="1"
                           max="3600"
                           value="{% if let Some(t) = task %}{{ t.timeout }}{% else %}300{% endif %}"
                           class="form-control">
                    <small class="text-secondary">
                        Maximum time to wait for task completion (default: 300 seconds / 5 minutes)
                    </small>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox"
                               name="enabled"
                               {% if task.is_none() %}checked{% else %}{% if task.as_ref().unwrap().enabled %}checked{% endif %}{% endif %}>
                        Enable task immediately
                    </label>
                    <small class="text-secondary block">
                        Uncheck to create the task in disabled state
                    </small>
                </div>

                {# Future: Notification settings #}
                <div class="form-group" style="opacity: 0.5; pointer-events: none;">
                    <label>Notifications (Coming Soon)</label>
                    <select disabled class="form-control">
                        <option>On failure only</option>
                        <option>On success and failure</option>
                        <option>Never</option>
                    </select>
                </div>

                {# Future: Retry settings #}
                <div class="form-group" style="opacity: 0.5; pointer-events: none;">
                    <label>Retry on Failure (Coming Soon)</label>
                    <input type="number" disabled value="3" class="form-control">
                </div>
            </div>
        </div>

        {# Form Actions #}
        <div class="flex gap-2 mt-4">
            <button type="submit"
                    class="btn btn-primary"
                    :disabled="!isValid() || submitting">
                <span x-show="!submitting">{% if task.is_some() %}Update Task{% else %}Create Task{% endif %}</span>
                <span x-show="submitting">Creating...</span>
            </button>

            <button type="button"
                    @click="$dispatch('close-form')"
                    class="btn btn-secondary">
                Cancel
            </button>

            {% if task.is_some() %}
            <button type="button"
                    hx-post="/tasks/{{ task.as_ref().unwrap().id }}/run"
                    hx-target="#task-run-result"
                    hx-swap="innerHTML"
                    class="btn btn-success ml-auto">
                â–¶ Test Run
            </button>
            {% endif %}
        </div>

        <div id="task-run-result" class="mt-3"></div>
    </form>
</div>

<script>
function taskForm(isEditing) {
    // Get initial values from the form if editing
    const serverIdSelect = document.querySelector('[name="server_id"]');
    const pluginIdSelect = document.querySelector('[name="plugin_id"]');
    const scheduleInput = document.querySelector('[name="schedule"]');

    // Determine initial server selection
    let initialServerSelection = '';
    {% match task %}
    {% when Some with (t) %}
        {% match t.server_id %}
        {% when Some with (sid) %}
            initialServerSelection = '{{ sid }}';
        {% when None %}
            initialServerSelection = 'local';
        {% endmatch %}
    {% when None %}
    {% endmatch %}

    // Determine initial plugin selection
    let initialPluginSelection = '';
    {% match task %}
    {% when Some with (t) %}
        initialPluginSelection = '{{ t.plugin_id }}';
    {% when None %}
    {% endmatch %}

    return {
        serverSelection: isEditing && initialServerSelection ? initialServerSelection : (serverIdSelect?.value || ''),
        selectedPlugin: isEditing && initialPluginSelection ? initialPluginSelection : (pluginIdSelect?.value || ''),
        scheduleExpression: scheduleInput?.value || '0 */5 * * * *',
        submitting: false,

        init() {
            // Set initial values for select elements
            if (this.serverSelection && serverIdSelect) {
                serverIdSelect.value = this.serverSelection;
            }
            if (this.selectedPlugin && pluginIdSelect) {
                pluginIdSelect.value = this.selectedPlugin;
            }
        },

        get isLocalTask() {
            return this.serverSelection === 'local';
        },

        updateTaskType() {
            // Clear plugin selection when switching to remote
            if (!this.isLocalTask) {
                this.selectedPlugin = '';
            }
        },

        isValid() {
            if (!this.serverSelection) return false;
            if (this.isLocalTask && !this.selectedPlugin) return false;
            if (!this.scheduleExpression) return false;
            return true;
        },

        getNextRun() {
            // This is a simplified placeholder - actual cron parsing would be server-side
            try {
                const parts = this.scheduleExpression.split(' ');
                if (parts.length !== 6) return 'Invalid cron expression';

                // Rough estimate for display
                const minutes = parts[1];
                if (minutes.startsWith('*/')) {
                    const interval = minutes.slice(2);
                    return `Approximately every ${interval} minutes`;
                } else if (minutes === '0') {
                    return `At specific times (see schedule)`;
                }
                return 'See schedule above';
            } catch (e) {
                return 'Invalid expression';
            }
        },

        handleSubmit(event) {
            // Prevent double submission
            if (this.submitting) {
                event.preventDefault();
                return false;
            }
            this.submitting = true;
            console.log('Submitting task form');
        }
    };
}

// Handle form close event
document.addEventListener('close-form', () => {
    const formContainer = document.getElementById('task-form-container');
    if (formContainer) {
        formContainer.innerHTML = '';
    }
});
</script>

<style>
/* Alpine.js cloak - hide elements until Alpine initializes */
[x-cloak] {
    display: none !important;
}

/* Monospace inputs for technical content */
.monospace {
    font-family: ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas, monospace;
    font-size: 0.875rem;
}

/* Block-level small text */
.text-secondary.block {
    display: block;
    margin-top: 0.25rem;
}

/* Disabled/placeholder sections */
.form-group[style*="opacity: 0.5"] label {
    cursor: not-allowed;
}
</style>
