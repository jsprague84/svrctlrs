<div class="card">
    <h3>{% match step %}{% when Some with (_) %}Edit{% when None %}Add{% endmatch %} Job Step</h3>

    {% match error %}
    {% when Some with (e) %}
    <div class="alert alert-error">{{ e }}</div>
    {% when None %}
    {% endmatch %}

    {% match step %}
    {% when Some with (s) %}
    <form hx-put="/job-templates/{{ job_template_id }}/steps/{{ s.id }}"
          hx-target="#job-template-steps"
          hx-swap="innerHTML"
          x-data="{ selectedJobType: '{% match s.job_type_id %}{% when Some with (id) %}{{ id }}{% when None %}{% endmatch %}' }">

        <div class="form-group">
            <label for="name">Step Name *</label>
            <input type="text"
                   id="name"
                   name="name"
                   value="{{ s.name }}"
                   placeholder="Update Package Cache"
                   required>
        </div>

        <div class="form-group">
            <label for="job_type_id">Job Type (for filtering commands)</label>
            <select id="job_type_id"
                    x-model="selectedJobType">
                <option value="">All command templates</option>
                {% for job_type in job_types %}
                <option value="{{ job_type.id }}">
                    {{ job_type.display_name }}
                </option>
                {% endfor %}
            </select>
            <small class="text-secondary">Filter command templates by job type</small>
        </div>

        <div class="form-group">
            <label for="command_template_id">Command Template *</label>
            <select id="command_template_id"
                    name="command_template_id"
                    required
                    x-init="$el.value = '{{ s.command_template_id }}'">
                <option value="">Select a command...</option>
                {% for ct in command_templates %}
                <option value="{{ ct.id }}" data-job-type="{{ ct.job_type_id }}" x-show="!selectedJobType || selectedJobType == '' || selectedJobType == '{{ ct.job_type_id }}'">
                    {{ ct.display_name }}
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="step_order">Step Order *</label>
            <input type="number"
                   id="step_order"
                   name="step_order"
                   value="{{ s.step_order }}"
                   min="0"
                   required>
            <small class="text-secondary">Steps execute in order (0, 1, 2...)</small>
        </div>

        <div class="form-group">
            <label for="timeout_seconds">Timeout Override (seconds)</label>
            <input type="number"
                   id="timeout_seconds"
                   name="timeout_seconds"
                   {% match s.timeout_seconds %}{% when Some with (t) %}value="{{ t }}"{% when None %}{% endmatch %}
                   min="1"
                   placeholder="Use template default">
            <small class="text-secondary">Override job template timeout for this step</small>
        </div>

        <div class="form-group">
            <label class="flex gap-2 align-center" style="cursor: pointer;">
                <input type="checkbox"
                       id="continue_on_failure"
                       name="continue_on_failure"
                       {% if s.continue_on_failure %}checked{% endif %}>
                <span>Continue on Failure</span>
            </label>
            <small class="text-secondary">If checked, subsequent steps will run even if this step fails</small>
        </div>

        <div class="flex gap-2">
            <button type="submit" class="btn btn-primary">
                <i data-lucide="save" style="width: 16px; height: 16px;"></i> Save
            </button>
            <button type="button"
                    onclick="document.getElementById('job-step-form-container').innerHTML = ''"
                    class="btn btn-secondary">
                Cancel
            </button>
        </div>
    </form>
    {% when None %}
    <form hx-post="/job-templates/{{ job_template_id }}/steps"
          hx-target="#job-template-steps"
          hx-swap="innerHTML"
          x-data="{ selectedJobType: '' }">

        <div class="form-group">
            <label for="name">Step Name *</label>
            <input type="text"
                   id="name"
                   name="name"
                   placeholder="Update Package Cache"
                   required>
        </div>

        <div class="form-group">
            <label for="job_type_id">Job Type (for filtering commands)</label>
            <select id="job_type_id"
                    x-model="selectedJobType">
                <option value="">All command templates</option>
                {% for job_type in job_types %}
                <option value="{{ job_type.id }}">
                    {{ job_type.display_name }}
                </option>
                {% endfor %}
            </select>
            <small class="text-secondary">Filter command templates by job type</small>
        </div>

        <div class="form-group">
            <label for="command_template_id">Command Template *</label>
            <select id="command_template_id"
                    name="command_template_id"
                    required>
                <option value="">Select a command...</option>
                {% for ct in command_templates %}
                <option value="{{ ct.id }}" data-job-type="{{ ct.job_type_id }}" x-show="!selectedJobType || selectedJobType == '' || selectedJobType == '{{ ct.job_type_id }}'">
                    {{ ct.display_name }}
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="step_order">Step Order *</label>
            <input type="number"
                   id="step_order"
                   name="step_order"
                   value="{{ next_order_index }}"
                   min="0"
                   required>
            <small class="text-secondary">Steps execute in order (0, 1, 2...)</small>
        </div>

        <div class="form-group">
            <label for="timeout_seconds">Timeout Override (seconds)</label>
            <input type="number"
                   id="timeout_seconds"
                   name="timeout_seconds"
                   min="1"
                   placeholder="Use template default">
            <small class="text-secondary">Override job template timeout for this step</small>
        </div>

        <div class="form-group">
            <label class="flex gap-2 align-center" style="cursor: pointer;">
                <input type="checkbox"
                       id="continue_on_failure"
                       name="continue_on_failure">
                <span>Continue on Failure</span>
            </label>
            <small class="text-secondary">If checked, subsequent steps will run even if this step fails</small>
        </div>

        <div class="flex gap-2">
            <button type="submit" class="btn btn-primary">
                <i data-lucide="save" style="width: 16px; height: 16px;"></i> Save
            </button>
            <button type="button"
                    onclick="document.getElementById('job-step-form-container').innerHTML = ''"
                    class="btn btn-secondary">
                Cancel
            </button>
        </div>
    </form>
    {% endmatch %}
</div>
