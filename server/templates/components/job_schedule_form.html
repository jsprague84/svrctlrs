<div class="card"
     x-data="{
         templateId: {% match schedule %}{% when Some with (s) %}{{ s.job_template_id }}{% when None %}null{% endmatch %},
         templates: {{ job_templates|json|safe }},
         getTemplate() {
             if (!this.templateId) return null;
             return this.templates.find(t => t.id == this.templateId);
         }
     }">
    <h2>{% match schedule %}{% when Some with (_) %}Edit{% when None %}Add{% endmatch %} Schedule</h2>

    <!-- Help Link -->
    <div style="margin-bottom: 1rem; padding: 0.5rem; background: var(--bg); border: 1px solid var(--border); border-radius: 4px;">
        <div class="flex gap-2 align-center" style="font-size: 0.875rem;">
            <i data-lucide="book-open" style="width: 14px; height: 14px; color: var(--primary);"></i>
            <span>Need help with schedules and cron syntax?</span>
            <a href="https://github.com/jsprague84/svrctlrs/blob/develop/docs/JOBS.md#cron-schedule-syntax"
               target="_blank"
               style="color: var(--primary); text-decoration: none;">
                View Jobs & Schedules Guide
            </a>
            <i data-lucide="external-link" style="width: 12px; height: 12px; color: var(--primary);"></i>
        </div>
    </div>

    {% match error %}
    {% when Some with (e) %}
    <div class="alert alert-error">{{ e }}</div>
    {% when None %}
    {% endmatch %}

    {% match schedule %}
    {% when Some with (s) %}
    <form hx-put="/job-schedules/{{ s.id }}"
          hx-target="#schedule-list"
          hx-swap="innerHTML">

        <div class="form-group">
            <label for="name">Schedule Name *</label>
            <input type="text"
                   id="name"
                   name="name"
                   value="{{ s.name }}"
                   placeholder="Weekly Updates - Sundays at 2am"
                   required>
        </div>

        <div class="form-group">
            <label for="job_template_id">Job Template *</label>
            <select id="job_template_id"
                    name="job_template_id"
                    x-model="templateId"
                    required>
                {% for jt in job_templates %}
                <option value="{{ jt.id }}" {% if jt.id == s.job_template_id %}selected{% endif %}>
                    {{ jt.name }}
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="schedule">Cron Expression *</label>
            <input type="text"
                   id="schedule"
                   name="schedule"
                   value="{{ s.cron_expression }}"
                   placeholder="0 0 2 * * *"
                   required>
            <small class="text-secondary">
                Format: <code>second minute hour day month weekday</code><br>
                Examples: <code>0 0 2 * * *</code> (daily at 2am), <code>0 */5 * * * *</code> (every 5 min), <code>0 0 0 * * 1</code> (Mondays at midnight)
            </small>
        </div>

        <div class="form-group">
            <label class="flex gap-2 align-center" style="cursor: pointer;">
                <input type="checkbox"
                       id="enabled"
                       name="enabled"
                       {% if s.enabled %}checked{% endif %}>
                <span>Schedule Enabled</span>
            </label>
        </div>

        <h4 class="mt-3" style="border-top: 1px solid var(--border); padding-top: 1rem;">Override Template Defaults (Optional)</h4>
        <p class="text-secondary mb-2" style="font-size: 0.875rem;">Leave fields empty to use the job template's default values.</p>

        <div class="grid grid-2 gap-2">
            <div class="form-group">
                <label for="timeout_seconds">Timeout (seconds)</label>
                <input type="number"
                       id="timeout_seconds"
                       name="timeout_seconds"
                       min="1"
                       value="{% match s.timeout_seconds %}{% when Some with (t) %}{{ t }}{% when None %}{% endmatch %}"
                       placeholder="Template default">
                <small class="text-secondary" x-show="getTemplate()">
                    Template default: <span x-text="getTemplate() ? getTemplate().timeout_seconds + 's' : ''"></span>
                </small>
            </div>

            <div class="form-group">
                <label for="retry_count">Retry Count</label>
                <input type="number"
                       id="retry_count"
                       name="retry_count"
                       min="0"
                       value="{% match s.retry_count %}{% when Some with (r) %}{{ r }}{% when None %}{% endmatch %}"
                       placeholder="Template default">
                <small class="text-secondary" x-show="getTemplate()">
                    Template default: <span x-text="getTemplate() ? getTemplate().retry_count : ''"></span>
                </small>
            </div>
        </div>

        <div class="grid grid-2 gap-2 mt-2">
            <div class="form-group">
                <label class="flex gap-2 align-center" style="cursor: pointer;">
                    <input type="checkbox"
                           id="notify_on_success"
                           name="notify_on_success"
                           {% match s.notify_on_success %}{% when Some with (v) %}{% if v %}checked{% endif %}{% when None %}{% endmatch %}>
                    <span>Notify on Success</span>
                </label>
                <small class="text-secondary" x-show="getTemplate()">
                    Template default: <span x-text="getTemplate() ? (getTemplate().notify_on_success ? 'Yes' : 'No') : ''"></span>
                </small>
            </div>

            <div class="form-group">
                <label class="flex gap-2 align-center" style="cursor: pointer;">
                    <input type="checkbox"
                           id="notify_on_failure"
                           name="notify_on_failure"
                           {% match s.notify_on_failure %}{% when Some with (v) %}{% if v %}checked{% endif %}{% when None %}{% endmatch %}>
                    <span>Notify on Failure</span>
                </label>
                <small class="text-secondary" x-show="getTemplate()">
                    Template default: <span x-text="getTemplate() ? (getTemplate().notify_on_failure ? 'Yes' : 'No') : ''"></span>
                </small>
            </div>
        </div>

        <div class="flex gap-2 mt-3">
            <button type="submit" class="btn btn-primary">
                <i data-lucide="save" style="width: 16px; height: 16px;"></i> Save
            </button>
            <button type="button"
                    onclick="document.getElementById('schedule-form-container').innerHTML = ''"
                    class="btn btn-secondary">
                Cancel
            </button>
        </div>
    </form>
    {% when None %}
    <form hx-post="/job-schedules"
          hx-target="#schedule-list"
          hx-swap="innerHTML">

        <div class="form-group">
            <label for="name">Schedule Name *</label>
            <input type="text"
                   id="name"
                   name="name"
                   placeholder="Weekly Updates - Sundays at 2am"
                   required>
        </div>

        <div class="form-group">
            <label for="job_template_id">Job Template *</label>
            <select id="job_template_id"
                    name="job_template_id"
                    x-model="templateId"
                    required>
                <option value="">Select a job template...</option>
                {% for jt in job_templates %}
                <option value="{{ jt.id }}">
                    {{ jt.name }}
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="server_id">Server *</label>
            <select id="server_id"
                    name="server_id"
                    required>
                <option value="">Select a server...</option>
                {% for server in servers %}
                <option value="{{ server.id }}">{{ server.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="schedule">Cron Expression *</label>
            <input type="text"
                   id="schedule"
                   name="schedule"
                   placeholder="0 0 2 * * *"
                   required>
            <small class="text-secondary">
                Format: <code>second minute hour day month weekday</code><br>
                Examples: <code>0 0 2 * * *</code> (daily at 2am), <code>0 */5 * * * *</code> (every 5 min), <code>0 0 0 * * 1</code> (Mondays at midnight)
            </small>
        </div>

        <div class="form-group">
            <label for="description">Description (optional)</label>
            <textarea id="description"
                      name="description"
                      rows="2"
                      placeholder="Optional description..."></textarea>
        </div>

        <div class="form-group">
            <label class="flex gap-2 align-center" style="cursor: pointer;">
                <input type="checkbox"
                       id="enabled"
                       name="enabled"
                       checked>
                <span>Schedule Enabled</span>
            </label>
        </div>

        <h4 class="mt-3" style="border-top: 1px solid var(--border); padding-top: 1rem;">Override Template Defaults (Optional)</h4>
        <p class="text-secondary mb-2" style="font-size: 0.875rem;">Leave fields empty to use the job template's default values.</p>

        <div class="grid grid-2 gap-2">
            <div class="form-group">
                <label for="timeout_seconds">Timeout (seconds)</label>
                <input type="number"
                       id="timeout_seconds"
                       name="timeout_seconds"
                       min="1"
                       placeholder="Template default">
                <small class="text-secondary" x-show="getTemplate()">
                    Template default: <span x-text="getTemplate() ? getTemplate().timeout_seconds + 's' : ''"></span>
                </small>
            </div>

            <div class="form-group">
                <label for="retry_count">Retry Count</label>
                <input type="number"
                       id="retry_count"
                       name="retry_count"
                       min="0"
                       placeholder="Template default">
                <small class="text-secondary" x-show="getTemplate()">
                    Template default: <span x-text="getTemplate() ? getTemplate().retry_count : ''"></span>
                </small>
            </div>
        </div>

        <div class="grid grid-2 gap-2 mt-2">
            <div class="form-group">
                <label class="flex gap-2 align-center" style="cursor: pointer;">
                    <input type="checkbox"
                           id="notify_on_success"
                           name="notify_on_success">
                    <span>Notify on Success</span>
                </label>
                <small class="text-secondary" x-show="getTemplate()">
                    Template default: <span x-text="getTemplate() ? (getTemplate().notify_on_success ? 'Yes' : 'No') : ''"></span>
                </small>
            </div>

            <div class="form-group">
                <label class="flex gap-2 align-center" style="cursor: pointer;">
                    <input type="checkbox"
                           id="notify_on_failure"
                           name="notify_on_failure">
                    <span>Notify on Failure</span>
                </label>
                <small class="text-secondary" x-show="getTemplate()">
                    Template default: <span x-text="getTemplate() ? (getTemplate().notify_on_failure ? 'Yes' : 'No') : ''"></span>
                </small>
            </div>
        </div>

        <div class="flex gap-2 mt-3">
            <button type="submit" class="btn btn-primary">
                <i data-lucide="save" style="width: 16px; height: 16px;"></i> Save
            </button>
            <button type="button"
                    onclick="document.getElementById('schedule-form-container').innerHTML = ''"
                    class="btn btn-secondary">
                Cancel
            </button>
        </div>
    </form>
    {% endmatch %}
</div>
