<div class="card" x-data="{ scopeType: '{% match policy %}{% when Some with (p) %}{{ p.scope_type }}{% when None %}all_jobs{% endmatch %}' }">
    <h2>{% match policy %}{% when Some with (_) %}Edit{% when None %}Add{% endmatch %} Notification Policy</h2>

    {% match error %}
    {% when Some with (e) %}
    <div class="alert alert-error">{{ e }}</div>
    {% when None %}
    {% endmatch %}

    {% match policy %}
    {% when Some with (p) %}
    <form hx-put="/settings/notifications/policies/{{ p.id }}"
          hx-target="#policy-list"
          hx-swap="innerHTML">

        <div class="form-group">
            <label for="name">Policy Name *</label>
            <input type="text"
                   id="name"
                   name="name"
                   value="{{ p.name }}"
                   placeholder="Alert on Update Failures"
                   required>
        </div>

        <div class="form-group">
            <label>Notification Channels *</label>
            <small style="color: var(--text-secondary); display: block; margin-bottom: 0.5rem;">
                Select one or more channels to send notifications to
            </small>
            <div style="max-height: 150px; overflow-y: auto; border: 1px solid var(--border); border-radius: 4px; padding: 0.5rem;">
                {% for channel in channels %}
                <label class="flex gap-2 align-center mb-1" style="cursor: pointer;">
                    <input type="checkbox"
                           name="channel_ids"
                           value="{{ channel.id }}"
                           {% if p.policy_channels | length > 0 %}
                               x-init="if ({{ p.policy_channels | json }}.some(c => c.channel_id === {{ channel.id }})) $el.checked = true"
                           {% endif %}>
                    <span>{{ channel.name }}</span>
                </label>
                {% endfor %}
            </div>
        </div>

        <div class="form-group">
            <label for="scope_type">Policy Scope *</label>
            <select id="scope_type"
                    name="scope_type"
                    x-model="scopeType"
                    required>
                <option value="all_jobs">All Jobs</option>
                <option value="specific_job_templates">Specific Job Templates</option>
                <option value="job_type">All Jobs of a Specific Type</option>
            </select>
        </div>

        <div class="form-group" x-show="scopeType === 'specific_job_templates'">
            <label>Select Job Templates</label>
            <div style="max-height: 150px; overflow-y: auto; border: 1px solid var(--border); border-radius: 4px; padding: 0.5rem;">
                {% for jt in job_templates %}
                <label class="flex gap-2 align-center mb-1" style="cursor: pointer;">
                    <input type="checkbox"
                           name="job_template_ids"
                           value="{{ jt.id }}"
                           x-init="if ({{ p.job_templates | json }}.includes('{{ jt.name }}')) $el.checked = true">
                    <span>{{ jt.name }}</span>
                </label>
                {% endfor %}
            </div>
        </div>

        <div class="form-group" x-show="scopeType === 'job_type'">
            <label for="job_type_id">Job Type</label>
            <select id="job_type_id"
                    name="job_type_id"
                    :required="scopeType === 'job_type'"
                    {% match p.job_type_id %}{% when Some with (jtid) %}x-init="$el.value = '{{ jtid }}'"{% when None %}{% endmatch %}>
                <option value="">Select a job type...</option>
                {% for jt in job_types %}
                <option value="{{ jt.id }}">
                    {{ jt.name }}
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label>Notify On</label>
            <div style="border: 1px solid var(--border); border-radius: 4px; padding: 0.5rem;">
                <label class="flex gap-2 align-center mb-1" style="cursor: pointer;">
                    <input type="checkbox"
                           name="on_success"
                           {% if p.on_success %}checked{% endif %}>
                    <span>Job Success</span>
                </label>
                <label class="flex gap-2 align-center mb-1" style="cursor: pointer;">
                    <input type="checkbox"
                           name="on_failure"
                           {% if p.on_failure %}checked{% endif %}>
                    <span>Job Failure</span>
                </label>
                <label class="flex gap-2 align-center" style="cursor: pointer;">
                    <input type="checkbox"
                           name="on_timeout"
                           {% if p.on_timeout %}checked{% endif %}>
                    <span>Job Timeout</span>
                </label>
            </div>
        </div>

        <div class="form-group">
            <label for="description">Description (optional)</label>
            <textarea id="description"
                      name="description"
                      rows="2"
                      placeholder="What this policy does">{% match p.description %}{% when Some with (d) %}{{ d }}{% when None %}{% endmatch %}</textarea>
        </div>

        <!-- Message Templates -->
        <div class="card" style="background: var(--bg-secondary); margin: 1rem 0;">
            <h3 style="margin-bottom: 0.5rem;">Message Templates</h3>
            <p class="text-secondary" style="font-size: 0.875rem; margin-bottom: 1rem;">
                Customize notification messages using template variables. Available variables:
                <code>job_name</code>, <code>job_type</code>, <code>status</code>, <code>server_name</code>,
                <code>started_at</code>, <code>finished_at</code>, <code>duration</code>, <code>success_count</code>,
                <code>failed_count</code>, <code>total_servers</code>
            </p>

            <div class="form-group">
                <label for="title_template">Title Template</label>
                <input type="text"
                       id="title_template"
                       name="title_template"
                       value="{% match p.title_template %}{% when Some with (t) %}{{ t }}{% when None %}{% endmatch %}"
                       placeholder="[&#123;&#123;status&#125;&#125;] &#123;&#123;job_name&#125;&#125; on &#123;&#123;server_name&#125;&#125;">
                <small class="text-secondary">Leave empty for default title</small>
            </div>

            <div class="form-group">
                <label for="body_template">Body Template</label>
                <textarea id="body_template"
                          name="body_template"
                          rows="4"
                          placeholder="Job: &#123;&#123;job_name&#125;&#125;&#10;Status: &#123;&#123;status&#125;&#125;&#10;Server: &#123;&#123;server_name&#125;&#125;&#10;Time: &#123;&#123;finished_at&#125;&#125;&#10;Duration: &#123;&#123;duration&#125;&#125;s">{% match p.body_template %}{% when Some with (b) %}{{ b }}{% when None %}{% endmatch %}</textarea>
                <small class="text-secondary">Leave empty for default message</small>
            </div>

            <!-- Example Templates Dropdown -->
            <details style="margin-top: 0.5rem;">
                <summary style="cursor: pointer; color: var(--primary); font-size: 0.875rem;">
                    <i data-lucide="lightbulb" style="width: 14px; height: 14px;"></i> View Example Templates
                </summary>
                <div style="margin-top: 0.5rem; padding: 0.5rem; background: var(--bg); border-radius: 4px;">
                    <p style="font-size: 0.875rem; margin-bottom: 0.5rem;"><strong>Success:</strong></p>
                    <code style="display: block; padding: 0.5rem; background: var(--bg-tertiary); border-radius: 4px; font-size: 0.75rem;">
                        Title: ✅ &#123;&#123;job_name&#125;&#125; completed<br>
                        Body: Successfully ran on &#123;&#123;success_count&#125;&#125;/&#123;&#123;total_servers&#125;&#125; servers in &#123;&#123;duration&#125;&#125;s
                    </code>

                    <p style="font-size: 0.875rem; margin: 0.5rem 0;"><strong>Failure:</strong></p>
                    <code style="display: block; padding: 0.5rem; background: var(--bg-tertiary); border-radius: 4px; font-size: 0.75rem;">
                        Title: ❌ &#123;&#123;job_name&#125;&#125; failed on &#123;&#123;server_name&#125;&#125;<br>
                        Body: Job: &#123;&#123;job_name&#125;&#125;\nServer: &#123;&#123;server_name&#125;&#125;\nStarted: &#123;&#123;started_at&#125;&#125;\nStatus: &#123;&#123;status&#125;&#125;
                    </code>

                    <p style="font-size: 0.875rem; margin: 0.5rem 0;"><strong>Partial:</strong></p>
                    <code style="display: block; padding: 0.5rem; background: var(--bg-tertiary); border-radius: 4px; font-size: 0.75rem;">
                        Title: ⚠️  &#123;&#123;job_name&#125;&#125; partial success<br>
                        Body: &#123;&#123;success_count&#125;&#125; succeeded, &#123;&#123;failed_count&#125;&#125; failed of &#123;&#123;total_servers&#125;&#125; servers
                    </code>
                </div>
            </details>
        </div>

        <!-- Advanced Filtering -->
        <div class="card" style="background: var(--bg-secondary); margin: 1rem 0;">
            <h3 style="margin-bottom: 0.5rem;">Advanced Filtering</h3>
            <p class="text-secondary" style="font-size: 0.875rem; margin-bottom: 1rem;">
                Optionally filter which jobs trigger this policy. Leave empty to apply to all jobs matching the scope above.
            </p>

            <div class="form-group">
                <label for="job_type_filter_select">Filter by Job Type</label>
                <select id="job_type_filter_select" multiple size="4" style="width: 100%;">
                    {% for jt in job_types %}
                    <option value="{{ jt.name }}">{{ jt.name }}</option>
                    {% endfor %}
                </select>
                <input type="hidden" id="job_type_filter" name="job_type_filter" value="">
                <small class="text-secondary">Hold Ctrl/Cmd to select multiple</small>
            </div>

            <div class="form-group">
                <label for="server_filter_select">Filter by Server</label>
                <select id="server_filter_select" multiple size="4" style="width: 100%;">
                    {% for server in servers %}
                    <option value="{{ server.id }}">{{ server.name }}</option>
                    {% endfor %}
                </select>
                <input type="hidden" id="server_filter" name="server_filter" value="">
                <small class="text-secondary">Hold Ctrl/Cmd to select multiple</small>
            </div>

            <div class="form-group">
                <label for="tag_filter_select">Filter by Tag</label>
                <select id="tag_filter_select" multiple size="4" style="width: 100%;">
                    {% for tag in tags %}
                    <option value="{{ tag.name }}">{{ tag.name }}</option>
                    {% endfor %}
                </select>
                <input type="hidden" id="tag_filter" name="tag_filter" value="">
                <small class="text-secondary">Hold Ctrl/Cmd to select multiple</small>
            </div>

            <script>
                // Sync multi-select to hidden comma-separated input
                document.getElementById('job_type_filter_select').addEventListener('change', function() {
                    const selected = Array.from(this.selectedOptions).map(opt => opt.value);
                    document.getElementById('job_type_filter').value = selected.join(',');
                });
                document.getElementById('server_filter_select').addEventListener('change', function() {
                    const selected = Array.from(this.selectedOptions).map(opt => opt.value);
                    document.getElementById('server_filter').value = selected.join(',');
                });
                document.getElementById('tag_filter_select').addEventListener('change', function() {
                    const selected = Array.from(this.selectedOptions).map(opt => opt.value);
                    document.getElementById('tag_filter').value = selected.join(',');
                });
            </script>
        </div>

        <!-- Throttling & Severity -->
        <div class="card" style="background: var(--bg-secondary); margin: 1rem 0;">
            <h3 style="margin-bottom: 0.5rem;">Throttling & Severity</h3>
            <p class="text-secondary" style="font-size: 0.875rem; margin-bottom: 1rem;">
                Control notification frequency and priority.
            </p>

            <div class="form-group">
                <label for="min_severity">Minimum Severity (1-5)</label>
                <input type="number"
                       id="min_severity"
                       name="min_severity"
                       min="1"
                       max="5"
                       value="{% match p.min_severity %}{% when Some with (s) %}{{ s }}{% when None %}1{% endmatch %}"
                       placeholder="1">
                <small class="text-secondary">Only notify if job severity is >= this value (1=lowest, 5=highest)</small>
            </div>

            <div class="form-group">
                <label for="max_per_hour">Max Notifications Per Hour</label>
                <input type="number"
                       id="max_per_hour"
                       name="max_per_hour"
                       min="1"
                       value="{% match p.max_per_hour %}{% when Some with (m) %}{{ m }}{% when None %}{% endmatch %}"
                       placeholder="Unlimited">
                <small class="text-secondary">Leave empty for unlimited. Prevents notification spam.</small>
            </div>
        </div>

        <div class="form-group">
            <label class="flex gap-2 align-center" style="cursor: pointer;">
                <input type="checkbox"
                       id="enabled"
                       name="enabled"
                       {% if p.enabled %}checked{% endif %}>
                <span>Policy Enabled</span>
            </label>
        </div>

        <div class="flex gap-2">
            <button type="submit" class="btn btn-primary">
                <i data-lucide="save" style="width: 16px; height: 16px;"></i> Save
            </button>
            <button type="button"
                    onclick="document.getElementById('policy-form-container').innerHTML = ''"
                    class="btn btn-secondary">
                Cancel
            </button>
        </div>
    </form>
    {% when None %}
    <form hx-post="/settings/notifications/policies"
          hx-target="#policy-list"
          hx-swap="innerHTML">

        <div class="form-group">
            <label for="name">Policy Name *</label>
            <input type="text"
                   id="name"
                   name="name"
                   placeholder="Alert on Update Failures"
                   required>
        </div>

        <div class="form-group">
            <label>Notification Channels *</label>
            <small style="color: var(--text-secondary); display: block; margin-bottom: 0.5rem;">
                Select one or more channels to send notifications to
            </small>
            <div style="max-height: 150px; overflow-y: auto; border: 1px solid var(--border); border-radius: 4px; padding: 0.5rem;">
                {% for channel in channels %}
                <label class="flex gap-2 align-center mb-1" style="cursor: pointer;">
                    <input type="checkbox"
                           name="channel_ids"
                           value="{{ channel.id }}">
                    <span>{{ channel.name }}</span>
                </label>
                {% endfor %}
            </div>
        </div>

        <div class="form-group">
            <label for="scope_type">Policy Scope *</label>
            <select id="scope_type"
                    name="scope_type"
                    x-model="scopeType"
                    required>
                <option value="all_jobs">All Jobs</option>
                <option value="specific_job_templates">Specific Job Templates</option>
                <option value="job_type">All Jobs of a Specific Type</option>
            </select>
        </div>

        <div class="form-group" x-show="scopeType === 'specific_job_templates'">
            <label>Select Job Templates</label>
            <div style="max-height: 150px; overflow-y: auto; border: 1px solid var(--border); border-radius: 4px; padding: 0.5rem;">
                {% for jt in job_templates %}
                <label class="flex gap-2 align-center mb-1" style="cursor: pointer;">
                    <input type="checkbox"
                           name="job_template_ids"
                           value="{{ jt.id }}">
                    <span>{{ jt.name }}</span>
                </label>
                {% endfor %}
            </div>
        </div>

        <div class="form-group" x-show="scopeType === 'job_type'">
            <label for="job_type_id">Job Type</label>
            <select id="job_type_id"
                    name="job_type_id"
                    :required="scopeType === 'job_type'">
                <option value="">Select a job type...</option>
                {% for jt in job_types %}
                <option value="{{ jt.id }}">
                    {{ jt.name }}
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label>Notify On</label>
            <div style="border: 1px solid var(--border); border-radius: 4px; padding: 0.5rem;">
                <label class="flex gap-2 align-center mb-1" style="cursor: pointer;">
                    <input type="checkbox"
                           name="on_success">
                    <span>Job Success</span>
                </label>
                <label class="flex gap-2 align-center mb-1" style="cursor: pointer;">
                    <input type="checkbox"
                           name="on_failure"
                           checked>
                    <span>Job Failure</span>
                </label>
                <label class="flex gap-2 align-center" style="cursor: pointer;">
                    <input type="checkbox"
                           name="on_timeout"
                           checked>
                    <span>Job Timeout</span>
                </label>
            </div>
        </div>

        <div class="form-group">
            <label for="description">Description (optional)</label>
            <textarea id="description"
                      name="description"
                      rows="2"
                      placeholder="What this policy does"></textarea>
        </div>

        <!-- Message Templates -->
        <div class="card" style="background: var(--bg-secondary); margin: 1rem 0;">
            <h3 style="margin-bottom: 0.5rem;">Message Templates</h3>
            <p class="text-secondary" style="font-size: 0.875rem; margin-bottom: 1rem;">
                Customize notification messages using template variables. Available variables:
                <code>job_name</code>, <code>job_type</code>, <code>status</code>, <code>server_name</code>,
                <code>started_at</code>, <code>finished_at</code>, <code>duration</code>, <code>success_count</code>,
                <code>failed_count</code>, <code>total_servers</code>
            </p>

            <div class="form-group">
                <label for="title_template">Title Template</label>
                <input type="text"
                       id="title_template"
                       name="title_template"
                       placeholder="[&#123;&#123;status&#125;&#125;] &#123;&#123;job_name&#125;&#125; on &#123;&#123;server_name&#125;&#125;">
                <small class="text-secondary">Leave empty for default title</small>
            </div>

            <div class="form-group">
                <label for="body_template">Body Template</label>
                <textarea id="body_template"
                          name="body_template"
                          rows="4"
                          placeholder="Job: &#123;&#123;job_name&#125;&#125;&#10;Status: &#123;&#123;status&#125;&#125;&#10;Server: &#123;&#123;server_name&#125;&#125;&#10;Time: &#123;&#123;finished_at&#125;&#125;&#10;Duration: &#123;&#123;duration&#125;&#125;s"></textarea>
                <small class="text-secondary">Leave empty for default message</small>
            </div>

            <!-- Example Templates Dropdown -->
            <details style="margin-top: 0.5rem;">
                <summary style="cursor: pointer; color: var(--primary); font-size: 0.875rem;">
                    <i data-lucide="lightbulb" style="width: 14px; height: 14px;"></i> View Example Templates
                </summary>
                <div style="margin-top: 0.5rem; padding: 0.5rem; background: var(--bg); border-radius: 4px;">
                    <p style="font-size: 0.875rem; margin-bottom: 0.5rem;"><strong>Success:</strong></p>
                    <code style="display: block; padding: 0.5rem; background: var(--bg-tertiary); border-radius: 4px; font-size: 0.75rem;">
                        Title: ✅ &#123;&#123;job_name&#125;&#125; completed<br>
                        Body: Successfully ran on &#123;&#123;success_count&#125;&#125;/&#123;&#123;total_servers&#125;&#125; servers in &#123;&#123;duration&#125;&#125;s
                    </code>

                    <p style="font-size: 0.875rem; margin: 0.5rem 0;"><strong>Failure:</strong></p>
                    <code style="display: block; padding: 0.5rem; background: var(--bg-tertiary); border-radius: 4px; font-size: 0.75rem;">
                        Title: ❌ &#123;&#123;job_name&#125;&#125; failed on &#123;&#123;server_name&#125;&#125;<br>
                        Body: Job: &#123;&#123;job_name&#125;&#125;\nServer: &#123;&#123;server_name&#125;&#125;\nStarted: &#123;&#123;started_at&#125;&#125;\nStatus: &#123;&#123;status&#125;&#125;
                    </code>

                    <p style="font-size: 0.875rem; margin: 0.5rem 0;"><strong>Partial:</strong></p>
                    <code style="display: block; padding: 0.5rem; background: var(--bg-tertiary); border-radius: 4px; font-size: 0.75rem;">
                        Title: ⚠️  &#123;&#123;job_name&#125;&#125; partial success<br>
                        Body: &#123;&#123;success_count&#125;&#125; succeeded, &#123;&#123;failed_count&#125;&#125; failed of &#123;&#123;total_servers&#125;&#125; servers
                    </code>
                </div>
            </details>
        </div>

        <!-- Advanced Filtering -->
        <div class="card" style="background: var(--bg-secondary); margin: 1rem 0;">
            <h3 style="margin-bottom: 0.5rem;">Advanced Filtering</h3>
            <p class="text-secondary" style="font-size: 0.875rem; margin-bottom: 1rem;">
                Optionally filter which jobs trigger this policy. Leave empty to apply to all jobs matching the scope above.
            </p>

            <div class="form-group">
                <label for="job_type_filter_select_new">Filter by Job Type</label>
                <select id="job_type_filter_select_new" multiple size="4" style="width: 100%;">
                    {% for jt in job_types %}
                    <option value="{{ jt.name }}">{{ jt.name }}</option>
                    {% endfor %}
                </select>
                <input type="hidden" id="job_type_filter_new" name="job_type_filter" value="">
                <small class="text-secondary">Hold Ctrl/Cmd to select multiple</small>
            </div>

            <div class="form-group">
                <label for="server_filter_select_new">Filter by Server</label>
                <select id="server_filter_select_new" multiple size="4" style="width: 100%;">
                    {% for server in servers %}
                    <option value="{{ server.id }}">{{ server.name }}</option>
                    {% endfor %}
                </select>
                <input type="hidden" id="server_filter_new" name="server_filter" value="">
                <small class="text-secondary">Hold Ctrl/Cmd to select multiple</small>
            </div>

            <div class="form-group">
                <label for="tag_filter_select_new">Filter by Tag</label>
                <select id="tag_filter_select_new" multiple size="4" style="width: 100%;">
                    {% for tag in tags %}
                    <option value="{{ tag.name }}">{{ tag.name }}</option>
                    {% endfor %}
                </select>
                <input type="hidden" id="tag_filter_new" name="tag_filter" value="">
                <small class="text-secondary">Hold Ctrl/Cmd to select multiple</small>
            </div>

            <script>
                // Sync multi-select to hidden comma-separated input (new form)
                document.getElementById('job_type_filter_select_new').addEventListener('change', function() {
                    const selected = Array.from(this.selectedOptions).map(opt => opt.value);
                    document.getElementById('job_type_filter_new').value = selected.join(',');
                });
                document.getElementById('server_filter_select_new').addEventListener('change', function() {
                    const selected = Array.from(this.selectedOptions).map(opt => opt.value);
                    document.getElementById('server_filter_new').value = selected.join(',');
                });
                document.getElementById('tag_filter_select_new').addEventListener('change', function() {
                    const selected = Array.from(this.selectedOptions).map(opt => opt.value);
                    document.getElementById('tag_filter_new').value = selected.join(',');
                });
            </script>
        </div>

        <!-- Throttling & Severity -->
        <div class="card" style="background: var(--bg-secondary); margin: 1rem 0;">
            <h3 style="margin-bottom: 0.5rem;">Throttling & Severity</h3>
            <p class="text-secondary" style="font-size: 0.875rem; margin-bottom: 1rem;">
                Control notification frequency and priority.
            </p>

            <div class="form-group">
                <label for="min_severity_new">Minimum Severity (1-5)</label>
                <input type="number"
                       id="min_severity_new"
                       name="min_severity"
                       min="1"
                       max="5"
                       value="1"
                       placeholder="1">
                <small class="text-secondary">Only notify if job severity is >= this value (1=lowest, 5=highest)</small>
            </div>

            <div class="form-group">
                <label for="max_per_hour_new">Max Notifications Per Hour</label>
                <input type="number"
                       id="max_per_hour_new"
                       name="max_per_hour"
                       min="1"
                       placeholder="Unlimited">
                <small class="text-secondary">Leave empty for unlimited. Prevents notification spam.</small>
            </div>
        </div>

        <div class="form-group">
            <label class="flex gap-2 align-center" style="cursor: pointer;">
                <input type="checkbox"
                       id="enabled"
                       name="enabled"
                       checked>
                <span>Policy Enabled</span>
            </label>
        </div>

        <div class="flex gap-2">
            <button type="submit" class="btn btn-primary">
                <i data-lucide="save" style="width: 16px; height: 16px;"></i> Save
            </button>
            <button type="button"
                    onclick="document.getElementById('policy-form-container').innerHTML = ''"
                    class="btn btn-secondary">
                Cancel
            </button>
        </div>
    </form>
    {% endmatch %}
</div>
