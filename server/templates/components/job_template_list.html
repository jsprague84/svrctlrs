{% if job_templates.is_empty() %}
<div class="card">
    <p class="text-secondary">No job templates configured yet. Click "Add Job Template" to get started.</p>
</div>
{% else %}
<div class="grid grid-2">
    {% for jt in job_templates %}
    <div class="card" id="job-template-{{ jt.id }}" x-data="{ stepCount: {{ jt.step_count }} }">
        <div class="card-header">
            <h3 class="card-title">{{ jt.name }}</h3>
            <span class="badge badge-info">{{ jt.job_type_name }}</span>
        </div>

        {% match jt.description %}
        {% when Some with (d) %}
        <p class="text-secondary">{{ d }}</p>
        {% when None %}
        {% endmatch %}

        <div class="text-secondary mb-2">
            <strong>Type:</strong>
            {% if jt.is_composite %}
                <span>Composite Job (<span x-text="stepCount"></span> steps)</span>
            {% else %}
                Simple Job
            {% endif %}
        </div>

        <div class="text-secondary mb-2">
            <strong>Schedules:</strong> {{ jt.schedule_count }}
        </div>

        {% if jt.is_composite %}
        <div class="text-secondary mb-2">
            <strong>Steps:</strong> <span x-text="stepCount"></span>
        </div>
        {% endif %}

        <div class="flex gap-2 mt-2">
            <button hx-get="/job-templates/{{ jt.id }}/edit"
                    hx-target="#job-template-form-container"
                    hx-swap="innerHTML"
                    class="btn btn-sm btn-secondary">
                <i data-lucide="pencil" style="width: 14px; height: 14px;"></i> Edit
            </button>

            {% if jt.is_composite %}
            <button hx-get="/job-templates/{{ jt.id }}/steps"
                    hx-target="#job-template-steps-{{ jt.id }}"
                    hx-swap="innerHTML"
                    class="btn btn-sm btn-info"
                    @htmx:after-swap="stepCount = document.querySelectorAll('#job-template-steps-{{ jt.id }} .card[id^=job-step-]').length">
                <i data-lucide="list" style="width: 14px; height: 14px;"></i> Manage Steps (<span x-text="stepCount"></span>)
            </button>
            {% endif %}

            <button hx-post="/job-templates/{{ jt.id }}/run"
                    hx-target="#job-template-message-{{ jt.id }}"
                    hx-swap="innerHTML"
                    class="btn btn-sm btn-primary">
                <i data-lucide="play" style="width: 14px; height: 14px;"></i> Run Now
            </button>

            {% if jt.schedule_count == 0 %}
            <button hx-delete="/job-templates/{{ jt.id }}"
                    hx-target="#job-template-{{ jt.id }}"
                    hx-swap="outerHTML"
                    hx-confirm="Delete job template '{{ jt.name }}'?"
                    class="btn btn-sm btn-danger">
                <i data-lucide="trash-2" style="width: 14px; height: 14px;"></i> Delete
            </button>
            {% else %}
            <button disabled
                    class="btn btn-sm btn-secondary"
                    title="Cannot delete - in use by {{ jt.schedule_count }} schedule(s)">
                <i data-lucide="trash-2" style="width: 14px; height: 14px;"></i> Delete
            </button>
            {% endif %}
        </div>

        <!-- Container for messages (Run Now, errors, etc.) -->
        <div id="job-template-message-{{ jt.id }}" class="mt-2"></div>

        {% if jt.is_composite %}
        <!-- Container for step management UI -->
        <div id="job-template-steps-{{ jt.id }}" class="mt-3"></div>
        {% endif %}
    </div>
    {% endfor %}
</div>
{% endif %}
