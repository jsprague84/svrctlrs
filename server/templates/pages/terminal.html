{% extends "base.html" %}

{% block title %}Terminal - SvrCtlRS{% endblock %}
{% block nav_terminal %}active{% endblock %}

{% block head %}
<style>
    .debug-container {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 100px);
        gap: 12px;
    }

    .debug-toolbar {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
    }

    .debug-layout-btns {
        display: flex;
        gap: 4px;
    }

    .debug-layout-btns button {
        padding: 6px 10px;
        border: 1px solid var(--border-color);
        background: var(--bg-secondary);
        color: var(--text-secondary);
        cursor: pointer;
        border-radius: 4px;
        font-size: 12px;
    }

    .debug-layout-btns button.active {
        background: var(--accent-color);
        color: var(--bg-primary);
        border-color: var(--accent-color);
    }

    .terminals-grid {
        display: grid;
        gap: 12px;
        flex: 1;
        min-height: 0;
    }

    .terminals-grid.layout-1 {
        grid-template-columns: 1fr;
        grid-template-rows: 1fr;
    }

    .terminals-grid.layout-2h {
        grid-template-columns: 1fr 1fr;
        grid-template-rows: 1fr;
    }

    .terminals-grid.layout-2v {
        grid-template-columns: 1fr;
        grid-template-rows: 1fr 1fr;
    }

    .terminals-grid.layout-4 {
        grid-template-columns: 1fr 1fr;
        grid-template-rows: 1fr 1fr;
    }

    .terminal-pane {
        display: flex;
        flex-direction: column;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        overflow: hidden;
        min-height: 300px;
    }

    /* Terminal tabs bar */
    .terminal-tabs-bar {
        display: flex;
        align-items: center;
        gap: 2px;
        padding: 4px 8px;
        background: var(--bg-tertiary);
        border-bottom: 1px solid var(--border-color);
        overflow-x: auto;
        flex-shrink: 0;
    }

    .terminal-tab {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        background: transparent;
        border: 1px solid transparent;
        border-radius: 4px;
        color: var(--text-secondary);
        font-size: 11px;
        cursor: pointer;
        white-space: nowrap;
    }

    .terminal-tab:hover {
        background: var(--bg-secondary);
    }

    .terminal-tab.active {
        background: var(--bg-primary);
        border-color: var(--border-color);
        color: var(--text-primary);
    }

    .terminal-tab .tab-close {
        padding: 2px;
        border-radius: 3px;
        opacity: 0.6;
    }

    .terminal-tab .tab-close:hover {
        opacity: 1;
        background: var(--error-bg, rgba(255,100,100,0.2));
    }

    .terminal-tab-add {
        padding: 4px 8px;
        background: transparent;
        border: 1px dashed var(--border-color);
        border-radius: 4px;
        color: var(--text-muted);
        font-size: 11px;
        cursor: pointer;
    }

    .terminal-tab-add:hover {
        background: var(--bg-secondary);
        color: var(--text-primary);
        border-color: var(--text-muted);
    }

    .terminal-pane-header {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background: var(--bg-tertiary);
        border-bottom: 1px solid var(--border-color);
        flex-shrink: 0;
    }

    .terminal-pane-header .pane-title {
        font-weight: 500;
        font-size: 12px;
        color: var(--text-secondary);
    }

    .terminal-pane-header select {
        padding: 4px 8px;
        font-size: 12px;
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        color: var(--text-primary);
        min-width: 150px;
    }

    .terminal-pane-header .pane-actions {
        margin-left: auto;
        display: flex;
        gap: 4px;
    }

    .terminal-pane-header .pane-actions button {
        padding: 4px 8px;
        font-size: 11px;
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        color: var(--text-secondary);
        cursor: pointer;
    }

    .terminal-pane-header .pane-actions button:hover {
        background: var(--bg-secondary);
    }

    .terminal-pane-body {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
        height: 0; /* Force flex to calculate actual height */
        padding: 4px;
    }

    /* Terminal container - must have explicit dimensions for xterm.js */
    .terminal-pane-body .terminal-container {
        background: #1a1b26; /* Tokyo Night background */
        border-radius: 6px;
        padding: 0;
        flex: 1;
        min-height: 200px;
        overflow: hidden;
        border: 1px solid var(--border-color);
        position: relative; /* Establish positioning context */
    }

    [data-theme="dark"] .terminal-pane-body .terminal-container {
        background: #2e3440; /* Nord background */
    }

    /* xterm must be absolutely positioned to fill container reliably */
    .terminal-pane-body .terminal-container .xterm {
        position: absolute !important;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
    }

    /* Ensure xterm screen and viewport also fill properly */
    .terminal-pane-body .terminal-container .xterm-screen,
    .terminal-pane-body .terminal-container .xterm-viewport {
        height: 100% !important;
        width: 100% !important;
    }

    .terminal-pane-body .terminal-input-row {
        display: flex;
        gap: 8px;
        padding: 8px 0 4px;
        flex-shrink: 0;
    }

    .terminal-pane-body .terminal-input-row input {
        flex: 1;
        padding: 6px 10px;
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        color: var(--text-primary);
        font-family: 'JetBrains Mono', 'Fira Code', 'Cascadia Code', monospace;
        font-size: 13px;
    }

    .terminal-pane-body .terminal-input-row button {
        padding: 6px 12px;
        background: var(--accent-color);
        border: none;
        border-radius: 4px;
        color: #ffffff;
        cursor: pointer;
        font-size: 12px;
        font-weight: 500;
    }

    .terminal-pane-body .terminal-input-row button:hover:not(:disabled) {
        filter: brightness(1.1);
    }

    .terminal-pane-body .terminal-input-row button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* xterm.js viewport and scrollbar styling */
    .terminal-container .xterm-viewport {
        overflow-y: auto !important;
        background-color: transparent !important;
    }

    /* Match xterm background to terminal container */
    .terminal-container .xterm {
        background-color: var(--bg-tertiary, #1a1b26) !important;
    }

    .terminal-container .xterm-screen {
        background-color: var(--bg-tertiary, #1a1b26) !important;
    }

    .terminal-container .xterm-viewport::-webkit-scrollbar {
        width: 8px;
    }

    .terminal-container .xterm-viewport::-webkit-scrollbar-track {
        background: var(--bg-tertiary, #1a1b26);
    }

    .terminal-container .xterm-viewport::-webkit-scrollbar-thumb {
        background: var(--border-color, #3b4261);
        border-radius: 4px;
    }

    .terminal-container .xterm-viewport::-webkit-scrollbar-thumb:hover {
        background: var(--text-muted, #565f89);
    }

    /* Firefox scrollbar styling */
    .terminal-container .xterm-viewport {
        scrollbar-width: thin;
        scrollbar-color: var(--border-color, #3b4261) var(--bg-tertiary, #1a1b26);
    }

    /* CRITICAL: Reset xterm.js internal helper textarea
       The xterm-helper-textarea captures keyboard input and must not be
       affected by global textarea styles from styles-technical.css */
    .terminal-container .xterm-helper-textarea {
        /* Reset problematic global styles */
        width: auto !important;
        min-height: 0 !important;
        padding: 0 !important;
        border: none !important;
        background: transparent !important;
        box-shadow: none !important;
        /* xterm.js positions this element, let it handle positioning */
    }

    .terminal-container .xterm-helper-textarea:focus {
        outline: none !important;
        border: none !important;
        box-shadow: none !important;
    }

    /* Status indicators */
    .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--text-muted);
    }

    .status-indicator.connected {
        background: var(--success-color);
    }

    .status-indicator.disconnected {
        background: var(--text-muted);
    }

    .status-indicator.error {
        background: var(--error-color);
    }

    /* Quick commands panel */
    .quick-commands {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 8px 12px;
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
    }

    .quick-commands label {
        font-size: 12px;
        color: var(--text-secondary);
        margin-right: 8px;
    }

    .quick-commands button {
        padding: 4px 10px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        color: var(--text-primary);
        font-size: 11px;
        cursor: pointer;
        font-family: 'JetBrains Mono', 'Fira Code', monospace;
    }

    .quick-commands button:hover {
        background: var(--bg-primary);
    }

    /* Server groups panel */
    .server-groups {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 8px 12px;
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
    }

    .server-groups label {
        font-size: 12px;
        color: var(--text-secondary);
        margin-right: 4px;
    }

    .server-groups .tag-btn {
        padding: 4px 10px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        color: var(--text-primary);
        font-size: 11px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .server-groups .tag-btn:hover {
        background: var(--bg-primary);
    }

    .server-groups .tag-btn.selected {
        background: var(--accent-color);
        border-color: var(--accent-color);
        color: #ffffff;
    }

    .server-groups .tag-color {
        width: 8px;
        height: 8px;
        border-radius: 50%;
    }

    .server-groups .group-input {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-left: auto;
    }

    .server-groups .group-input input {
        padding: 4px 8px;
        font-size: 12px;
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        color: var(--text-primary);
        font-family: 'JetBrains Mono', 'Fira Code', monospace;
        width: 200px;
    }

    .server-groups .group-input button {
        padding: 4px 12px;
        background: var(--accent-color);
        border: none;
        border-radius: 4px;
        color: #ffffff;
        font-size: 11px;
        cursor: pointer;
        font-weight: 500;
    }

    .server-groups .group-input button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .server-groups .server-count {
        font-size: 11px;
        color: var(--text-muted);
        padding: 2px 6px;
        background: var(--bg-tertiary);
        border-radius: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="debug-container"
     x-data="debugConsole()"
     x-init="init()">

    <div class="flex-between">
        <div class="flex gap-2 align-center">
            <h1>Terminal</h1>
            <span id="ws-status" class="badge badge-secondary" style="font-size: 0.75rem;"
                  x-text="getActiveConnectionCount() > 0 ? getActiveConnectionCount() + ' active' : 'No connections'"
                  :class="getActiveConnectionCount() > 0 ? 'badge-success' : 'badge-secondary'">
            </span>
        </div>
        <div style="display: flex; gap: 16px; align-items: center;">
            <!-- Profiles -->
            <div style="display: flex; gap: 8px; align-items: center;">
                <select x-model="selectedProfileId" @change="loadProfile()" style="padding: 6px 10px; font-size: 12px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); min-width: 150px;">
                    <option value="">-- Select Profile --</option>
                    {% for profile in profiles %}
                    <option value="{{ profile.id }}">{{ profile.name }}{% if profile.is_default %} (default){% endif %}</option>
                    {% endfor %}
                </select>
                <button @click="showSaveProfileModal = true" style="padding: 6px 10px; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-secondary); cursor: pointer; border-radius: 4px; font-size: 12px;" title="Save current layout as profile">
                    <i data-lucide="save" style="width: 14px; height: 14px;"></i>
                </button>
                <button @click="showSettingsModal = true" style="padding: 6px 10px; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-secondary); cursor: pointer; border-radius: 4px; font-size: 12px;" title="Terminal settings">
                    <i data-lucide="settings" style="width: 14px; height: 14px;"></i>
                </button>
                <button @click="deleteProfile()" x-show="selectedProfileId" style="padding: 6px 10px; border: 1px solid var(--error-color); background: transparent; color: var(--error-color); cursor: pointer; border-radius: 4px; font-size: 12px;" title="Delete selected profile">
                    <i data-lucide="trash-2" style="width: 14px; height: 14px;"></i>
                </button>
            </div>
            <!-- Layout buttons -->
            <div class="debug-layout-btns">
                <button @click="setLayout('1')" :class="{ active: layout === '1' }" title="Single terminal">
                    <i data-lucide="square" style="width: 14px; height: 14px;"></i>
                </button>
                <button @click="setLayout('2h')" :class="{ active: layout === '2h' }" title="Two horizontal">
                    <i data-lucide="columns-2" style="width: 14px; height: 14px;"></i>
                </button>
                <button @click="setLayout('2v')" :class="{ active: layout === '2v' }" title="Two vertical">
                    <i data-lucide="rows-2" style="width: 14px; height: 14px;"></i>
                </button>
                <button @click="setLayout('4')" :class="{ active: layout === '4' }" title="Four terminals">
                    <i data-lucide="layout-grid" style="width: 14px; height: 14px;"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Save Profile Modal -->
    <div x-show="showSaveProfileModal"
         x-cloak
         style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;"
         @click.self="showSaveProfileModal = false">
        <div style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; min-width: 450px; max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <h3 style="margin: 0 0 16px 0; font-size: 16px;">Save Terminal Profile</h3>

            <!-- Basic Info -->
            <div style="margin-bottom: 12px;">
                <label style="display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Profile Name</label>
                <input type="text" x-model="newProfileName"
                       style="width: 100%; padding: 8px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary);"
                       placeholder="My Profile">
            </div>
            <div style="margin-bottom: 12px;">
                <label style="display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Description (optional)</label>
                <input type="text" x-model="newProfileDescription"
                       style="width: 100%; padding: 8px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary);"
                       placeholder="Description...">
            </div>

            <!-- Quick Commands Section -->
            <div style="margin-bottom: 16px; padding: 12px; background: var(--bg-tertiary); border-radius: 6px;">
                <label style="display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 8px; font-weight: 500;">
                    Quick Commands
                    <span style="font-weight: normal; color: var(--text-muted);">(one per line)</span>
                </label>
                <textarea x-model="newProfileQuickCommands"
                          rows="4"
                          style="width: 100%; padding: 8px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-family: 'JetBrains Mono', monospace; font-size: 12px; resize: vertical;"
                          placeholder="uptime&#10;df -h&#10;free -m&#10;docker ps"></textarea>
                <p style="font-size: 11px; color: var(--text-muted); margin: 4px 0 0 0;">
                    These commands will appear as quick-access buttons when the profile is loaded.
                </p>
            </div>

            <!-- Terminal Settings Section -->
            <div style="margin-bottom: 16px; padding: 12px; background: var(--bg-tertiary); border-radius: 6px;">
                <label style="display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 8px; font-weight: 500;">
                    Terminal Settings
                </label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div>
                        <label style="display: block; font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Font Size</label>
                        <select x-model="newProfileFontSize" style="width: 100%; padding: 6px 8px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-size: 12px;">
                            <option value="12">12px (Small)</option>
                            <option value="13">13px</option>
                            <option value="14">14px (Default)</option>
                            <option value="15">15px</option>
                            <option value="16">16px (Large)</option>
                            <option value="18">18px (X-Large)</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Cursor Style</label>
                        <select x-model="newProfileCursorStyle" style="width: 100%; padding: 6px 8px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-size: 12px;">
                            <option value="block">Block</option>
                            <option value="underline">Underline</option>
                            <option value="bar">Bar</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Scrollback Lines</label>
                        <select x-model="newProfileScrollback" style="width: 100%; padding: 6px 8px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-size: 12px;">
                            <option value="1000">1,000</option>
                            <option value="5000">5,000 (Default)</option>
                            <option value="10000">10,000</option>
                            <option value="50000">50,000</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--text-muted); margin-top: 20px;">
                            <input type="checkbox" x-model="newProfileCursorBlink">
                            Cursor Blink
                        </label>
                    </div>
                </div>
            </div>

            <div style="margin-bottom: 16px;">
                <label style="display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--text-secondary);">
                    <input type="checkbox" x-model="newProfileIsDefault">
                    Set as default profile
                </label>
            </div>

            <div style="display: flex; gap: 8px; justify-content: flex-end;">
                <button @click="showSaveProfileModal = false"
                        style="padding: 8px 16px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-secondary); cursor: pointer;">
                    Cancel
                </button>
                <button @click="saveProfile()"
                        :disabled="!newProfileName.trim()"
                        style="padding: 8px 16px; background: var(--accent-color); border: none; border-radius: 4px; color: #ffffff; cursor: pointer;">
                    Save Profile
                </button>
            </div>
        </div>
    </div>

    <!-- Terminal Settings Modal -->
    <div x-show="showSettingsModal"
         x-cloak
         style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;"
         @click.self="showSettingsModal = false">
        <div style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; min-width: 400px;">
            <h3 style="margin: 0 0 16px 0; font-size: 16px;">Terminal Settings</h3>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                <div>
                    <label style="display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Font Size</label>
                    <select x-model="terminalFontSize" @change="applyTerminalSettings()" style="width: 100%; padding: 6px 8px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-size: 12px;">
                        <option value="12">12px (Small)</option>
                        <option value="13">13px</option>
                        <option value="14">14px (Default)</option>
                        <option value="15">15px</option>
                        <option value="16">16px (Large)</option>
                        <option value="18">18px (X-Large)</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Cursor Style</label>
                    <select x-model="terminalCursorStyle" @change="applyTerminalSettings()" style="width: 100%; padding: 6px 8px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-size: 12px;">
                        <option value="block">Block</option>
                        <option value="underline">Underline</option>
                        <option value="bar">Bar</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Scrollback Lines</label>
                    <select x-model="terminalScrollback" @change="applyTerminalSettings()" style="width: 100%; padding: 6px 8px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-size: 12px;">
                        <option value="1000">1,000</option>
                        <option value="5000">5,000 (Default)</option>
                        <option value="10000">10,000</option>
                        <option value="50000">50,000</option>
                    </select>
                </div>
                <div>
                    <label style="display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--text-secondary); margin-top: 20px;">
                        <input type="checkbox" x-model="terminalCursorBlink" @change="applyTerminalSettings()">
                        Cursor Blink
                    </label>
                </div>
            </div>

            <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 6px; margin-bottom: 16px;">
                <p style="font-size: 11px; color: var(--text-muted); margin: 0;">
                    <strong>Tip:</strong> Use the <i data-lucide="save" style="width: 12px; height: 12px; display: inline-block; vertical-align: middle;"></i> Save button to save these settings as part of a profile.
                </p>
            </div>

            <div style="display: flex; gap: 8px; justify-content: flex-end;">
                <button @click="showSettingsModal = false"
                        style="padding: 8px 16px; background: var(--accent-color); border: none; border-radius: 4px; color: #ffffff; cursor: pointer;">
                    Done
                </button>
            </div>
        </div>
    </div>

    <p class="text-secondary mb-2" style="font-size: 13px;">
        Multi-terminal interface for debugging and testing commands across servers.
    </p>

    <!-- Server Groups -->
    <div class="server-groups">
        <label>Server Groups:</label>
        {% for tag in tags %}
        <button class="tag-btn"
                :class="{ selected: selectedTags.includes({{ tag.id }}) }"
                @click="toggleTag({{ tag.id }})">
            <span class="tag-color" style="background: {{ tag.color }};"></span>
            {{ tag.name }}
        </button>
        {% endfor %}
        <span class="server-count" x-text="getSelectedServerCount() + ' servers selected'"></span>
        <div class="group-input">
            <input type="text"
                   x-model="groupCommand"
                   @keydown.enter="executeOnGroup()"
                   placeholder="Command for selected servers...">
            <button @click="executeOnGroup()" :disabled="!groupCommand || selectedTags.length === 0">
                Run on Group
            </button>
        </div>
    </div>

    <!-- Quick Commands -->
    <div class="quick-commands">
        <label>Quick Commands:</label>
        <!-- Default commands (shown when no custom commands loaded) -->
        <template x-if="customQuickCommands.length === 0">
            <div style="display: contents;">
                <button @click="broadcastCommand('uptime')">uptime</button>
                <button @click="broadcastCommand('df -h')">df -h</button>
                <button @click="broadcastCommand('free -m')">free -m</button>
                <button @click="broadcastCommand('hostname')">hostname</button>
                <button @click="broadcastCommand('docker ps')">docker ps</button>
                <button @click="broadcastCommand('systemctl status')">systemctl</button>
            </div>
        </template>
        <!-- Custom commands from profile -->
        <template x-if="customQuickCommands.length > 0">
            <div style="display: contents;">
                <template x-for="cmd in customQuickCommands" :key="cmd">
                    <button @click="broadcastCommand(cmd)" x-text="cmd.length > 20 ? cmd.substring(0, 20) + '...' : cmd" :title="cmd"></button>
                </template>
                <button @click="customQuickCommands = []" style="background: var(--error-bg, rgba(255,100,100,0.2)); color: var(--error-color, #f7768e); margin-left: 8px;" title="Reset to default commands">
                    <i data-lucide="x" style="width: 12px; height: 12px;"></i>
                </button>
            </div>
        </template>
    </div>

    <!-- Terminal Grid -->
    <div class="terminals-grid" :class="'layout-' + layout">
        <!-- Pane 1 -->
        <div class="terminal-pane" x-show="visiblePanes >= 1">
            <!-- Terminal Tabs -->
            <div class="terminal-tabs-bar">
                <template x-for="(tab, tabIdx) in panes[0].tabs" :key="tab.id">
                    <button class="terminal-tab"
                            :class="{ active: panes[0].activeTab === tabIdx }"
                            @click="switchTab(0, tabIdx)">
                        <span x-text="tab.name"></span>
                        <span class="tab-close" @click.stop="closeTab(0, tabIdx)" x-show="panes[0].tabs.length > 1">
                            <i data-lucide="x" style="width: 10px; height: 10px;"></i>
                        </span>
                    </button>
                </template>
                <button class="terminal-tab-add" @click="addTab(0)" title="New tab">
                    <i data-lucide="plus" style="width: 12px; height: 12px;"></i>
                </button>
            </div>
            <div class="terminal-pane-header">
                <span class="status-indicator" :class="getActiveTab(0)?.status || 'disconnected'"></span>
                <span class="pane-title" x-text="'Terminal 1 - Tab ' + (panes[0].activeTab + 1)"></span>
                <select x-model="panes[0].tabs[panes[0].activeTab].serverId" @change="connectPane(0)">
                    <option value="">Select server...</option>
                    {% for server in servers %}
                    <option value="{{ server.id }}">{{ server.name }}</option>
                    {% endfor %}
                </select>
                <div class="pane-actions">
                    <button @click="toggleEnvVars(0)"
                            :title="panes[0].showEnvVars ? 'Hide Env Vars' : 'Environment Variables'"
                            :style="panes[0].envVars.length > 0 ? 'background: var(--warning-bg, rgba(224, 175, 104, 0.2)); border-color: var(--warning-color, #e0af68);' : ''">
                        <i data-lucide="variable" style="width: 12px; height: 12px;"></i>
                        <span x-show="panes[0].envVars.length > 0" x-text="panes[0].envVars.length" style="font-size: 9px; margin-left: 2px;"></span>
                    </button>
                    <button @click="getActiveTab(0)?.interactiveMode ? stopInteractiveShell(0) : startInteractiveShell(0)"
                            :title="getActiveTab(0)?.interactiveMode ? 'Exit Interactive Shell' : 'Start Interactive Shell'"
                            :style="getActiveTab(0)?.interactiveMode ? 'background: var(--accent-color); color: #fff;' : ''">
                        <i data-lucide="terminal" style="width: 12px; height: 12px;"></i>
                        <span x-text="getActiveTab(0)?.interactiveMode ? 'Exit Shell' : 'Shell'" style="font-size: 10px; margin-left: 4px;"></span>
                    </button>
                    <button @click="clearPane(0)" title="Clear">
                        <i data-lucide="trash-2" style="width: 12px; height: 12px;"></i>
                    </button>
                </div>
            </div>
            <!-- Environment Variables Editor -->
            <div x-show="panes[0].showEnvVars" x-cloak style="padding: 8px 12px; background: var(--bg-tertiary); border-bottom: 1px solid var(--border-color);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                    <span style="font-size: 11px; color: var(--text-secondary); font-weight: 500;">Environment Variables</span>
                    <div style="display: flex; gap: 4px;">
                        <button @click="addEnvVar(0)" style="padding: 2px 6px; font-size: 10px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 3px; color: var(--text-secondary); cursor: pointer;">+ Add</button>
                        <button @click="clearEnvVars(0)" style="padding: 2px 6px; font-size: 10px; background: transparent; border: 1px solid var(--error-color); border-radius: 3px; color: var(--error-color); cursor: pointer;">Clear</button>
                    </div>
                </div>
                <template x-for="(env, envIdx) in panes[0].envVars" :key="envIdx">
                    <div style="display: flex; gap: 4px; margin-bottom: 4px;">
                        <input type="text" x-model="env.key" placeholder="KEY" style="flex: 1; padding: 4px 6px; font-size: 11px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 3px; color: var(--text-primary); font-family: monospace;">
                        <span style="color: var(--text-muted); font-size: 11px; padding: 4px 0;">=</span>
                        <input type="text" x-model="env.value" placeholder="value" style="flex: 2; padding: 4px 6px; font-size: 11px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 3px; color: var(--text-primary); font-family: monospace;">
                        <button @click="removeEnvVar(0, envIdx)" style="padding: 2px 6px; background: transparent; border: none; color: var(--error-color); cursor: pointer; font-size: 14px;">&times;</button>
                    </div>
                </template>
                <p style="font-size: 10px; color: var(--text-muted); margin: 4px 0 0 0;">These will be exported before running commands.</p>
            </div>
            <div class="terminal-pane-body">
                <div class="terminal-container" id="terminal-pane-0"></div>
                <div class="terminal-input-row" x-show="!getActiveTab(0)?.interactiveMode">
                    <input type="text"
                           x-model="panes[0].command"
                           @keydown.enter="executePaneWithEnv(0)"
                           @keydown.up="historyUp(0)"
                           @keydown.down="historyDown(0)"
                           placeholder="Enter command..."
                           :disabled="!getActiveTab(0)?.serverId">
                    <button @click="executePaneWithEnv(0)" :disabled="!getActiveTab(0)?.serverId || !panes[0].command">
                        Run
                    </button>
                </div>
            </div>
        </div>

        <!-- Pane 2 -->
        <div class="terminal-pane" x-show="visiblePanes >= 2">
            <!-- Terminal Tabs -->
            <div class="terminal-tabs-bar">
                <template x-for="(tab, tabIdx) in panes[1].tabs" :key="tab.id">
                    <button class="terminal-tab"
                            :class="{ active: panes[1].activeTab === tabIdx }"
                            @click="switchTab(1, tabIdx)">
                        <span x-text="tab.name"></span>
                        <span class="tab-close" @click.stop="closeTab(1, tabIdx)" x-show="panes[1].tabs.length > 1">
                            <i data-lucide="x" style="width: 10px; height: 10px;"></i>
                        </span>
                    </button>
                </template>
                <button class="terminal-tab-add" @click="addTab(1)" title="New tab">
                    <i data-lucide="plus" style="width: 12px; height: 12px;"></i>
                </button>
            </div>
            <div class="terminal-pane-header">
                <span class="status-indicator" :class="getActiveTab(1)?.status || 'disconnected'"></span>
                <span class="pane-title" x-text="'Terminal 2 - Tab ' + (panes[1].activeTab + 1)"></span>
                <select x-model="panes[1].tabs[panes[1].activeTab].serverId" @change="connectPane(1)">
                    <option value="">Select server...</option>
                    {% for server in servers %}
                    <option value="{{ server.id }}">{{ server.name }}</option>
                    {% endfor %}
                </select>
                <div class="pane-actions">
                    <button @click="toggleEnvVars(1)"
                            :title="panes[1].showEnvVars ? 'Hide Env Vars' : 'Environment Variables'"
                            :style="panes[1].envVars.length > 0 ? 'background: var(--warning-bg, rgba(224, 175, 104, 0.2)); border-color: var(--warning-color, #e0af68);' : ''">
                        <i data-lucide="variable" style="width: 12px; height: 12px;"></i>
                        <span x-show="panes[1].envVars.length > 0" x-text="panes[1].envVars.length" style="font-size: 9px; margin-left: 2px;"></span>
                    </button>
                    <button @click="getActiveTab(1)?.interactiveMode ? stopInteractiveShell(1) : startInteractiveShell(1)"
                            :title="getActiveTab(1)?.interactiveMode ? 'Exit Interactive Shell' : 'Start Interactive Shell'"
                            :style="getActiveTab(1)?.interactiveMode ? 'background: var(--accent-color); color: #fff;' : ''">
                        <i data-lucide="terminal" style="width: 12px; height: 12px;"></i>
                        <span x-text="getActiveTab(1)?.interactiveMode ? 'Exit Shell' : 'Shell'" style="font-size: 10px; margin-left: 4px;"></span>
                    </button>
                    <button @click="clearPane(1)" title="Clear">
                        <i data-lucide="trash-2" style="width: 12px; height: 12px;"></i>
                    </button>
                </div>
            </div>
            <!-- Environment Variables Editor -->
            <div x-show="panes[1].showEnvVars" x-cloak style="padding: 8px 12px; background: var(--bg-tertiary); border-bottom: 1px solid var(--border-color);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                    <span style="font-size: 11px; color: var(--text-secondary); font-weight: 500;">Environment Variables</span>
                    <div style="display: flex; gap: 4px;">
                        <button @click="addEnvVar(1)" style="padding: 2px 6px; font-size: 10px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 3px; color: var(--text-secondary); cursor: pointer;">+ Add</button>
                        <button @click="clearEnvVars(1)" style="padding: 2px 6px; font-size: 10px; background: transparent; border: 1px solid var(--error-color); border-radius: 3px; color: var(--error-color); cursor: pointer;">Clear</button>
                    </div>
                </div>
                <template x-for="(env, envIdx) in panes[1].envVars" :key="envIdx">
                    <div style="display: flex; gap: 4px; margin-bottom: 4px;">
                        <input type="text" x-model="env.key" placeholder="KEY" style="flex: 1; padding: 4px 6px; font-size: 11px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 3px; color: var(--text-primary); font-family: monospace;">
                        <span style="color: var(--text-muted); font-size: 11px; padding: 4px 0;">=</span>
                        <input type="text" x-model="env.value" placeholder="value" style="flex: 2; padding: 4px 6px; font-size: 11px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 3px; color: var(--text-primary); font-family: monospace;">
                        <button @click="removeEnvVar(1, envIdx)" style="padding: 2px 6px; background: transparent; border: none; color: var(--error-color); cursor: pointer; font-size: 14px;">&times;</button>
                    </div>
                </template>
                <p style="font-size: 10px; color: var(--text-muted); margin: 4px 0 0 0;">These will be exported before running commands.</p>
            </div>
            <div class="terminal-pane-body">
                <div class="terminal-container" id="terminal-pane-1"></div>
                <div class="terminal-input-row" x-show="!getActiveTab(1)?.interactiveMode">
                    <input type="text"
                           x-model="panes[1].command"
                           @keydown.enter="executePaneWithEnv(1)"
                           @keydown.up="historyUp(1)"
                           @keydown.down="historyDown(1)"
                           placeholder="Enter command..."
                           :disabled="!getActiveTab(1)?.serverId">
                    <button @click="executePaneWithEnv(1)" :disabled="!getActiveTab(1)?.serverId || !panes[1].command">
                        Run
                    </button>
                </div>
            </div>
        </div>

        <!-- Pane 3 -->
        <div class="terminal-pane" x-show="visiblePanes >= 3">
            <!-- Terminal Tabs -->
            <div class="terminal-tabs-bar">
                <template x-for="(tab, tabIdx) in panes[2].tabs" :key="tab.id">
                    <button class="terminal-tab"
                            :class="{ active: panes[2].activeTab === tabIdx }"
                            @click="switchTab(2, tabIdx)">
                        <span x-text="tab.name"></span>
                        <span class="tab-close" @click.stop="closeTab(2, tabIdx)" x-show="panes[2].tabs.length > 1">
                            <i data-lucide="x" style="width: 10px; height: 10px;"></i>
                        </span>
                    </button>
                </template>
                <button class="terminal-tab-add" @click="addTab(2)" title="New tab">
                    <i data-lucide="plus" style="width: 12px; height: 12px;"></i>
                </button>
            </div>
            <div class="terminal-pane-header">
                <span class="status-indicator" :class="getActiveTab(2)?.status || 'disconnected'"></span>
                <span class="pane-title" x-text="'Terminal 3 - Tab ' + (panes[2].activeTab + 1)"></span>
                <select x-model="panes[2].tabs[panes[2].activeTab].serverId" @change="connectPane(2)">
                    <option value="">Select server...</option>
                    {% for server in servers %}
                    <option value="{{ server.id }}">{{ server.name }}</option>
                    {% endfor %}
                </select>
                <div class="pane-actions">
                    <button @click="toggleEnvVars(2)"
                            :title="panes[2].showEnvVars ? 'Hide Env Vars' : 'Environment Variables'"
                            :style="panes[2].envVars.length > 0 ? 'background: var(--warning-bg, rgba(224, 175, 104, 0.2)); border-color: var(--warning-color, #e0af68);' : ''">
                        <i data-lucide="variable" style="width: 12px; height: 12px;"></i>
                        <span x-show="panes[2].envVars.length > 0" x-text="panes[2].envVars.length" style="font-size: 9px; margin-left: 2px;"></span>
                    </button>
                    <button @click="getActiveTab(2)?.interactiveMode ? stopInteractiveShell(2) : startInteractiveShell(2)"
                            :title="getActiveTab(2)?.interactiveMode ? 'Exit Interactive Shell' : 'Start Interactive Shell'"
                            :style="getActiveTab(2)?.interactiveMode ? 'background: var(--accent-color); color: #fff;' : ''">
                        <i data-lucide="terminal" style="width: 12px; height: 12px;"></i>
                        <span x-text="getActiveTab(2)?.interactiveMode ? 'Exit Shell' : 'Shell'" style="font-size: 10px; margin-left: 4px;"></span>
                    </button>
                    <button @click="clearPane(2)" title="Clear">
                        <i data-lucide="trash-2" style="width: 12px; height: 12px;"></i>
                    </button>
                </div>
            </div>
            <!-- Environment Variables Editor -->
            <div x-show="panes[2].showEnvVars" x-cloak style="padding: 8px 12px; background: var(--bg-tertiary); border-bottom: 1px solid var(--border-color);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                    <span style="font-size: 11px; color: var(--text-secondary); font-weight: 500;">Environment Variables</span>
                    <div style="display: flex; gap: 4px;">
                        <button @click="addEnvVar(2)" style="padding: 2px 6px; font-size: 10px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 3px; color: var(--text-secondary); cursor: pointer;">+ Add</button>
                        <button @click="clearEnvVars(2)" style="padding: 2px 6px; font-size: 10px; background: transparent; border: 1px solid var(--error-color); border-radius: 3px; color: var(--error-color); cursor: pointer;">Clear</button>
                    </div>
                </div>
                <template x-for="(env, envIdx) in panes[2].envVars" :key="envIdx">
                    <div style="display: flex; gap: 4px; margin-bottom: 4px;">
                        <input type="text" x-model="env.key" placeholder="KEY" style="flex: 1; padding: 4px 6px; font-size: 11px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 3px; color: var(--text-primary); font-family: monospace;">
                        <span style="color: var(--text-muted); font-size: 11px; padding: 4px 0;">=</span>
                        <input type="text" x-model="env.value" placeholder="value" style="flex: 2; padding: 4px 6px; font-size: 11px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 3px; color: var(--text-primary); font-family: monospace;">
                        <button @click="removeEnvVar(2, envIdx)" style="padding: 2px 6px; background: transparent; border: none; color: var(--error-color); cursor: pointer; font-size: 14px;">&times;</button>
                    </div>
                </template>
                <p style="font-size: 10px; color: var(--text-muted); margin: 4px 0 0 0;">These will be exported before running commands.</p>
            </div>
            <div class="terminal-pane-body">
                <div class="terminal-container" id="terminal-pane-2"></div>
                <div class="terminal-input-row" x-show="!getActiveTab(2)?.interactiveMode">
                    <input type="text"
                           x-model="panes[2].command"
                           @keydown.enter="executePaneWithEnv(2)"
                           @keydown.up="historyUp(2)"
                           @keydown.down="historyDown(2)"
                           placeholder="Enter command..."
                           :disabled="!getActiveTab(2)?.serverId">
                    <button @click="executePaneWithEnv(2)" :disabled="!getActiveTab(2)?.serverId || !panes[2].command">
                        Run
                    </button>
                </div>
            </div>
        </div>

        <!-- Pane 4 -->
        <div class="terminal-pane" x-show="visiblePanes >= 4">
            <!-- Terminal Tabs -->
            <div class="terminal-tabs-bar">
                <template x-for="(tab, tabIdx) in panes[3].tabs" :key="tab.id">
                    <button class="terminal-tab"
                            :class="{ active: panes[3].activeTab === tabIdx }"
                            @click="switchTab(3, tabIdx)">
                        <span x-text="tab.name"></span>
                        <span class="tab-close" @click.stop="closeTab(3, tabIdx)" x-show="panes[3].tabs.length > 1">
                            <i data-lucide="x" style="width: 10px; height: 10px;"></i>
                        </span>
                    </button>
                </template>
                <button class="terminal-tab-add" @click="addTab(3)" title="New tab">
                    <i data-lucide="plus" style="width: 12px; height: 12px;"></i>
                </button>
            </div>
            <div class="terminal-pane-header">
                <span class="status-indicator" :class="getActiveTab(3)?.status || 'disconnected'"></span>
                <span class="pane-title" x-text="'Terminal 4 - Tab ' + (panes[3].activeTab + 1)"></span>
                <select x-model="panes[3].tabs[panes[3].activeTab].serverId" @change="connectPane(3)">
                    <option value="">Select server...</option>
                    {% for server in servers %}
                    <option value="{{ server.id }}">{{ server.name }}</option>
                    {% endfor %}
                </select>
                <div class="pane-actions">
                    <button @click="toggleEnvVars(3)"
                            :title="panes[3].showEnvVars ? 'Hide Env Vars' : 'Environment Variables'"
                            :style="panes[3].envVars.length > 0 ? 'background: var(--warning-bg, rgba(224, 175, 104, 0.2)); border-color: var(--warning-color, #e0af68);' : ''">
                        <i data-lucide="variable" style="width: 12px; height: 12px;"></i>
                        <span x-show="panes[3].envVars.length > 0" x-text="panes[3].envVars.length" style="font-size: 9px; margin-left: 2px;"></span>
                    </button>
                    <button @click="getActiveTab(3)?.interactiveMode ? stopInteractiveShell(3) : startInteractiveShell(3)"
                            :title="getActiveTab(3)?.interactiveMode ? 'Exit Interactive Shell' : 'Start Interactive Shell'"
                            :style="getActiveTab(3)?.interactiveMode ? 'background: var(--accent-color); color: #fff;' : ''">
                        <i data-lucide="terminal" style="width: 12px; height: 12px;"></i>
                        <span x-text="getActiveTab(3)?.interactiveMode ? 'Exit Shell' : 'Shell'" style="font-size: 10px; margin-left: 4px;"></span>
                    </button>
                    <button @click="clearPane(3)" title="Clear">
                        <i data-lucide="trash-2" style="width: 12px; height: 12px;"></i>
                    </button>
                </div>
            </div>
            <!-- Environment Variables Editor -->
            <div x-show="panes[3].showEnvVars" x-cloak style="padding: 8px 12px; background: var(--bg-tertiary); border-bottom: 1px solid var(--border-color);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                    <span style="font-size: 11px; color: var(--text-secondary); font-weight: 500;">Environment Variables</span>
                    <div style="display: flex; gap: 4px;">
                        <button @click="addEnvVar(3)" style="padding: 2px 6px; font-size: 10px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 3px; color: var(--text-secondary); cursor: pointer;">+ Add</button>
                        <button @click="clearEnvVars(3)" style="padding: 2px 6px; font-size: 10px; background: transparent; border: 1px solid var(--error-color); border-radius: 3px; color: var(--error-color); cursor: pointer;">Clear</button>
                    </div>
                </div>
                <template x-for="(env, envIdx) in panes[3].envVars" :key="envIdx">
                    <div style="display: flex; gap: 4px; margin-bottom: 4px;">
                        <input type="text" x-model="env.key" placeholder="KEY" style="flex: 1; padding: 4px 6px; font-size: 11px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 3px; color: var(--text-primary); font-family: monospace;">
                        <span style="color: var(--text-muted); font-size: 11px; padding: 4px 0;">=</span>
                        <input type="text" x-model="env.value" placeholder="value" style="flex: 2; padding: 4px 6px; font-size: 11px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 3px; color: var(--text-primary); font-family: monospace;">
                        <button @click="removeEnvVar(3, envIdx)" style="padding: 2px 6px; background: transparent; border: none; color: var(--error-color); cursor: pointer; font-size: 14px;">&times;</button>
                    </div>
                </template>
                <p style="font-size: 10px; color: var(--text-muted); margin: 4px 0 0 0;">These will be exported before running commands.</p>
            </div>
            <div class="terminal-pane-body">
                <div class="terminal-container" id="terminal-pane-3"></div>
                <div class="terminal-input-row" x-show="!getActiveTab(3)?.interactiveMode">
                    <input type="text"
                           x-model="panes[3].command"
                           @keydown.enter="executePaneWithEnv(3)"
                           @keydown.up="historyUp(3)"
                           @keydown.down="historyDown(3)"
                           placeholder="Enter command..."
                           :disabled="!getActiveTab(3)?.serverId">
                    <button @click="executePaneWithEnv(3)" :disabled="!getActiveTab(3)?.serverId || !panes[3].command">
                        Run
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Server data from backend for server groups feature
const serverData = [
    {% for server in servers %}
    { id: {{ server.id }}, name: "{{ server.name }}", tagIds: [{% for tag_id in server.tag_ids %}{{ tag_id }}{% if !loop.last %},{% endif %}{% endfor %}] },
    {% endfor %}
];

// Profile data from backend
const profileData = [
    {% for profile in profiles %}
    {
        id: {{ profile.id }},
        name: "{{ profile.name }}",
        layout: "{{ profile.layout }}",
        paneConfigs: {{ profile.pane_configs_json|safe }},
        quickCommands: {{ profile.quick_commands_json|safe }},
        isDefault: {{ profile.is_default }}
    },
    {% endfor %}
];

function debugConsole() {
    return {
        layout: '2h',
        terminals: [],
        tabCounter: 0,
        selectedTags: [],
        groupCommand: '',
        // Profile management
        selectedProfileId: '',
        showSaveProfileModal: false,
        newProfileName: '',
        newProfileDescription: '',
        newProfileIsDefault: false,
        newProfileQuickCommands: '',
        newProfileFontSize: '14',
        newProfileCursorStyle: 'block',
        newProfileScrollback: '5000',
        newProfileCursorBlink: true,
        // Terminal settings (current)
        terminalFontSize: 14,
        terminalCursorStyle: 'block',
        terminalScrollback: 5000,
        terminalCursorBlink: true,
        // Custom quick commands
        customQuickCommands: [],
        // Settings modal
        showSettingsModal: false,
        // Each tab now has its own terminal session with independent server connection
        panes: [
            { command: '', activeTab: 0, historyIndex: -1, envVars: [], showEnvVars: false, tabs: [{ id: 0, name: 'Tab 1', history: [], serverId: '', interactiveMode: false, status: 'disconnected', terminal: null }] },
            { command: '', activeTab: 0, historyIndex: -1, envVars: [], showEnvVars: false, tabs: [{ id: 0, name: 'Tab 1', history: [], serverId: '', interactiveMode: false, status: 'disconnected', terminal: null }] },
            { command: '', activeTab: 0, historyIndex: -1, envVars: [], showEnvVars: false, tabs: [{ id: 0, name: 'Tab 1', history: [], serverId: '', interactiveMode: false, status: 'disconnected', terminal: null }] },
            { command: '', activeTab: 0, historyIndex: -1, envVars: [], showEnvVars: false, tabs: [{ id: 0, name: 'Tab 1', history: [], serverId: '', interactiveMode: false, status: 'disconnected', terminal: null }] }
        ],

        get visiblePanes() {
            switch(this.layout) {
                case '1': return 1;
                case '2h':
                case '2v': return 2;
                case '4': return 4;
                default: return 2;
            }
        },

        // Helper to get the active tab for a pane
        getActiveTab(paneIndex) {
            const pane = this.panes[paneIndex];
            return pane.tabs[pane.activeTab];
        },

        init() {
            this.tabCounter = 4; // Start counter after initial tabs

            // Initialize terminals for each pane
            this.$nextTick(() => {
                for (let i = 0; i < 4; i++) {
                    this.initPane(i);
                }

                // Re-init icons after Alpine renders
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            });

            // Navigation warning for active sessions
            const self = this;
            let userConfirmedLeave = false;

            // Helper to disconnect all sessions and clear the flag
            const disconnectAllSessions = () => {
                for (let i = 0; i < 4; i++) {
                    const pane = self.panes[i];
                    for (const tab of pane.tabs) {
                        if (tab.terminal && tab.terminal.socket) {
                            tab.terminal.disconnect();
                        }
                        tab.status = 'disconnected';
                        tab.interactiveMode = false;
                    }
                }
            };

            // Browser navigation (close tab, external URL, refresh)
            // Only fires for actual browser close/refresh, not HTMX navigation
            window.addEventListener('beforeunload', (e) => {
                if (!userConfirmedLeave && self.getActiveConnectionCount() > 0) {
                    e.preventDefault();
                    e.returnValue = 'You have active terminal sessions that will be closed.';
                    return e.returnValue;
                }
            });

            // HTMX internal navigation (sidebar links)
            document.body.addEventListener('htmx:confirm', (evt) => {
                // Only intercept if we have active sessions and it's a navigation request
                const target = evt.detail.target || evt.detail.elt;
                if (!userConfirmedLeave &&
                    self.getActiveConnectionCount() > 0 &&
                    target &&
                    (target.hasAttribute('hx-get') || target.hasAttribute('hx-boost')) &&
                    !target.closest('.terminal-pane')) {
                    evt.preventDefault();
                    if (confirm('You have active terminal sessions that will be closed. Leave this page?')) {
                        userConfirmedLeave = true;
                        disconnectAllSessions();
                        evt.detail.issueRequest(true);
                    }
                }
            });

            // Regular anchor clicks (non-HTMX)
            document.addEventListener('click', (e) => {
                const link = e.target.closest('a[href]');
                if (link &&
                    !userConfirmedLeave &&
                    !link.hasAttribute('hx-get') &&
                    !link.hasAttribute('hx-boost') &&
                    !link.getAttribute('href').startsWith('#') &&
                    !link.closest('.terminal-pane') &&
                    self.getActiveConnectionCount() > 0) {
                    if (confirm('You have active terminal sessions that will be closed. Leave this page?')) {
                        userConfirmedLeave = true;
                        disconnectAllSessions();
                        // Allow the click to proceed
                    } else {
                        e.preventDefault();
                    }
                }
            });
        },

        initPane(index) {
            // Initialize terminal for the first tab of this pane
            this.initTabTerminal(index, 0);
        },

        // Initialize a terminal for a specific tab
        initTabTerminal(paneIndex, tabIndex) {
            const containerId = `terminal-pane-${paneIndex}`;
            const container = document.getElementById(containerId);
            if (!container) {
                console.error(`Container not found: ${containerId}`);
                return;
            }

            const tab = this.panes[paneIndex].tabs[tabIndex];
            if (!tab) return;

            // If tab already has a terminal, just show it
            if (tab.terminal) {
                return;
            }

            // Create terminal manager instance for this tab
            const terminal = new TerminalManager();
            terminal.init(containerId);
            tab.terminal = terminal;
            this.terminals[paneIndex] = terminal;

            // Use ResizeObserver to fit terminal when container changes size
            const resizeObserver = new ResizeObserver(() => {
                if (terminal.fitAddon) {
                    terminal.fit();
                }
            });
            resizeObserver.observe(container);

            // Write welcome message and aggressively fit terminal
            if (terminal.terminal) {
                terminal.terminal.writeln('\x1b[90m--- Terminal ' + (paneIndex + 1) + ' ready ---\x1b[0m');
                terminal.terminal.writeln('\x1b[90mSelect a server and enter a command.\x1b[0m');

                // Multiple delayed fits to handle layout timing
                setTimeout(() => terminal.fit(), 50);
                setTimeout(() => terminal.fit(), 150);
                setTimeout(() => {
                    terminal.fit();
                    // Scroll to top after fits complete
                    terminal.terminal.scrollToTop();
                }, 300);
            }
        },

        setLayout(newLayout) {
            this.layout = newLayout;
            // Fit terminals to new size after layout change
            this.$nextTick(() => {
                for (let i = 0; i < this.visiblePanes; i++) {
                    const tab = this.getActiveTab(i);
                    if (tab && tab.terminal) {
                        tab.terminal.fit();
                    }
                }
            });
        },

        // Tab management
        addTab(paneIndex) {
            this.tabCounter++;
            const newTab = {
                id: this.tabCounter,
                name: `Tab ${this.panes[paneIndex].tabs.length + 1}`,
                history: [],
                serverId: '',
                interactiveMode: false,
                status: 'disconnected',
                terminal: null
            };
            this.panes[paneIndex].tabs.push(newTab);
            this.panes[paneIndex].activeTab = this.panes[paneIndex].tabs.length - 1;

            // Initialize terminal for new tab
            this.$nextTick(() => {
                this.initTabTerminal(paneIndex, this.panes[paneIndex].activeTab);
                // Re-init icons for new close button
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            });
        },

        closeTab(paneIndex, tabIdx) {
            if (this.panes[paneIndex].tabs.length <= 1) return;

            // Disconnect and cleanup the tab's terminal
            const tab = this.panes[paneIndex].tabs[tabIdx];
            if (tab && tab.terminal) {
                tab.terminal.disconnect();
                tab.terminal.dispose();
            }

            this.panes[paneIndex].tabs.splice(tabIdx, 1);
            if (this.panes[paneIndex].activeTab >= this.panes[paneIndex].tabs.length) {
                this.panes[paneIndex].activeTab = this.panes[paneIndex].tabs.length - 1;
            }

            // Switch to the new active tab's terminal
            this.switchTab(paneIndex, this.panes[paneIndex].activeTab);
        },

        switchTab(paneIndex, tabIdx) {
            const oldActiveTab = this.panes[paneIndex].activeTab;
            this.panes[paneIndex].activeTab = tabIdx;

            const newTab = this.getActiveTab(paneIndex);
            if (!newTab) return;

            // Initialize terminal for this tab if not already done
            if (!newTab.terminal) {
                this.$nextTick(() => {
                    this.initTabTerminal(paneIndex, tabIdx);
                });
            } else {
                // Re-attach terminal to container (xterm.js terminals can be re-opened)
                const containerId = `terminal-pane-${paneIndex}`;
                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = ''; // Clear container
                    newTab.terminal.terminal.open(container);
                    newTab.terminal.fit();
                }
            }
        },

        connectPane(index) {
            const pane = this.panes[index];
            const tab = this.getActiveTab(index);
            if (!tab || !tab.serverId) {
                if (tab) tab.status = 'disconnected';
                return;
            }

            // Disconnect existing connection if any
            if (tab.terminal && tab.terminal.socket) {
                tab.terminal.disconnect();
            }

            tab.status = 'connected';

            // Get server name for messages
            const serverName = document.querySelector(
                `[x-model="getActiveTab(${index}).serverId"] option[value="${tab.serverId}"]`
            )?.textContent || 'Unknown';

            // If in interactive mode, reconnect PTY with new server
            if (tab.interactiveMode && tab.terminal) {
                // Clear terminal and show connecting message
                this.clearPane(index);
                tab.terminal.terminal.writeln(`\x1b[36m--- Connecting to ${serverName} ---\x1b[0m`);
                // Connect PTY with new server
                tab.terminal.connectPty(parseInt(tab.serverId));
                return;
            }

            // Write a prompt message for non-interactive mode
            if (tab.terminal) {
                tab.terminal.terminal.write(`\r\n\x1b[36m--- Connected to ${serverName} ---\x1b[0m\r\n\r\n`);
            }
        },

        executePane(index) {
            const pane = this.panes[index];
            const tab = this.getActiveTab(index);
            if (!tab || !tab.serverId || !pane.command) return;

            // Save to tab history
            if (pane.command.trim()) {
                if (tab.history.length === 0 || tab.history[tab.history.length - 1] !== pane.command) {
                    tab.history.push(pane.command);
                    if (tab.history.length > 50) tab.history.shift();
                }
                pane.historyIndex = tab.history.length;
            }

            if (tab.terminal) {
                // Execute command using the terminal manager
                tab.terminal.connect(tab.serverId, pane.command);
            }

            // Clear the command input
            pane.command = '';
        },

        executePaneWithEnv(index) {
            const pane = this.panes[index];
            const tab = this.getActiveTab(index);
            if (!tab || !tab.serverId || !pane.command) return;

            // Save to tab history
            if (pane.command.trim()) {
                if (tab.history.length === 0 || tab.history[tab.history.length - 1] !== pane.command) {
                    tab.history.push(pane.command);
                    if (tab.history.length > 50) tab.history.shift();
                }
                pane.historyIndex = tab.history.length;
            }

            if (tab.terminal) {
                // Filter out empty env vars and execute with environment variables
                const envVars = pane.envVars.filter(e => e.key && e.key.trim());
                tab.terminal.connect(tab.serverId, pane.command, envVars);
            }

            // Clear the command input
            pane.command = '';
        },

        historyUp(index) {
            const pane = this.panes[index];
            const tab = pane.tabs[pane.activeTab];
            if (tab && tab.history.length > 0 && pane.historyIndex > 0) {
                pane.historyIndex--;
                pane.command = tab.history[pane.historyIndex];
            }
        },

        historyDown(index) {
            const pane = this.panes[index];
            const tab = pane.tabs[pane.activeTab];
            if (tab && tab.history.length > 0) {
                if (pane.historyIndex < tab.history.length - 1) {
                    pane.historyIndex++;
                    pane.command = tab.history[pane.historyIndex];
                } else {
                    pane.historyIndex = tab.history.length;
                    pane.command = '';
                }
            }
        },

        clearPane(index) {
            const tab = this.getActiveTab(index);
            if (tab && tab.terminal) {
                tab.terminal.clear();
            }
        },

        // Environment variables methods
        toggleEnvVars(index) {
            this.panes[index].showEnvVars = !this.panes[index].showEnvVars;
            if (this.panes[index].showEnvVars && this.panes[index].envVars.length === 0) {
                this.addEnvVar(index);
            }
        },

        addEnvVar(index) {
            this.panes[index].envVars.push({ key: '', value: '' });
        },

        removeEnvVar(paneIndex, varIndex) {
            this.panes[paneIndex].envVars.splice(varIndex, 1);
        },

        clearEnvVars(index) {
            this.panes[index].envVars = [];
            this.panes[index].showEnvVars = false;
        },

        // Start interactive shell session (PTY mode)
        startInteractiveShell(index) {
            const tab = this.getActiveTab(index);
            if (!tab || !tab.serverId) {
                alert('Please select a server first');
                return;
            }

            // Disconnect existing connection if any
            if (tab.terminal && tab.terminal.socket) {
                tab.terminal.disconnect();
            }

            // Clear the terminal
            this.clearPane(index);

            // Set interactive mode
            tab.interactiveMode = true;
            tab.status = 'connected';

            // Connect using PTY
            if (tab.terminal) {
                tab.terminal.connectPty(parseInt(tab.serverId));
            }
        },

        // Stop interactive shell session
        stopInteractiveShell(index) {
            const tab = this.getActiveTab(index);
            if (!tab) return;

            // Disconnect PTY
            if (tab.terminal) {
                tab.terminal.disconnect();
            }

            // Exit interactive mode
            tab.interactiveMode = false;
            tab.status = 'disconnected';

            // Write message
            if (tab.terminal && tab.terminal.terminal) {
                tab.terminal.terminal.writeln('\r\n\x1b[33m[Interactive shell closed]\x1b[0m');
                tab.terminal.terminal.writeln('\x1b[90mSelect a server and enter a command.\x1b[0m\r\n');
            }
        },

        broadcastCommand(cmd) {
            // Execute command on all panes that have a server selected (on their active tab)
            for (let i = 0; i < this.visiblePanes; i++) {
                const tab = this.getActiveTab(i);
                if (tab && tab.serverId) {
                    this.panes[i].command = cmd;
                    this.executePane(i);
                }
            }
        },

        // Server groups methods
        toggleTag(tagId) {
            const idx = this.selectedTags.indexOf(tagId);
            if (idx >= 0) {
                this.selectedTags.splice(idx, 1);
            } else {
                this.selectedTags.push(tagId);
            }
        },

        getSelectedServerCount() {
            if (this.selectedTags.length === 0) return 0;
            return serverData.filter(s =>
                s.tagIds.some(tagId => this.selectedTags.includes(tagId))
            ).length;
        },

        getActiveConnectionCount() {
            // Count tabs with 'connected' status (across all panes)
            let count = 0;
            for (let i = 0; i < this.panes.length; i++) {
                const tab = this.getActiveTab(i);
                if (tab && tab.status === 'connected') count++;
            }
            return count;
        },

        getServersForSelectedTags() {
            if (this.selectedTags.length === 0) return [];
            return serverData.filter(s =>
                s.tagIds.some(tagId => this.selectedTags.includes(tagId))
            );
        },

        executeOnGroup() {
            if (!this.groupCommand || this.selectedTags.length === 0) return;

            const servers = this.getServersForSelectedTags();
            if (servers.length === 0) return;

            // Assign servers to available panes and execute
            const panesNeeded = Math.min(servers.length, this.visiblePanes);

            for (let i = 0; i < panesNeeded; i++) {
                const server = servers[i];
                const tab = this.getActiveTab(i);
                if (tab) {
                    tab.serverId = String(server.id);
                    this.connectPane(i);

                    // Small delay to ensure connection is established
                    setTimeout(() => {
                        this.panes[i].command = this.groupCommand;
                        this.executePane(i);
                    }, 100 * (i + 1));
                }
            }

            // Show message if there are more servers than panes
            if (servers.length > this.visiblePanes) {
                console.log(`Note: ${servers.length - this.visiblePanes} servers couldn't be assigned (not enough panes visible)`);
            }

            // Clear group command
            this.groupCommand = '';
        },

        // Profile management methods
        loadProfile() {
            if (!this.selectedProfileId) return;

            const profile = profileData.find(p => p.id === parseInt(this.selectedProfileId));
            if (!profile) return;

            // Apply layout
            this.setLayout(profile.layout);

            // Apply pane configs (server assignments)
            if (profile.paneConfigs && Array.isArray(profile.paneConfigs)) {
                profile.paneConfigs.forEach((config, index) => {
                    if (index < 4 && config.server_id) {
                        this.panes[index].serverId = String(config.server_id);
                        this.connectPane(index);
                    }
                });
            }

            // Apply quick commands
            if (profile.quickCommands && Array.isArray(profile.quickCommands) && profile.quickCommands.length > 0) {
                this.customQuickCommands = profile.quickCommands;
            }

            // Apply terminal settings if stored in quickCommands as settings object
            // (We're using a combined format for backward compatibility)
            if (profile.paneConfigs && profile.paneConfigs[0] && profile.paneConfigs[0].terminal_settings) {
                const settings = profile.paneConfigs[0].terminal_settings;
                if (settings.fontSize) this.terminalFontSize = settings.fontSize;
                if (settings.cursorStyle) this.terminalCursorStyle = settings.cursorStyle;
                if (settings.scrollback) this.terminalScrollback = settings.scrollback;
                if (settings.cursorBlink !== undefined) this.terminalCursorBlink = settings.cursorBlink;
                this.applyTerminalSettings();
            }

            console.log('Loaded profile:', profile.name);
        },

        // Apply terminal settings to all terminals
        applyTerminalSettings() {
            for (let i = 0; i < 4; i++) {
                const terminal = this.panes[i].terminal;
                if (terminal && terminal.terminal) {
                    terminal.terminal.options.fontSize = this.terminalFontSize;
                    terminal.terminal.options.cursorStyle = this.terminalCursorStyle;
                    terminal.terminal.options.scrollback = this.terminalScrollback;
                    terminal.terminal.options.cursorBlink = this.terminalCursorBlink;
                    // Refit after font change
                    terminal.fit();
                }
            }
        },

        async saveProfile() {
            if (!this.newProfileName.trim()) return;

            // Collect current pane configurations with terminal settings in the first pane
            const paneConfigs = this.panes.slice(0, this.visiblePanes).map((pane, index) => {
                const config = {
                    server_id: pane.serverId ? parseInt(pane.serverId) : null
                };
                // Store terminal settings in the first pane config
                if (index === 0) {
                    config.terminal_settings = {
                        fontSize: parseInt(this.newProfileFontSize),
                        cursorStyle: this.newProfileCursorStyle,
                        scrollback: parseInt(this.newProfileScrollback),
                        cursorBlink: this.newProfileCursorBlink
                    };
                }
                return config;
            });

            // Parse quick commands from textarea (one per line)
            const quickCommands = this.newProfileQuickCommands
                .split('\n')
                .map(cmd => cmd.trim())
                .filter(cmd => cmd.length > 0);

            const profileData = {
                name: this.newProfileName.trim(),
                description: this.newProfileDescription.trim() || null,
                layout: this.layout,
                pane_configs: paneConfigs,
                quick_commands: quickCommands,
                is_default: this.newProfileIsDefault
            };

            try {
                const response = await fetch('/terminal/profiles', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(profileData)
                });

                const result = await response.json();
                if (result.success) {
                    // Close modal and reload page to get updated profile list
                    this.showSaveProfileModal = false;
                    this.newProfileName = '';
                    this.newProfileDescription = '';
                    this.newProfileIsDefault = false;
                    window.location.reload();
                } else {
                    alert('Failed to save profile: ' + result.message);
                }
            } catch (error) {
                console.error('Error saving profile:', error);
                alert('Error saving profile');
            }
        },

        async deleteProfile() {
            if (!this.selectedProfileId) return;

            const profile = profileData.find(p => p.id === parseInt(this.selectedProfileId));
            if (!profile) return;

            if (!confirm(`Delete profile "${profile.name}"?`)) return;

            try {
                const response = await fetch(`/terminal/profiles/${this.selectedProfileId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                if (result.success) {
                    this.selectedProfileId = '';
                    window.location.reload();
                } else {
                    alert('Failed to delete profile: ' + result.message);
                }
            } catch (error) {
                console.error('Error deleting profile:', error);
                alert('Error deleting profile');
            }
        },

        destroy() {
            // Clean up all terminals
            for (let i = 0; i < 4; i++) {
                if (this.panes[i].terminal) {
                    this.panes[i].terminal.destroy();
                }
            }
        }
    }
}
</script>
{% endblock %}
