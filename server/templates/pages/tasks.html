{% extends "base.html" %}

{% block title %}Tasks - SvrCtlRS{% endblock %}
{% block nav_tasks %}active{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-4">
    <h1>Tasks</h1>
    <button hx-get="/tasks/new"
            hx-target="#task-form-container"
            hx-swap="innerHTML"
            class="btn btn-primary">
        â• Create Task
    </button>
</div>

<!-- Task Form Container (for create/edit forms) -->
<div id="task-form-container"></div>

<!-- Task List (with smart auto-refresh that preserves editing state) -->
<div id="task-list"
     hx-get="/tasks/list"
     hx-trigger="load, every 10s"
     hx-swap="innerHTML"
     hx-indicator=".htmx-indicator"
     data-editing="false">
    <div class="card">
        <p class="text-secondary">Loading tasks... <span class="htmx-indicator">ğŸ”„</span></p>
    </div>
</div>

<style>
.schedule-display {
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 4px;
    transition: background-color 0.2s;
}

.schedule-display:hover {
    background-color: var(--bg-secondary);
}

.schedule-input {
    font-family: 'Courier New', monospace;
    padding: 4px 8px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    background: var(--bg-primary);
    color: var(--text-primary);
    min-width: 150px;
}
</style>

<script>
// Schedule editing functions
function editSchedule(taskId, currentSchedule) {
    // Mark task list as being edited
    const taskList = document.getElementById('task-list');
    taskList.setAttribute('data-editing', 'true');

    // Hide display, show form
    document.getElementById('schedule-display-' + taskId).style.display = 'none';
    const form = document.getElementById('schedule-form-' + taskId);
    form.style.display = 'inline';

    // Focus input
    const input = document.getElementById('schedule-input-' + taskId);
    input.focus();
    input.select();

    console.log('Started editing task ' + taskId + ' schedule');
}

function cancelScheduleEdit(taskId, originalSchedule) {
    // Small delay to allow form submission if Enter was pressed
    setTimeout(() => {
        const form = document.getElementById('schedule-form-' + taskId);
        if (form && form.style.display !== 'none') {
            // Reset input to original value
            document.getElementById('schedule-input-' + taskId).value = originalSchedule;

            // Hide form, show display
            form.style.display = 'none';
            document.getElementById('schedule-display-' + taskId).style.display = 'inline';

            // Mark task list as no longer being edited
            const taskList = document.getElementById('task-list');
            taskList.setAttribute('data-editing', 'false');

            console.log('Cancelled editing task ' + taskId + ' schedule');
        }
    }, 200);
}

function handleScheduleKeydown(event, taskId) {
    if (event.key === 'Enter') {
        event.preventDefault();
        // Submit the form via HTMX
        const form = document.getElementById('schedule-form-' + taskId);
        htmx.trigger(form, 'submit');

        // Mark as no longer editing after short delay (form submission will replace element)
        setTimeout(() => {
            const taskList = document.getElementById('task-list');
            if (taskList) {
                taskList.setAttribute('data-editing', 'false');
                console.log('Completed editing task ' + taskId + ' schedule');
            }
        }, 500);
    } else if (event.key === 'Escape') {
        event.target.blur(); // Trigger onblur which cancels edit
    }
}

// Prevent refresh from interrupting inline editing - IMPROVED VERSION
document.body.addEventListener('htmx:beforeSwap', function(evt) {
    // Only check for task list swaps
    if (evt.detail.target.id === 'task-list') {
        // Check data-editing attribute (more reliable than checking focus)
        const taskList = evt.detail.target;
        const isEditing = taskList.getAttribute('data-editing') === 'true';

        // Also check if any input is actually focused as backup
        const editingSchedule = document.querySelector('.schedule-input');
        const inputHasFocus = editingSchedule && document.activeElement === editingSchedule;

        if (isEditing || inputHasFocus) {
            // Cancel the swap to preserve editing state
            evt.preventDefault();
            console.log('ğŸ›‘ Prevented auto-refresh during schedule edit');
            return false;
        }
    }
});

// Additional safety: pause polling while any input is focused
document.body.addEventListener('focusin', function(evt) {
    if (evt.target.classList.contains('schedule-input')) {
        const taskList = document.getElementById('task-list');
        htmx.trigger(taskList, 'htmx:abort');
        console.log('â¸ï¸  Paused auto-refresh for schedule editing');
    }
});

// Visibility-based polling: only poll when page is visible
// This saves server resources and battery life on mobile
document.addEventListener('visibilitychange', function() {
    const taskList = document.getElementById('task-list');
    if (!taskList) return;

    if (document.hidden) {
        // Page is hidden - pause polling
        htmx.trigger(taskList, 'htmx:abort');
        console.log('ğŸ‘ï¸ Page hidden - paused auto-refresh');
    } else {
        // Page is visible - resume polling by triggering an immediate refresh
        console.log('ğŸ‘ï¸ Page visible - resuming auto-refresh');
        htmx.trigger(taskList, 'load');
    }
});
</script>
{% endblock %}

