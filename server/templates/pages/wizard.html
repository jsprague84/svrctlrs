{% extends "base.html" %}

{% block title %}Job Wizard - SvrCtlRS{% endblock %}
{% block nav_job_templates %}active{% endblock %}

{% block head %}
<!-- Wizard CSS is now in the main stylesheet (styles-technical.css) -->
{% endblock %}

{% block content %}
<div x-data="jobWizard()" x-init="init()">
    <!-- Header -->
    <div class="flex-between mb-3">
        <div>
            <h1><i data-lucide="wand-2" style="width: 24px; height: 24px;"></i> Job Wizard</h1>
            <p class="text-secondary">Create and schedule a job in a few simple steps</p>
        </div>
        <a href="/job-templates" class="btn btn-secondary">
            <i data-lucide="settings" style="width: 16px; height: 16px;"></i> Advanced Mode
        </a>
    </div>

    <!-- Step Indicators -->
    <div class="wizard-steps">
        <div class="wizard-step" :class="{ active: step === 1, completed: step > 1 }">
            <span class="step-number">
                <template x-if="step > 1"><i data-lucide="check" style="width: 16px; height: 16px;"></i></template>
                <template x-if="step <= 1">1</template>
            </span>
            <span class="step-label">Select Job</span>
        </div>
        <div class="step-connector" :class="{ active: step > 1 }"></div>
        <div class="wizard-step" :class="{ active: step === 2, completed: step > 2 }">
            <span class="step-number">
                <template x-if="step > 2"><i data-lucide="check" style="width: 16px; height: 16px;"></i></template>
                <template x-if="step <= 2">2</template>
            </span>
            <span class="step-label">Configure</span>
        </div>
        <div class="step-connector" :class="{ active: step > 2 }"></div>
        <div class="wizard-step" :class="{ active: step === 3, completed: step > 3 }">
            <span class="step-number">
                <template x-if="step > 3"><i data-lucide="check" style="width: 16px; height: 16px;"></i></template>
                <template x-if="step <= 3">3</template>
            </span>
            <span class="step-label">Server</span>
        </div>
        <div class="step-connector" :class="{ active: step > 3 }"></div>
        <div class="wizard-step" :class="{ active: step === 4, completed: step > 4 }">
            <span class="step-number">
                <template x-if="step > 4"><i data-lucide="check" style="width: 16px; height: 16px;"></i></template>
                <template x-if="step <= 4">4</template>
            </span>
            <span class="step-label">Schedule</span>
        </div>
        <div class="step-connector" :class="{ active: step > 4 }"></div>
        <div class="wizard-step" :class="{ active: step === 5, completed: step > 5 }">
            <span class="step-number">
                <template x-if="step > 5"><i data-lucide="check" style="width: 16px; height: 16px;"></i></template>
                <template x-if="step <= 5">5</template>
            </span>
            <span class="step-label">Review</span>
        </div>
    </div>

    <!-- Step 1: Select Job -->
    <div x-show="step === 1" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 transform translate-x-4" x-transition:enter-end="opacity-100 transform translate-x-0">
        <div class="card">
            <div class="card-header">
                <h3>What would you like to do?</h3>
            </div>
            <div class="card-body">
                <!-- Favorites Section -->
                {% if !favorites.is_empty() %}
                <div class="mb-4">
                    <h4 class="text-secondary mb-2" style="font-size: 0.875rem;">
                        <i data-lucide="star" style="width: 14px; height: 14px;"></i> Favorites
                    </h4>
                    <div class="job-grid">
                        {% for item in favorites %}
                        <div class="job-card"
                             :class="{ selected: selectedJobId === {{ item.id }} }"
                             @click="selectJob({{ item.id }}, '{{ item.display_name }}', '{{ item.icon }}')">
                            <div class="job-card-header">
                                <div class="job-card-icon">
                                    <i data-lucide="{{ item.icon }}"></i>
                                </div>
                                <div class="job-card-content">
                                    <h4>{{ item.display_name }}</h4>
                                    <p>{{ item.description }}</p>
                                </div>
                            </div>
                            <div class="job-card-footer">
                                <span class="badge badge-{{ item.difficulty }}">{{ item.difficulty }}</span>
                                <button class="btn-favorite active"
                                        hx-post="/wizard/toggle-favorite/{{ item.id }}"
                                        hx-swap="outerHTML"
                                        @click.stop
                                        title="Remove from favorites">
                                    <i data-lucide="star"></i>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Filters -->
                <div class="wizard-filters">
                    <input type="text"
                           class="form-control"
                           placeholder="Search jobs..."
                           x-model="searchQuery"
                           @input.debounce.300ms="loadCatalog()">
                    <select class="form-select" x-model="difficultyFilter" @change="loadCatalog()">
                        <option value="all">All Levels</option>
                        <option value="basic">Basic</option>
                        <option value="intermediate">Intermediate</option>
                        <option value="advanced">Advanced</option>
                    </select>
                </div>

                <!-- Category Tabs -->
                <div class="category-tabs">
                    <button class="category-tab"
                            :class="{ active: selectedCategory === 'all' }"
                            @click="selectCategory('all')">
                        All Jobs
                    </button>
                    {% for cat in categories %}
                    <button class="category-tab"
                            :class="{ active: selectedCategory === '{{ cat.name }}' }"
                            @click="selectCategory('{{ cat.name }}')"
                            style="{% if cat.color.len() > 0 %}--cat-color: {{ cat.color }};{% endif %}">
                        <i data-lucide="{{ cat.icon }}"></i>
                        {{ cat.display_name }}
                        <span class="count">{{ cat.item_count }}</span>
                    </button>
                    {% endfor %}
                </div>

                <!-- Catalog Grid (HTMX loaded) -->
                <div id="catalog-grid"
                     hx-get="/wizard/catalog"
                     hx-trigger="load"
                     hx-swap="innerHTML">
                    <div class="empty-state">
                        <i data-lucide="loader" class="spin"></i>
                        <p>Loading jobs...</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="wizard-actions">
            <div></div>
            <button class="btn btn-primary"
                    :disabled="!selectedJobId"
                    @click="nextStep()">
                Next: Configure <i data-lucide="arrow-right" style="width: 16px; height: 16px;"></i>
            </button>
        </div>
    </div>

    <!-- Step 2: Configure Parameters -->
    <div x-show="step === 2" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 transform translate-x-4" x-transition:enter-end="opacity-100 transform translate-x-0">
        <div id="configure-step">
            <!-- Loaded via HTMX when step 2 is shown -->
        </div>

        <div class="wizard-actions">
            <button class="btn btn-secondary" @click="prevStep()">
                <i data-lucide="arrow-left" style="width: 16px; height: 16px;"></i> Back
            </button>
            <button class="btn btn-primary" @click="nextStep()">
                Next: Select Server <i data-lucide="arrow-right" style="width: 16px; height: 16px;"></i>
            </button>
        </div>
    </div>

    <!-- Step 3: Select Server -->
    <div x-show="step === 3" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 transform translate-x-4" x-transition:enter-end="opacity-100 transform translate-x-0">
        <div id="servers-step">
            <!-- Loaded via HTMX when step 3 is shown -->
        </div>

        <div class="wizard-actions">
            <button class="btn btn-secondary" @click="prevStep()">
                <i data-lucide="arrow-left" style="width: 16px; height: 16px;"></i> Back
            </button>
            <button class="btn btn-primary"
                    :disabled="selectedServerIds.length === 0"
                    @click="nextStep()">
                Next: Schedule <i data-lucide="arrow-right" style="width: 16px; height: 16px;"></i>
            </button>
        </div>
    </div>

    <!-- Step 4: Schedule -->
    <div x-show="step === 4" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 transform translate-x-4" x-transition:enter-end="opacity-100 transform translate-x-0">
        <div id="schedule-step">
            <!-- Loaded via HTMX when step 4 is shown -->
        </div>

        <div class="wizard-actions">
            <button class="btn btn-secondary" @click="prevStep()">
                <i data-lucide="arrow-left" style="width: 16px; height: 16px;"></i> Back
            </button>
            <button class="btn btn-primary" @click="nextStep()">
                Next: Review <i data-lucide="arrow-right" style="width: 16px; height: 16px;"></i>
            </button>
        </div>
    </div>

    <!-- Step 5: Review & Create -->
    <div x-show="step === 5" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 transform translate-x-4" x-transition:enter-end="opacity-100 transform translate-x-0">
        <div id="review-step">
            <!-- Loaded via HTMX when step 5 is shown -->
        </div>

        <div class="wizard-actions">
            <button class="btn btn-secondary" @click="prevStep()">
                <i data-lucide="arrow-left" style="width: 16px; height: 16px;"></i> Back
            </button>
            <button class="btn btn-success" @click="createJob()">
                <i data-lucide="check" style="width: 16px; height: 16px;"></i> Create Job
            </button>
        </div>
    </div>

    <!-- Success Modal -->
    <div x-show="showSuccess" x-transition class="modal-backdrop" style="display: none;">
        <div id="success-result">
            <!-- Success content loaded via HTMX -->
        </div>
    </div>
</div>

<script>
function jobWizard() {
    return {
        step: 1,
        selectedJobId: null,
        selectedJobName: '',
        selectedJobIcon: '',
        selectedCategory: 'all',
        searchQuery: '',
        difficultyFilter: 'all',
        // Multi-server selection
        selectedServerIds: [],
        selectedServerNames: {},
        scheduleType: 'now',
        cronExpression: '0 0 * * * *',
        // Cron builder variables
        scheduleFreq: 'daily',
        scheduleTime: '02:00',
        scheduleDow: '0',
        scheduleDom: '1',
        // Notifications
        notifySuccess: false,
        notifyFailure: true,
        channelIds: [],
        availableChannels: [],
        parameters: {},
        showSuccess: false,

        init() {
            // Watch for step changes to load HTMX content
            this.$watch('step', (newStep) => {
                if (newStep === 2 && this.selectedJobId) {
                    htmx.ajax('GET', '/wizard/configure/' + this.selectedJobId, {
                        target: '#configure-step',
                        swap: 'innerHTML'
                    });
                } else if (newStep === 3 && this.selectedJobId) {
                    htmx.ajax('GET', '/wizard/servers/' + this.selectedJobId, {
                        target: '#servers-step',
                        swap: 'innerHTML'
                    });
                } else if (newStep === 4) {
                    htmx.ajax('GET', '/wizard/schedule', {
                        target: '#schedule-step',
                        swap: 'innerHTML'
                    });
                } else if (newStep === 5) {
                    this.loadReview();
                }
            });

            // Initialize cron expression
            this.updateCron();
        },

        selectJob(id, name, icon) {
            this.selectedJobId = id;
            this.selectedJobName = name;
            this.selectedJobIcon = icon;
        },

        selectCategory(category) {
            this.selectedCategory = category;
            this.loadCatalog();
        },

        loadCatalog() {
            let url = '/wizard/catalog';
            const params = new URLSearchParams();

            if (this.selectedCategory !== 'all') {
                params.append('category', this.selectedCategory);
            }
            if (this.searchQuery) {
                params.append('search', this.searchQuery);
            }
            if (this.difficultyFilter !== 'all') {
                params.append('difficulty', this.difficultyFilter);
            }

            if (params.toString()) {
                url += '?' + params.toString();
            }

            htmx.ajax('GET', url, {
                target: '#catalog-grid',
                swap: 'innerHTML'
            });
        },

        // Multi-server selection toggle
        toggleServer(id, name) {
            const idx = this.selectedServerIds.indexOf(id);
            if (idx === -1) {
                this.selectedServerIds.push(id);
                this.selectedServerNames[id] = name;
            } else {
                this.selectedServerIds.splice(idx, 1);
                delete this.selectedServerNames[id];
            }
        },

        isServerSelected(id) {
            return this.selectedServerIds.includes(id);
        },

        // Toggle notification channel selection
        toggleChannel(id) {
            const idx = this.channelIds.indexOf(id);
            if (idx === -1) {
                this.channelIds.push(id);
            } else {
                this.channelIds.splice(idx, 1);
            }
        },

        isChannelSelected(id) {
            return this.channelIds.includes(id);
        },

        // Cron expression builder
        // Note: The cron crate requires 6 fields: sec min hour day month day_of_week
        updateCron() {
            const time = this.scheduleTime || '02:00';
            const [hour, minute] = time.split(':').map(Number);

            switch (this.scheduleFreq) {
                case 'hourly':
                    // Every hour at minute 0
                    this.cronExpression = '0 0 * * * *';
                    break;
                case 'daily':
                    // Daily at specified time
                    this.cronExpression = `0 ${minute} ${hour} * * *`;
                    break;
                case 'weekly':
                    // Weekly on specified day at specified time
                    this.cronExpression = `0 ${minute} ${hour} * * ${this.scheduleDow}`;
                    break;
                case 'monthly':
                    // Monthly on specified day at specified time
                    this.cronExpression = `0 ${minute} ${hour} ${this.scheduleDom} * *`;
                    break;
                case 'custom':
                    // Keep current cronExpression for manual editing
                    break;
            }
        },

        // Validate cron expression (must be 6 fields: sec min hour day month dow)
        validateCron(expr) {
            if (!expr) return { valid: false, error: 'Cron expression is required' };
            const parts = expr.trim().split(/\s+/);
            if (parts.length !== 6) {
                return {
                    valid: false,
                    error: `Cron expression must have 6 fields (sec min hour day month dow), got ${parts.length}`
                };
            }
            return { valid: true };
        },

        nextStep() {
            if (this.step < 5) {
                this.step++;
            }
        },

        prevStep() {
            if (this.step > 1) {
                this.step--;
            }
        },

        collectParameters() {
            // Collect form values from configure step
            const form = document.querySelector('#configure-step form');
            if (form) {
                const formData = new FormData(form);
                const params = {};
                for (const [key, value] of formData.entries()) {
                    if (key.startsWith('param_')) {
                        params[key.replace('param_', '')] = value;
                    }
                }
                this.parameters = params;
            }
        },

        loadReview() {
            this.collectParameters();

            // Use URLSearchParams for proper Content-Type
            const params = new URLSearchParams();
            params.append('catalog_item_id', this.selectedJobId);
            // Send server_ids as JSON array for multi-server support
            params.append('server_ids', JSON.stringify(this.selectedServerIds));
            params.append('server_names', JSON.stringify(this.selectedServerNames));
            params.append('parameters', JSON.stringify(this.parameters));
            params.append('schedule_type', this.scheduleType);
            if (this.cronExpression) {
                params.append('cron_expression', this.cronExpression);
            }
            if (this.notifySuccess) {
                params.append('notify_success', 'true');
            }
            if (this.notifyFailure) {
                params.append('notify_failure', 'true');
            }
            if (this.channelIds.length > 0) {
                params.append('channel_ids', JSON.stringify(this.channelIds));
            }

            fetch('/wizard/review', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: params.toString()
            })
            .then(response => response.text())
            .then(html => {
                document.getElementById('review-step').innerHTML = html;
                lucide.createIcons({ nameAttr: 'data-lucide', el: document.getElementById('review-step') });
            })
            .catch(error => {
                console.error('Review load error:', error);
                document.getElementById('review-step').innerHTML = '<div class="alert alert-danger">Failed to load review. Please try again.</div>';
            });
        },

        createJob() {
            this.collectParameters();

            // Use URLSearchParams for proper Content-Type
            const params = new URLSearchParams();
            params.append('catalog_item_id', this.selectedJobId);
            params.append('server_ids', JSON.stringify(this.selectedServerIds));
            params.append('parameters', JSON.stringify(this.parameters));
            params.append('schedule_type', this.scheduleType);
            if (this.cronExpression) {
                params.append('cron_expression', this.cronExpression);
            }
            if (this.notifySuccess) {
                params.append('notify_success', 'true');
            }
            if (this.notifyFailure) {
                params.append('notify_failure', 'true');
            }
            if (this.channelIds.length > 0) {
                params.append('channel_ids', JSON.stringify(this.channelIds));
            }

            fetch('/wizard/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: params.toString()
            })
            .then(response => response.text())
            .then(html => {
                document.getElementById('success-result').innerHTML = html;
                lucide.createIcons({ nameAttr: 'data-lucide', el: document.getElementById('success-result') });
                this.showSuccess = true;
            })
            .catch(error => {
                console.error('Create job error:', error);
                alert('Failed to create job. Please try again.');
            });
        }
    };
}
</script>
{% endblock %}
