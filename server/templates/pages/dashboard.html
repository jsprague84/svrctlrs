{% extends "base.html" %}

{% block title %}Dashboard - SvrCtlRS{% endblock %}
{% block nav_dashboard %}active{% endblock %}

{% block content %}
<h1>Dashboard</h1>

<!-- Stats Grid -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value">{{ stats.total_servers }}</div>
        <div class="stat-label">Servers</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-value">{{ stats.active_tasks }}</div>
        <div class="stat-label">Active Schedules</div>
    </div>

    <div class="stat-card">
        <div class="stat-value">{{ stats.active_jobs }}</div>
        <div class="stat-label">Running Jobs</div>
    </div>

    <div class="stat-card">
        <div class="stat-value">{{ stats.total_schedules }}</div>
        <div class="stat-label">Total Schedules</div>
    </div>
</div>

<!-- Quick Actions -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Quick Actions</h2>
        <a href="/wizard" class="btn btn-sm btn-primary">
            <i data-lucide="wand-2" style="width: 14px; height: 14px;"></i> New Job
        </a>
    </div>

    <!-- Favorite Jobs for Quick Run -->
    {% if !stats.favorite_jobs.is_empty() %}
    <div class="mb-3">
        <h4 class="text-secondary mb-2" style="font-size: 0.75rem; text-transform: uppercase;">
            <i data-lucide="star" style="width: 12px; height: 12px; color: var(--warning-color);"></i>
            Favorite Jobs
        </h4>
        <div class="flex gap-2 flex-wrap">
            {% for job in stats.favorite_jobs %}
            <a href="/wizard/configure/{{ job.id }}" class="btn btn-secondary" style="display: inline-flex; align-items: center; gap: 0.5rem;">
                <i data-lucide="{{ job.icon }}" style="width: 16px; height: 16px;"></i>
                {{ job.display_name }}
            </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Navigation Links -->
    <div class="flex gap-2 flex-wrap">
        <a href="/wizard" class="btn btn-primary">
            <i data-lucide="wand-2" style="width: 16px; height: 16px;"></i> Job Wizard
        </a>
        <a href="/servers" class="btn btn-secondary">
            <i data-lucide="server" style="width: 16px; height: 16px;"></i> Servers
        </a>
        <a href="/job-templates" class="btn btn-secondary">
            <i data-lucide="file-text" style="width: 16px; height: 16px;"></i> Templates
        </a>
        <a href="/job-schedules" class="btn btn-secondary">
            <i data-lucide="calendar-clock" style="width: 16px; height: 16px;"></i> Schedules
        </a>
        <a href="/job-runs" class="btn btn-secondary">
            <i data-lucide="activity" style="width: 16px; height: 16px;"></i> History
        </a>
    </div>
</div>

<!-- Job Schedules with Last Run -->
<div class="card" style="padding: 0; overflow: hidden;">
    <div class="card-header" style="padding: 1rem;">
        <h2 class="card-title">Job Schedules</h2>
        <a href="/job-runs" class="btn btn-sm btn-secondary">View All Runs</a>
    </div>

    {% if stats.schedules_with_runs.is_empty() %}
    <p class="text-secondary" style="padding: 1rem;">No job schedules configured. Create schedules to automate job execution.</p>
    {% else %}
    <table class="table" style="margin: 0;">
        <thead>
            <tr>
                <th>Schedule</th>
                <th>Server</th>
                <th>Cron</th>
                <th>Next Run</th>
                <th>Last Run</th>
                <th>Status</th>
                <th style="text-align: center;">Runs</th>
            </tr>
        </thead>
        <tbody>
            {% for sched in stats.schedules_with_runs %}
            <tr style="cursor: pointer;" onclick="window.location.href='/job-runs?schedule_id={{ sched.schedule_id }}'">
                <td>
                    <strong>{{ sched.schedule_name }}</strong>
                    <span class="text-secondary" style="font-size: 0.75rem; display: block;">{{ sched.job_template_name }}</span>
                </td>
                <td style="font-size: 0.875rem;">{{ sched.server_name }}</td>
                <td style="font-size: 0.75rem; font-family: monospace;">{{ sched.cron_expression }}</td>
                <td style="font-size: 0.875rem;">
                    {% match sched.next_run_at %}
                    {% when Some with (dt) %}{{ dt }}{% when None %}<span class="text-secondary">-</span>{% endmatch %}
                </td>
                <td style="font-size: 0.875rem;">
                    {% match sched.last_run_started_at %}
                    {% when Some with (dt) %}
                        {{ dt }}
                        {% match sched.last_run_duration %}
                        {% when Some with (d) %}<span class="text-secondary"> ({{ d }})</span>{% when None %}{% endmatch %}
                    {% when None %}<span class="text-secondary">Never</span>{% endmatch %}
                </td>
                <td>
                    {% match sched.last_run_status %}
                    {% when Some with (status) %}
                    <span class="badge {% if status == "success" %}badge-success{% elif status == "failed" %}badge-error{% elif status == "partial_success" %}badge-warning{% elif status == "running" %}badge-info{% else %}badge-secondary{% endif %}">
                        {% if status == "success" %}OK{% elif status == "failed" %}Fail{% elif status == "running" %}Run{% else %}{{ status }}{% endif %}
                    </span>
                    {% when None %}
                    <span class="badge badge-secondary">-</span>
                    {% endmatch %}
                </td>
                <td style="text-align: center; font-size: 0.875rem;">
                    <span class="text-success">{{ sched.success_count }}</span>/<span class="text-error">{{ sched.failure_count }}</span>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}
</div>
{% endblock %}

