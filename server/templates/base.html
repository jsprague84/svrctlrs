<!DOCTYPE html>
<html lang="en"
      x-data="{ sidebarOpen: false, theme: localStorage.getItem('theme') || 'tokyo' }"
      x-init="$watch('theme', val => { localStorage.setItem('theme', val); if (window.updateFavicon) window.updateFavicon(val); })"
      :data-theme="theme">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}SvrCtlRS{% endblock %}</title>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/static/img/favicon.svg">

    <!-- Prevent FOUC (Flash of Unstyled Content) - Set theme immediately -->
    <script>
        // Set theme on html element before page renders
        const theme = localStorage.getItem('theme') || 'tokyo';
        document.documentElement.setAttribute('data-theme', theme);

        // Set theme-specific favicon
        window.updateFavicon = function(theme) {
            const faviconPath = theme === 'tokyo'
                ? '/static/img/branding/tokyo/favicon/favicon.svg'
                : '/static/img/branding/nord/favicon/favicon.svg';

            let link = document.querySelector("link[rel='icon']");
            if (!link) {
                link = document.createElement('link');
                link.rel = 'icon';
                link.type = 'image/svg+xml';
                document.head.appendChild(link);
            }
            link.href = faviconPath;
        };

        // Set initial favicon
        window.updateFavicon(theme);

        // Watch for theme changes
        window.addEventListener('storage', function(e) {
            if (e.key === 'theme') {
                updateFavicon(e.newValue);
            }
        });
    </script>
    
    <!-- Styles - Technical/Dense Theme (Professional) -->
    <!-- To revert to friendly theme: change to /static/css/styles.css -->
    <link rel="stylesheet" href="/static/css/styles-technical.css">

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Alpine.js for client-side interactivity -->
    <script defer src="/static/js/alpine.min.js"></script>

    <!-- HTMX -->
    <script defer src="/static/js/htmx.min.js"></script>

    <!-- xterm.js for terminal emulation -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-search@0.13.0/lib/xterm-addon-search.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-web-links@0.9.0/lib/xterm-addon-web-links.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-serialize@0.11.0/lib/xterm-addon-serialize.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-unicode11@0.6.0/lib/xterm-addon-unicode11.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-clipboard@0.1.0/lib/addon-clipboard.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-image@0.8.0/lib/addon-image.js"></script>

    <!-- Terminal Manager (must load before Alpine.js) -->
    <script src="/static/js/terminal.js"></script>

    <!-- Initialize Lucide icons after DOM loads -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();

            // Re-initialize icons after HTMX swaps (scoped to swapped element for performance)
            document.body.addEventListener('htmx:afterSwap', function(event) {
                // Only process icons in the swapped element, not the entire document
                lucide.createIcons({ nameAttr: 'data-lucide', el: event.detail.target });
            });

            // Global HTMX error handling
            document.body.addEventListener('htmx:responseError', function(evt) {
                console.error('HTMX response error:', evt.detail);
                showToast('error', 'Server error. Please try again or contact support.');
            });

            document.body.addEventListener('htmx:sendError', function(evt) {
                console.error('HTMX network error:', evt.detail);
                showToast('error', 'Network error. Please check your connection.');
            });

            document.body.addEventListener('htmx:timeout', function(evt) {
                console.error('HTMX timeout:', evt.detail);
                showToast('error', 'Request timed out. Please try again.');
            });

            // Auto-dismiss alerts with 'alert-auto-dismiss' class
            document.body.addEventListener('htmx:afterSwap', function(evt) {
                const alerts = evt.detail.target.querySelectorAll('.alert-auto-dismiss');
                alerts.forEach(function(alert) {
                    // Store the parent container and target info for refresh
                    const targetId = alert.dataset.refreshTarget;
                    const refreshUrl = alert.dataset.refreshUrl;

                    setTimeout(function() {
                        // Fade out the alert
                        alert.style.transition = 'opacity 0.3s ease-out';
                        alert.style.opacity = '0';

                        setTimeout(function() {
                            // Remove the alert
                            alert.remove();

                            // Refresh the target if specified
                            if (targetId && refreshUrl) {
                                htmx.ajax('GET', refreshUrl, {
                                    target: '#' + targetId,
                                    swap: 'innerHTML'
                                });
                            }
                        }, 300);
                    }, 3000);
                });
            });

            // Auto-close forms on successful save
            document.body.addEventListener('htmx:afterSwap', function(evt) {
                // Check if the swapped content contains a success message
                const successAlert = evt.detail.target.querySelector('.alert-success');
                if (successAlert) {
                    // Find form containers to clear
                    const formContainers = [
                        'server-form-container',
                        'credential-form-container',
                        'tag-form-container',
                        'job-template-form-container',
                        'job-type-form-container',
                        'command-template-form-container',
                        'schedule-form-container',
                        'notification-channel-form-container',
                        'notification-policy-form-container'
                    ];

                    formContainers.forEach(function(containerId) {
                        const container = document.getElementById(containerId);
                        if (container && container.querySelector('form')) {
                            // Clear the form after a short delay
                            setTimeout(function() {
                                container.innerHTML = '';
                            }, 1500);
                        }
                    });
                }
            });
        });

        // Toast notification system
        function showToast(type, message) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `alert alert-${type}`;
            toast.style.cssText = 'margin-bottom: 10px; animation: slideIn 0.3s ease-out;';
            toast.textContent = message;

            container.appendChild(toast);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }
    </script>

    <style>
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* HTMX loading indicator */
        .htmx-indicator {
            display: none;
        }
        .htmx-request .htmx-indicator {
            display: inline-block;
        }
        .htmx-request.htmx-indicator {
            display: inline-block;
        }
    </style>

    {% block head %}{% endblock %}
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header" role="banner">
            <!-- Mobile menu button -->
            <button @click="sidebarOpen = !sidebarOpen"
                    class="mobile-menu-btn"
                    :aria-label="sidebarOpen ? 'Close menu' : 'Open menu'"
                    :aria-expanded="sidebarOpen">
                <i data-lucide="menu" style="width: 20px; height: 20px;"></i>
            </button>

            <a href="/" class="header-title" aria-label="SvrCtlRS Home" style="display: flex; align-items: center; gap: 12px; text-decoration: none;">
                <!-- Theme-specific header image -->
                <img :src="theme === 'tokyo' ? '/static/img/branding/tokyo/header.svg' : '/static/img/branding/nord/header.svg'"
                     alt="SvrCtlRS"
                     style="height: 40px; width: auto;"
                     x-transition>
            </a>

            <div class="header-spacer"></div>

            <!-- Theme toggle: Tokyo Night → Nord Dark → Light → Tokyo -->
            <button @click="theme = theme === 'tokyo' ? 'dark' : (theme === 'dark' ? 'light' : 'tokyo')"
                    class="btn btn-secondary"
                    :aria-label="'Switch theme. Current: ' + (theme === 'tokyo' ? 'Tokyo Night' : (theme === 'dark' ? 'Nord Dark' : 'Light'))"
                    :title="'Theme: ' + (theme === 'tokyo' ? 'Tokyo Night' : (theme === 'dark' ? 'Nord Dark' : 'Light'))">
                <span x-show="theme === 'tokyo'"><i data-lucide="moon-star" style="width: 16px; height: 16px;" aria-hidden="true"></i></span>
                <span x-show="theme === 'dark'"><i data-lucide="moon" style="width: 16px; height: 16px;" aria-hidden="true"></i></span>
                <span x-show="theme === 'light'"><i data-lucide="sun" style="width: 16px; height: 16px;" aria-hidden="true"></i></span>
            </button>
            
            {% match user %}
            {% when Some with (u) %}
            <span class="text-secondary" aria-label="Current user">{{ u.username }}</span>
            <form action="/auth/logout" method="post" style="display: inline;">
                <button type="submit" class="btn btn-secondary" aria-label="Logout from SvrCtlRS">Logout</button>
            </form>
            {% when None %}
            <a href="/auth/login" class="btn btn-primary" aria-label="Login to SvrCtlRS">Login</a>
            {% endmatch %}
        </header>
        
        <div class="main-layout">
            <!-- Mobile backdrop -->
            <div class="sidebar-backdrop"
                 x-show="sidebarOpen"
                 @click="sidebarOpen = false"
                 x-transition:enter="transition ease-out duration-200"
                 x-transition:enter-start="opacity-0"
                 x-transition:enter-end="opacity-100"
                 x-transition:leave="transition ease-in duration-150"
                 x-transition:leave-start="opacity-100"
                 x-transition:leave-end="opacity-0"
                 aria-hidden="true"></div>

            <!-- Sidebar -->
            <aside class="sidebar" :class="{ 'open': sidebarOpen }" role="navigation" aria-label="Main navigation">
                <nav>
                    <a href="/" class="nav-link {% block nav_dashboard %}{% endblock %}" aria-label="Dashboard">
                        <i data-lucide="layout-dashboard" style="width: 16px; height: 16px;" aria-hidden="true"></i> Dashboard
                    </a>

                    <!-- Infrastructure -->
                    <div class="nav-section" role="heading" aria-level="2">Infrastructure</div>
                    <a href="/servers" class="nav-link {% block nav_servers %}{% endblock %}" aria-label="Servers">
                        <i data-lucide="server" style="width: 16px; height: 16px;" aria-hidden="true"></i> Servers
                    </a>
                    <a href="/credentials" class="nav-link {% block nav_credentials %}{% endblock %}" aria-label="Credentials">
                        <i data-lucide="key" style="width: 16px; height: 16px;" aria-hidden="true"></i> Credentials
                    </a>
                    <a href="/tags" class="nav-link {% block nav_tags %}{% endblock %}" aria-label="Tags">
                        <i data-lucide="tag" style="width: 16px; height: 16px;" aria-hidden="true"></i> Tags
                    </a>

                    <!-- Jobs -->
                    <div class="nav-section" role="heading" aria-level="2">Jobs</div>
                    <a href="/job-types" class="nav-link {% block nav_job_types %}{% endblock %}" aria-label="Job Types">
                        <i data-lucide="boxes" style="width: 16px; height: 16px;" aria-hidden="true"></i> Job Types
                    </a>
                    <a href="/job-templates" class="nav-link {% block nav_job_templates %}{% endblock %}" aria-label="Job Templates">
                        <i data-lucide="file-text" style="width: 16px; height: 16px;" aria-hidden="true"></i> Job Templates
                    </a>
                    <a href="/job-schedules" class="nav-link {% block nav_schedules %}{% endblock %}" aria-label="Schedules">
                        <i data-lucide="clock" style="width: 16px; height: 16px;" aria-hidden="true"></i> Schedules
                    </a>
                    <a href="/job-runs" class="nav-link {% block nav_runs %}{% endblock %}" aria-label="Job Runs">
                        <i data-lucide="play-circle" style="width: 16px; height: 16px;" aria-hidden="true"></i> Job Runs
                    </a>

                    <!-- Notifications -->
                    <div class="nav-section" role="heading" aria-level="2">Notifications</div>
                    <a href="/settings/notifications/channels" class="nav-link {% block nav_channels %}{% endblock %}" aria-label="Notification Channels">
                        <i data-lucide="bell" style="width: 16px; height: 16px;" aria-hidden="true"></i> Channels
                    </a>
                    <a href="/settings/notifications/policies" class="nav-link {% block nav_policies %}{% endblock %}" aria-label="Notification Policies">
                        <i data-lucide="filter" style="width: 16px; height: 16px;" aria-hidden="true"></i> Policies
                    </a>
                    <a href="/settings/notifications/log" class="nav-link {% block nav_notification_log %}{% endblock %}" aria-label="Notification Log">
                        <i data-lucide="list" style="width: 16px; height: 16px;" aria-hidden="true"></i> Log
                    </a>

                    <!-- Tools -->
                    <div class="nav-section" role="heading" aria-level="2">Tools</div>
                    <a href="/terminal" class="nav-link {% block nav_terminal %}{% endblock %}" aria-label="Terminal">
                        <i data-lucide="terminal" style="width: 16px; height: 16px;" aria-hidden="true"></i> Terminal
                    </a>

                    <!-- System -->
                    <div class="nav-section" role="heading" aria-level="2">System</div>
                    <a href="/settings" class="nav-link {% block nav_settings %}{% endblock %}" aria-label="Settings">
                        <i data-lucide="settings" style="width: 16px; height: 16px;" aria-hidden="true"></i> Settings
                    </a>
                </nav>
            </aside>

            <!-- Main content -->
            <main class="main-content" role="main">
                {% block content %}{% endblock %}
            </main>
        </div>
    </div>
    
    <!-- Terminal Modal (Global) -->
    {% include "components/terminal_modal.html" %}

    <!-- Toast notifications container -->
    <div id="toast-container" style="position: fixed; top: 80px; right: 20px; z-index: 1000;">
        <!-- Toasts will be injected here via HTMX -->
    </div>
</body>
</html>

