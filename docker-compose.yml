services:
  svrctlrs:
    image: ghcr.io/${GITHUB_REPOSITORY:-jsprague84/svrctlrs}:${TAG:-latest}
    container_name: svrctlrs
    restart: ${RESTART_POLICY:-unless-stopped}
    user: "1000:1000"  # Run as user 1000 (matches svrctlrs user in container)
    ports:
      - "${HTTP_PORT:-8080}:8080"
    environment:
      # Logging
      - RUST_LOG=${RUST_LOG:-info}
      
      # Database
      - DATABASE_URL=${DATABASE_URL:-sqlite:/app/data/svrctlrs.db}
      
      # Plugin Configuration
      - ENABLE_DOCKER_PLUGIN=${ENABLE_DOCKER_PLUGIN:-true}
      - ENABLE_UPDATES_PLUGIN=${ENABLE_UPDATES_PLUGIN:-true}
      - ENABLE_HEALTH_PLUGIN=${ENABLE_HEALTH_PLUGIN:-true}
      - ENABLE_WEATHER_PLUGIN=${ENABLE_WEATHER_PLUGIN:-false}
      - ENABLE_SPEEDTEST_PLUGIN=${ENABLE_SPEEDTEST_PLUGIN:-false}
      
      # Optional: Notifications
      - GOTIFY_URL=${GOTIFY_URL:-}
      - GOTIFY_TOKEN=${GOTIFY_TOKEN:-}
      - NTFY_URL=${NTFY_URL:-}
      - NTFY_TOPIC=${NTFY_TOPIC:-}
      
      # Optional: Weather plugin configuration
      - WEATHER_API_KEY=${WEATHER_API_KEY:-}
      - WEATHER_LOCATION=${WEATHER_LOCATION:-}
    volumes:
      # Persist database and application data
      - svrctlrs-data:/app/data
      
      # Mount config file (create from config/example.toml)
      - ./config.toml:/app/config.toml:ro
      
      # Mount SSH keys for remote server management
      # Note: SSH_KEY_PATH must be a DIRECTORY (e.g., ~/.ssh), not a single key file
      # The container will automatically try id_ed25519, id_rsa, id_ecdsa, id_dsa
      - ${SSH_KEY_PATH:-~/.ssh}:/home/svrctlrs/.ssh:ro
    healthcheck:
      test: ["CMD", "/app/svrctl", "health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    # Optional: Resource limits
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '2'
    #       memory: 1G
    #     reservations:
    #       cpus: '0.5'
    #       memory: 256M

volumes:
  svrctlrs-data:
    driver: local
